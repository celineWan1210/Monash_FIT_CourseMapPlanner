#-------------------------README----------------------------------
This file contains a total of three languages, HTML, JavaScript and Python
Total: 
7 files in data (https://drive.google.com/drive/folders/1YCAhrsptvDEHP-pCSztjsj1Ofhuk25ZG)
5 files in static
14 python files

Full Code is also available at google drive link below:
https://drive.google.com/drive/folders/1rkHm8d3Pmrf0mokTtoPPsqKUYSyqggVD 
#----------------------static/main.html--------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monash FIT Smart Unit Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }
        }

        .container {
            max-width: 1200px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        header h1 {
            font-size: 3.5em;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
        }

        header p {
            font-size: 1.2em;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.3px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }

        .menu-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 24px;
            padding: 36px 28px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1;
        }

        .menu-card:hover::before {
            opacity: 1;
        }

        .menu-card:hover {
            transform: translateY(-8px);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.35);
        }

        .menu-card:active {
            transform: translateY(-4px);
        }

        .menu-card-content {
            position: relative;
            z-index: 2;
        }

        .menu-icon {
            font-size: 3.5em;
            margin-bottom: 18px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            animation: floatIcon 3s ease-in-out infinite;
        }

        .menu-card:nth-child(1) .menu-icon {
            animation-delay: 0s;
        }

        .menu-card:nth-child(2) .menu-icon {
            animation-delay: 0.5s;
        }

        .menu-card:nth-child(3) .menu-icon {
            animation-delay: 1s;
        }

        .menu-card:nth-child(4) .menu-icon {
            animation-delay: 1.5s;
        }

        .menu-card:nth-child(5) .menu-icon {
            animation-delay: 2s;
        }

        @keyframes floatIcon {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .menu-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
            color: white;
            letter-spacing: -0.3px;
        }

        .menu-description {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.5;
            font-weight: 400;
        }

        .badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: linear-gradient(135deg, #ffd93d 0%, #ff9a3c 100%);
            color: #1a1a1a;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 600;
            z-index: 3;
            box-shadow: 0 4px 12px rgba(255, 154, 60, 0.3);
            letter-spacing: 0.3px;
        }

        footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 50px;
            font-size: 0.9em;
            animation: fadeIn 1s ease 0.6s both;
        }

        .chat-button {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .chat-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
        }

        .chat-button:active {
            transform: scale(1.05);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes ripple {
            from {
                opacity: 0.6;
                transform: scale(0);
            }

            to {
                opacity: 0;
                transform: scale(2.5);
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5em;
            }

            header p {
                font-size: 1.05em;
            }

            .menu-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .menu-card {
                padding: 32px 24px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üéì Monash FIT Smart Unit Planner</h1>
            <p>Your complete course planning companion</p>
        </header>

        <div class="menu-grid">
            <div class="menu-card" onclick="navigate('plan')">
                <span class="badge">Start Here</span>
                <div class="menu-card-content">
                    <span class="menu-icon">üìö</span>
                    <h2 class="menu-title">Plan My Unit</h2>
                    <p class="menu-description">
                        Build your semester plan with smart recommendations and prerequisite checking
                    </p>
                </div>
            </div>

            <div class="menu-card" onclick="navigate('results')">
                <div class="menu-card-content">
                    <span class="menu-icon">üìä</span>
                    <h2 class="menu-title">View Overall Units</h2>
                    <p class="menu-description">
                        View current plan and update result
                    </p>
                </div>
            </div>

            <div class="menu-card" onclick="navigate('view')">
                <div class="menu-card-content">
                    <span class="menu-icon">üìã</span>
                    <h2 class="menu-title">Download Current Planner</h2>
                    <p class="menu-description">
                        Save your planner as PNG image
                    </p>
                </div>
            </div>

            <div class="menu-card" onclick="navigate('update')">
                <div class="menu-card-content">
                    <span class="menu-icon">üîÑ</span>
                    <h2 class="menu-title">Update Units</h2>
                    <p class="menu-description">
                        Manage unit information and keep course data up to date
                    </p>
                </div>
            </div>

            <div class="menu-card" onclick="navigate('forum')">
                <div class="menu-card-content">
                    <span class="menu-icon">üí¨</span>
                    <h2 class="menu-title">Unit Forum</h2>
                    <p class="menu-description">
                        Connect, share, and learn with your peers
                    </p>
                </div>
            </div>
        </div>

        <footer>
            <p>¬© 2025 Monash FIT Smart Unit Planner</p>
        </footer>
    </div>

    <div class="chat-button" onclick="window.open('/chat', 'AI Chat', 'width=400,height=700')">
        <svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:white">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
        </svg>
    </div>

    <script>
        function navigate(section) {
            const routes = {
                'plan': '/plan',
                'view': '/view',
                'results': '/results',
                'update': '/update',
                'forum': '/forum'
            };
            window.location.href = routes[section];
        }

        document.querySelectorAll('.menu-card').forEach(card => {
            card.addEventListener('click', function (e) {
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.4);
                    width: 100px;
                    height: 100px;
                    margin-left: -50px;
                    margin-top: -50px;
                    animation: ripple 0.6s cubic-bezier(0.16, 1, 0.3, 1);
                    pointer-events: none;
                `;
                ripple.style.left = e.clientX - card.getBoundingClientRect().left + 'px';
                ripple.style.top = e.clientY - card.getBoundingClientRect().top + 'px';
                card.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });
        });
    </script>
</body>

</html>

#----------------------------static/index.html-----------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monash FIT Smart Unit Planner </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }


        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.6s ease;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .unit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .unit-toggle-btn {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 0.75em;
            cursor: pointer;
        }

        .unit-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .unit-card:hover:not(.unavailable) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .unit-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .unit-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .unit-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .unit-code {
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .unit-name {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .unit-description {
            font-size: 0.85em;
            line-height: 1.4;
            opacity: 0.7;
        }

        .menu-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .current-plan {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .plan-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .back-btn {
            background: #6c757d;
            margin-bottom: 20px;
            width: auto;
            padding: 10px 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            transition: color 0.2s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        .level-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .level-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .level-btn.active {
            background: #667eea;
            color: white;
        }

        css.unit-card.prereq-not-met {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%) !important;
            border: 2px solid #c62828 !important;
            color: #c62828;
        }

        .unit-card.prereq-not-met .unit-code {
            color: #c62828;
        }


        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="back-btn" onclick="goBackMain()">‚Üê Back to Main Menu</button>
        <header>
            <h1>üéì Monash FIT Smart Unit Planner</h1>
            <p>Take control of your Monash CS pathway ‚Äî from first line of code to graduation.</p>
        </header>

        <div id="userInfoSection" class="card">
            <h2 style="margin-bottom: 25px; color: #667eea;">Welcome! Let's Get Started</h2>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>

            <div class="form-group">
                <label for="intake">Intake Semester</label>
                <select id="intake">
                    <option value="">Select intake...</option>
                    <option value="1">February Semester</option>
                    <option value="2">July Semester</option>
                </select>
            </div>

            <div class="form-group">
                <label for="stream">Current Stream</label>
                <select id="stream">
                    <option value="">Select stream...</option>
                    <option value="1">Data Science</option>
                    <option value="2">Algorithms and Software</option>
                </select>
            </div>

            <div class="form-group">
                <label for="year">Year to Plan</label>
                <select id="year">
                    <option value="">Select year...</option>
                    <option value="1">Year 1</option>
                    <option value="2">Year 2</option>
                    <option value="3">Year 3</option>
                </select>
            </div>

            <div class="form-group">
                <label for="semester">Semester to Plan</label>
                <select id="semester">
                    <option value="">Select semester...</option>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                </select>
            </div>

            <button class="btn" onclick="startPlanning()">Start Planning</button>
        </div>

        <div id="planningSection" class="card hidden">
            <button class="btn back-btn" onclick="goBack()">‚Üê Back</button>

            <div id="alertContainer"></div>

            <div id="semesterReminder" class="alert alert-info" style="display: none;">
                <strong>üìÖ Semester Reminder:</strong> <span id="semesterReminderText"></span>
            </div>

            <h2 style="color: #667eea; margin-bottom: 20px;">Plan Your Units</h2>

            <div class="menu-options">
                <button class="menu-btn" onclick="showCoreUnits()">üìö View Core Units</button>
                <button class="menu-btn" onclick="showElectives()">‚ú® Choose Electives</button>
                <button class="menu-btn" onclick="showRecommendationModal()">üéØ Get Recommendations</button>
                <button class="menu-btn" onclick="viewCurrentPlan()">üìã View Plan</button>
                <button class="menu-btn" onclick="savePlan()">üíæ Save Plan</button>
            </div>

            <div id="coreUnitsDisplay" class="hidden">
                <h3 style="margin-top: 30px;">Core Units</h3>
                <div id="coreUnitsGrid" class="unit-grid"></div>
            </div>

            <div id="electivesDisplay" class="hidden">
                <h3 style="margin-top: 30px;">Available Electives</h3>
                <div class="level-selector">
                    <button class="level-btn" onclick="filterElectivesByLevel(1)">Level 1</button>
                    <button class="level-btn" onclick="filterElectivesByLevel(2)">Level 2</button>
                    <button class="level-btn" onclick="filterElectivesByLevel(3)">Level 3</button>
                    <button class="level-btn active" onclick="filterElectivesByLevel(0)">All</button>
                </div>
                <p id="electiveCounter"></p>
                <div id="electivesGrid" class="unit-grid"></div>
            </div>

            <div id="currentPlanDisplay" class="current-plan hidden">
                <h3>Your Current Plan</h3>
                <div id="planList"></div>
            </div>
        </div>
    </div>

    <div id="recommendModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 style="margin-bottom: 20px;">Get Smart Recommendations</h2>
            <div class="form-group">
                <label>Level</label>
                <select id="recommendLevel">
                    <option value="1">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                </select>
            </div>
            <div class="form-group">
                <label>Your Interest/Goals</label>
                <input type="text" id="userInterest" placeholder="e.g., machine learning, web development">
            </div>
            <button class="btn" onclick="getRecommendations()">Get Recommendations</button>
            <button class="btn back-btn" onclick="closeModal()">Cancel</button>
            <div id="recommendResults"></div>
        </div>
    </div>

    <div id="unitModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeUnitModal()">&times;</button>
            <h2 id="modalUnitCode"></h2>
            <h3 id="modalUnitName"></h3>
            <p id="modalUnitDesc"></p>
            <p><strong>Semesters:</strong> <span id="modalUnitSem"></span></p>
            <p><strong>Prerequisites:</strong> <span id="modalUnitPrereq"></span></p>
            <p><strong>Assignments:</strong> <span id="modalUnitAssign"></span></p>
            <p><strong>Tests:</strong> <span id="modalUnitTest"></span></p>
            <p><strong>Final:</strong> <span id="modalUnitFinal"></span></p>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let userData = {};
        let coreUnits = [];
        let allElectives = [];
        let selectedElectives = [];
        let electiveSpace = 0;
        let selectedCores = [];
        let deferredCores = [];
        let maxCoreUnits = 0;
        let currentLevel = 0;

        function goBackMain() {
            window.location.href = window.location.origin + '/';
        }


        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return '';
        }

        // Auto-fill user info when the page loads
        function autoFillPlannerFromCookies() {
            const username = getCookie('username');
            const intake = getCookie('intake');
            const stream = getCookie('stream');
            const year = getCookie('year');
            const semester = getCookie('semester');

            if (username) document.getElementById('username').value = username;
            if (intake) document.getElementById('intake').value = intake;
            if (stream) document.getElementById('stream').value = stream;
            if (year) document.getElementById('year').value = year;
            if (semester) document.getElementById('semester').value = semester;

            if (username || intake || stream || year || semester) {
                console.log('‚úÖ User info restored from previous session');
            }
        }

        async function startPlanning() {
            /*
            Handles user input validation and initializes planning by sending data to backend.
            On success, switches to the planning section and loads electives.
            */

            const username = document.getElementById('username').value.trim();
            const intake = document.getElementById('intake').value.trim();
            const stream = document.getElementById('stream').value.trim();
            const year = document.getElementById('year').value.trim();
            const semester = document.getElementById('semester').value.trim();

            if (!username || !intake || !stream || !year || !semester) {
                showAlert('Please fill in all fields', 'warning');
                return;
            }

            userData = { username, intake, stream, year, semester };

            try {
                const res = await fetch(`${API_URL}/api/start-planning`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await res.json();

                if (!data.success) {
                    showAlert(data.error || 'Failed to start planning', 'error');
                    return;
                }

                // Save all fields in cookies (valid for 30 days)
                const maxAge = 30 * 24 * 60 * 60;
                document.cookie = `username=${encodeURIComponent(username)}; path=/; max-age=${maxAge}`;
                document.cookie = `intake=${encodeURIComponent(intake)}; path=/; max-age=${maxAge}`;
                document.cookie = `stream=${encodeURIComponent(stream)}; path=/; max-age=${maxAge}`;
                document.cookie = `year=${encodeURIComponent(year)}; path=/; max-age=${maxAge}`;
                document.cookie = `semester=${encodeURIComponent(semester)}; path=/; max-age=${maxAge}`;

                // Switch to planning section
                document.getElementById('userInfoSection').classList.add('hidden');
                document.getElementById('planningSection').classList.remove('hidden');

                // Show semester info
                if (data.semester_name) {
                    const reminderDiv = document.getElementById('semesterReminder');
                    const reminderText = document.getElementById('semesterReminderText');
                    reminderText.textContent = `You are planning for the ${data.semester_name} (Year ${year}, Semester ${semester})`;
                    reminderDiv.style.display = 'block';
                }

                // Show warnings if any
                if (data.deferred_cores && data.deferred_cores.length > 0) {
                    const deferredList = data.deferred_cores.map(d => `${d.code} (from ${d.from_semester})`).join(', ');
                    showAlert(`‚ö†Ô∏è Warning: You have swapped core units: ${deferredList}`, 'warning');
                }

                showAlert(`Welcome, ${username}! Planning started successfully.`, 'success');

                coreUnits = data.core_units;
                maxCoreUnits = coreUnits.length;
                selectedCores = coreUnits.map(u => u.code);

                await loadElectives(userData);

            } catch (err) {
                showAlert('Error starting planning.', 'error');
                console.error(err);
            }
        }

        function goBack() {
            document.getElementById('planningSection').classList.add('hidden');
            document.getElementById('userInfoSection').classList.remove('hidden');
        }

        function closeUnitModal() {
            document.getElementById('unitModal').classList.remove('show');
        }

        window.addEventListener('click', function (event) {
            const modal = document.getElementById('unitModal');
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        });

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5001);
        }


        async function loadElectives(userData) {
            /**
             * async -> use await to call 
             * Fetches and loads the list of available elective units for the user
             * 
             * This will send of POST reqeust to Flask backend to retrieve all available elective 
             * It will store the fetch elective and elective spaces for further use of planning 
             * 
             * If failed, alert will show
             */
            try {
                // send a request to backend API - /api/get-electives
                const res = await fetch(`${API_URL}/api/get-electives`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                //wait for the Javascript object 
                const data = await res.json();
                /* 
                if sucess it will return the elective require data
                - allElective -> a list of elective
                - elective Space -> how many default elective space (according to the default core unit) 
                - selected elective -> reset to empty list*/
                if (data.success) {
                    allElectives = data.electives;
                    electiveSpace = data.elective_space;
                    selectedElectives = [];
                } else showAlert(data.error || 'Failed to load electives.', 'error');
            } catch {
                showAlert('Failed to load electives.', 'error');
            }
        }

        async function toggleDeferredCore(unitCode) {
            /* 
             */
            // So when user select a unit code this line will check if this unit code is in the selectedCore list
            /*
            IF NOT -> this means that this unit code is a swapped core (come from somewhere else) and user want to add into current core list
            IF YES -> this means user is currently taking that unit and they want to swap
             */
            const isSelected = selectedCores.includes(unitCode);

            //If unit is already selected (move it to swap)
            if (isSelected) {
                //move to deferred
                selectedCores = selectedCores.filter(c => c !== unitCode);

                //Add unit to defferedCore and save the information as well
                if (!deferredCores.some(d => d.code === unitCode)) {
                    let unitObj = coreUnits.find(u => u.code === unitCode);
                    if (!unitObj) {
                        unitObj = await getUnitDetails(unitCode);
                    }
                    deferredCores.push({
                        code: unitObj.code,
                        name: unitObj.name,
                        from_semester: unitObj.from_semester || 'Previous',
                        prereq_fulfilled: unitObj.prereq_fulfilled
                    });
                }
            } else {
                //Then if user want to add to current semester core unit list
                //check the sem and prereq before  letting this happen
                const availability = await canTakeDeferredUnit(unitCode);

                //output message telling user why they cannot add this
                if (!availability.canTake) {
                    // Show specific error message
                    let message = `Cannot add ${unitCode}: `;
                    if (!availability.available_this_sem) {
                        message += 'Not available this semester';
                    } else if (!availability.prereq_fulfilled) {
                        message += 'Prerequisites not met';
                    } else {
                        message += availability.reason || 'Cannot be taken';
                    }
                    showAlert(message, 'warning');
                    return; // Don't add the unit
                }

                // If checks pass, add to selected
                selectedCores.push(unitCode);
                deferredCores = deferredCores.filter(d => d.code !== unitCode);

                /* 
                This will ensure coreUnits included this sucessfully swap unit
                If unit is not part of the CoreUnit , fetch the details */
                if (!coreUnits.some(u => u.code === unitCode)) {
                    const unitObj = await getUnitDetails(unitCode);
                    unitObj.prereq_fulfilled = availability.prereq_fulfilled;
                    unitObj.available_this_sem = availability.available_this_sem;
                    coreUnits.push(unitObj);
                }
            }

            //ensure elective space is updated as well
            electiveSpace = 4 - selectedCores.length;
            //update both the UI to show correct info
            showCoreUnits();
            viewCurrentPlan();
        }


        function showCoreUnits() {
            /* 
            This is all the UI to display the core unit page nicely and correctly 
            If swap unit havent been add anywhere, show alert message
            If unit cannot be swap at that year and sem show alert message 
            If all sucessful, show all core units nicely 
            Every core unit card as a include and swap button, if user want to swap or include the 
            toggleDefferedCore will be called
             */
            // show the core units section and hide others
            document.getElementById('coreUnitsDisplay').classList.remove('hidden');
            document.getElementById('electivesDisplay').classList.add('hidden');
            document.getElementById('currentPlanDisplay').classList.add('hidden');

            //Then this will clear the unit cards so it show new info 
            const grid = document.getElementById('coreUnitsGrid');
            grid.innerHTML = '';

            // --- Show previously deferred cores that are still deferred ---
            const stillDeferred = deferredCores.filter(d => !selectedCores.includes(d.code));
            if (stillDeferred.length > 0) {
                const deferredSection = document.createElement('div');
                deferredSection.style.cssText = 'background: #fff3e0; border: 2px solid #f57c00; border-radius: 10px; padding: 20px; margin-bottom: 30px;';
                deferredSection.innerHTML = `
                    <h3 style="color: #f57c00; margin-bottom: 15px;">‚ö†Ô∏è Previously Swapped Core Units</h3>
                    <p style="margin-bottom: 15px; color: #666;">Click a unit to check if you can add it back to your current plan.</p>
                `;

                const deferredGrid = document.createElement('div');
                deferredGrid.classList.add('unit-grid');
                deferredGrid.style.marginTop = '15px';

                stillDeferred.forEach(d => {
                    const card = document.createElement('div');
                    card.classList.add('unit-card');
                    card.style.background = 'linear-gradient(135deg, #fff9c4 0%, #fff59d 100%)';
                    card.style.border = '2px solid #f57c00';

                    card.innerHTML = `
                        <div class="unit-badge badge-warning" style="background: #f57c00; color: white;">From ${d.from_semester}</div>
                        <div class="unit-code">${d.code}</div>
                        <div style="margin-top: 10px; font-size: 0.85em;">‚è∏Ô∏è Click to validate & add</div>
                    `;
                    // this will let user try to add it back
                    card.onclick = () => toggleDeferredCore(d.code);
                    deferredGrid.appendChild(card);
                });

                deferredSection.appendChild(deferredGrid);
                grid.appendChild(deferredSection);
            }

            // --- Show all normal cores plus deferred units that were added back ---
            const allCoresToDisplay = [...coreUnits];

            deferredCores
                .filter(d => selectedCores.includes(d.code))
                .forEach(d => {
                    if (!allCoresToDisplay.some(u => u.code === d.code)) {
                        allCoresToDisplay.push({
                            code: d.code,
                            name: d.name || d.code,
                            prereq_fulfilled: d.prereq_fulfilled !== false
                        });
                    }
                });

            const currentGrid = document.createElement('div');
            currentGrid.classList.add('unit-grid');

            allCoresToDisplay.forEach(u => {
                const card = document.createElement('div');
                card.classList.add('unit-card');

                const isSelected = selectedCores.includes(u.code);
                const prereqFulfilled = u.prereq_fulfilled !== false;

                if (isSelected) card.classList.add('selected');
                if (!prereqFulfilled && isSelected) card.classList.add('prereq-not-met');

                card.innerHTML = `
                    <div class="unit-code">${u.code}</div>
                    <div class="unit-name">${u.name}</div>
                    ${!prereqFulfilled && isSelected ? '<div style="color: #d32f2f; font-size: 0.85em; margin-top: 5px;">‚ö†Ô∏è Prerequisites not met</div>' : ''}
                    <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
                        ${isSelected ? 'Click to swap' : 'Click to include'}
                    </div>
                `;

                // this button allow user to choose to include or swap the core
                card.onclick = () => showCoreUnitInfo(u.code);

                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = isSelected ? 'Swap' : 'Include';
                toggleBtn.classList.add('unit-toggle-btn');
                toggleBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleDeferredCore(u.code);
                };

                // and lastly it will show the active core, swapped and buttons 
                card.appendChild(toggleBtn);
                currentGrid.appendChild(card);
            });

            grid.appendChild(currentGrid);
        }

        async function canTakeDeferredUnit(unitCode) {
            /* 
            This will send user data to the backend and backend will validate if user prereq and sem is correct
            Send object containing info 
            CanTake: True if both prereq and sem is True else False
            available_this_sem: true if available in that sem user are planning
            prereq_fulfilled: true if user had completed the prereq
            reason: reason user does not fulfilled it 
             */
            /* 
            call backend, POST to send user to the request
            send detail such as username, unitcode, year, sem, intake and stream
             */
            try {
                const res = await fetch(`${API_URL}/api/check-unit-availability`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        unit_code: unitCode,
                        year: userData.year,
                        semester: userData.semester,
                        intake: userData.intake,
                        stream: userData.stream
                    })
                });

                // convert into JavaScript object
                const data = await res.json();

                // if backend send that data is sucess this means take unit can be taken as it is availble and prereq is fulfilled
                if (data.success) {
                    return {
                        canTake: data.available_this_sem && data.prereq_fulfilled,
                        available_this_sem: data.available_this_sem,
                        prereq_fulfilled: data.prereq_fulfilled,
                        reason: data.reason
                    };
                }
                // error message
                return { canTake: false, reason: 'Failed to check availability' };
            } catch (err) {
                console.error('Error checking unit availability:', err);
                return { canTake: false, reason: 'Error checking availability' };
            }
        }

        async function showCoreUnitInfo(unitCode) {
            /**
             * Display detail information for selected core unit in a modal 
             * 
             * This will send of POST reqeust to Flask backend with current suername and selected unit code
             * A modal window will show detailed inforamtion about the unit (name, description, semester offered, prerequisite and workload)
             */
            try {
                const res = await fetch(`${API_URL}/api/core-unit-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        unit_code: unitCode
                    })
                });

                const data = await res.json();

                if (data.success) {
                    const unit = data.unit;
                    document.getElementById('modalUnitCode').innerText = unit.code;
                    document.getElementById('modalUnitName').innerText = unit.name;
                    document.getElementById('modalUnitDesc').innerText = unit.description;
                    document.getElementById('modalUnitSem').innerText = unit.semesters.join(', ');
                    document.getElementById('modalUnitPrereq').innerText = unit.prerequisites || 'None';
                    document.getElementById('modalUnitAssign').innerText = unit.assign || 'N/A';
                    document.getElementById('modalUnitTest').innerText = unit.test || 'N/A';
                    document.getElementById('modalUnitFinal').innerText = unit.final || 'N/A';
                    document.getElementById('unitModal').classList.add('show');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (err) {
                showAlert('Failed to fetch unit info.', 'error');
                console.error(err);
            }
        }

        async function showElectiveInfo(unitCode) {
            /**
             * Display detailed information for selected elective unit in a modal
             * Similar to showCoreUnitInfo but for elective units
             */
            try {
                const res = await fetch(`${API_URL}/api/elective-unit-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: userData.username,
                        unit_code: unitCode
                    })
                });

                const data = await res.json();

                if (data.success) {
                    const unit = data.unit;
                    document.getElementById('modalUnitCode').innerText = unit.code;
                    document.getElementById('modalUnitName').innerText = unit.name;
                    document.getElementById('modalUnitDesc').innerText = unit.description;
                    document.getElementById('modalUnitSem').innerText = unit.semesters.join(', ');
                    document.getElementById('modalUnitPrereq').innerText = unit.prerequisites || 'None';
                    document.getElementById('modalUnitAssign').innerText = unit.assign || 'N/A';
                    document.getElementById('modalUnitTest').innerText = unit.test || 'N/A';
                    document.getElementById('modalUnitFinal').innerText = unit.final || 'N/A';
                    document.getElementById('unitModal').classList.add('show');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (err) {
                showAlert('Failed to fetch elective info.', 'error');
                console.error(err);
            }
        }

        function showElectives() {
            /**
             * Displays the elective units section in the planning interface
             * 
             * This funciton will hide the core unit display and current plan section then shwo the elective section
             */
            document.getElementById('coreUnitsDisplay').classList.add('hidden');
            document.getElementById('electivesDisplay').classList.remove('hidden');
            document.getElementById('currentPlanDisplay').classList.add('hidden');
            currentLevel = 0;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.level-btn').forEach(btn => {
                if (btn.textContent.includes('All')) btn.classList.add('active');
            });
            displayElectives(allElectives);
        }

        function displayElectives(electives) {
            const grid = document.getElementById('electivesGrid');
            grid.innerHTML = '';

            electives.forEach(e => {
                const card = document.createElement('div');
                card.classList.add('unit-card');
                card.innerHTML = `
                <div class="unit-code">${e.code}</div>
                <div class="unit-name">${e.name}</div>
                <div class="unit-description">${e.description}</div>
                `;

                const isSelected = selectedElectives.some(s => s.code === e.code);
                if (isSelected) card.classList.add('selected');

                const maxElectives = 4 - selectedCores.length;
                const cannotSelectMore = selectedElectives.length >= maxElectives && !isSelected;
                const isDisabled = !e.available_this_sem || e.prereq_fulfilled === false || cannotSelectMore;

                if (isDisabled && !isSelected) {
                    card.classList.add('unavailable');
                    const badge = document.createElement('div');
                    badge.classList.add('unit-badge', 'badge-warning');
                    if (!e.available_this_sem) {
                        badge.textContent = 'Not Available';
                    } else if (!e.prereq_fulfilled) {
                        badge.textContent = 'Prereq Missing';
                    } else {
                        badge.textContent = 'Max Reached';
                    }
                    card.appendChild(badge);
                }

                // Add click handler to show unit details
                card.onclick = (event) => {
                    if (event.target.classList.contains('unit-toggle-btn')) {
                        return;
                    }
                    showElectiveInfo(e.code);
                };

                // Add select/deselect button
                const selectBtn = document.createElement('button');
                selectBtn.classList.add('unit-toggle-btn');
                selectBtn.textContent = isSelected ? 'Deselect' : 'Select';

                selectBtn.onclick = (event) => {
                    event.stopPropagation();

                    if (isSelected) {
                        toggleElectiveSelection(e, card);
                        return;
                    }

                    if (isDisabled) {
                        if (!e.available_this_sem) {
                            showAlert('This unit is not available this semester', 'warning');
                        } else if (!e.prereq_fulfilled) {
                            showAlert('You have not met the prerequisites for this unit', 'warning');
                        } else {
                            showAlert(`You can only select ${maxElectives} electives`, 'warning');
                        }
                        return;
                    }

                    toggleElectiveSelection(e, card);
                };

                card.appendChild(selectBtn);
                grid.appendChild(card);
            });

            document.getElementById('electiveCounter').innerText =
                `Selected ${selectedElectives.length} / ${4 - selectedCores.length} electives`;
        }

        function toggleElectiveSelection(unit, card) {
            /*  */
            // check if the selected unit is in selected Elective, idx - 1 if not yet selected 
            const idx = selectedElectives.findIndex(e => e.code === unit.code);
            // if unit is selected, remove it from selected elective then remove on item from the idx
            if (idx !== -1) {
                selectedElectives.splice(idx, 1);
                //if unit is not selected and user havent exceed elective limit, add the elective
            } else if (selectedElectives.length < (4 - selectedCores.length)) {
                selectedElectives.push(unit);
            } else {
                //else show warning message
                showAlert(`You can select up to ${4 - selectedCores.length} electives`, 'warning');
                return;
            }
            //update UI to show all elective or only current level elective
            displayElectives(currentLevel === 0 ? allElectives : allElectives.filter(e => e.level == currentLevel));
        }

        function toggleCoreSelection(unitCode) {
            /* 
            If core unit is click
            - if selected, mark as swap
            - if swap, mark as selected again*/
            toggleDeferredCore(unitCode);
        }


        function filterElectivesByLevel(level) {
            /**
             * Show elective by level or show them all at once
             */
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const filtered = level === 0 ? allElectives : allElectives.filter(e => e.level == level);
            displayElectives(filtered);
        }

        function viewCurrentPlan() {
            const planSection = document.getElementById('currentPlanDisplay');
            document.getElementById('coreUnitsDisplay').classList.add('hidden');
            document.getElementById('electivesDisplay').classList.add('hidden');
            planSection.classList.remove('hidden');

            const planList = document.getElementById('planList');
            planList.innerHTML = '';

            // Merge selected deferred cores with normal cores
            const coreToShow = [
                ...coreUnits.filter(u => selectedCores.includes(u.code)),
                ...deferredCores
                    .filter(d => selectedCores.includes(d.code))
                    .map(d => ({ code: d.code, name: d.code })) // default name if not in coreUnits
            ];

            coreToShow.forEach(u => {
                const div = document.createElement('div');
                div.classList.add('plan-item');
                div.innerHTML = `<span>${u.code} - ${u.name}</span><span>Core</span>`;
                planList.appendChild(div);
            });

            // Selected electives
            selectedElectives.forEach(e => {
                const div = document.createElement('div');
                div.classList.add('plan-item');
                div.innerHTML = `<span>${e.code} - ${e.name}</span><span>Elective</span>`;
                planList.appendChild(div);
            });

            // Deferred cores still deferred
            const stillDeferred = deferredCores.filter(d => !selectedCores.includes(d.code));
            stillDeferred.forEach(d => {
                const div = document.createElement('div');
                div.classList.add('plan-item');
                div.style.borderLeft = '4px solid #f57c00';
                div.innerHTML = `<span>${d.code} - ${d.code}</span><span>Deferred</span>`;
                planList.appendChild(div);
            });

            // Total units
            const totalUnits = selectedCores.length + selectedElectives.length;
            const totalDiv = document.createElement('div');
            totalDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;';
            totalDiv.innerHTML = `<strong>Total units this semester:</strong> ${totalUnits} / 4`;
            planList.appendChild(totalDiv);
        }


        function showRecommendationModal() {
            /**
             * Displays the elective recommendation modal
             */
            document.getElementById('recommendModal').classList.add('show');
        }

        function closeModal() {
            /**
             * Closes the elective recommendation modal
             */
            document.getElementById('recommendModal').classList.remove('show');
        }

        async function getRecommendations() {
            /**
             * Fetch and display personalized elective recommendation for the user 
             * 
             * It will dynamically display a list of recommended elective in the recommendation modal
             */
            const level = parseInt(document.getElementById('recommendLevel').value);
            const interest = document.getElementById('userInterest').value;

            if (!interest) {
                showAlert('Please enter your interest.', 'warning');
                return;
            }

            const payload = {
                username: userData.username,
                intake: userData.intake,
                stream: userData.stream,
                year: userData.year,
                semester: userData.semester,
                level: level,
                interest: interest,
                already_chosen: selectedElectives.map(e => e.code)
            };

            try {
                const res = await fetch(`${API_URL}/api/recommend-electives`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                const resultsDiv = document.getElementById('recommendResults');
                resultsDiv.innerHTML = '<h3>Recommended Units:</h3>';

                if (data.success) {
                    data.recommendations.forEach(u => {
                        const div = document.createElement('div');
                        div.classList.add('plan-item');
                        div.innerHTML = `<span>${u.code} - ${u.name}</span>`;
                        resultsDiv.appendChild(div);
                    });
                } else {
                    showAlert(data.error || 'Failed to get recommendations', 'error');
                }
            } catch {
                showAlert('Failed to get recommendations.', 'error');
            }
        }

        async function getUnitDetails(unitCode) {
            /* 
            Show unit detail */
            try {
                const res = await fetch(`${API_URL}/api/core-unit-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userData.username, unit_code: unitCode })
                });
                const data = await res.json();
                if (data.success) {
                    return data.unit; // { code, name, description, semesters, prereq_fulfilled, etc }
                } else {
                    console.warn(`Unit ${unitCode} not found:`, data.error);
                    return { code: unitCode, name: 'Unknown Unit', from_semester: 'Previous', prereq_fulfilled: true };
                }
            } catch (err) {
                console.error("Failed to fetch unit details", err);
                return { code: unitCode, name: 'Unknown Unit', from_semester: 'Previous', prereq_fulfilled: true };
            }
        }


        async function savePlan() {
            /* 
            save info by sending all the information back to backend 
             */
            // look at core, see if which havent been selected
            // treat as core user want to swap
            const deferredThisSemester = coreUnits
                .map(u => u.code)
                .filter(code => !selectedCores.includes(code));

            //combiene all core and swap core into a single array 
            const selectedCoreObjects = [
                ...coreUnits.filter(u => selectedCores.includes(u.code)),
                ...deferredCores.filter(d => selectedCores.includes(d.code))
            ];

            //all the information backend nned to save the plan
            const payload = {
                username: userData.username,
                year: userData.year,
                semester: userData.semester,
                core_units: selectedCoreObjects,
                electives: selectedElectives,
                deferred_cores: deferredThisSemester,
                stream: userData.stream,
                intake: userData.intake
            };

            //send the information back to backend and show message indicating sucess or error
            try {
                const res = await fetch(`${API_URL}/api/save-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    let message = 'Plan saved successfully!';
                    if (deferredThisSemester.length > 0) {
                        message += ` (Deferred: ${deferredThisSemester.join(', ')})`;
                    }
                    showAlert(message, 'success');
                } else {
                    showAlert(data.error || 'Failed to save plan', 'error');
                }
            } catch {
                showAlert('Error saving plan.', 'error');
            }
        }

        // Run auto-fill as soon as the page is loaded
        window.addEventListener('DOMContentLoaded', autoFillPlannerFromCookies);

        if (!document.getElementById('chatButton')) {
            const chatBtn = document.createElement('div');
            chatBtn.className = 'chat-button';
            chatBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            chatBtn.style.cssText = 'position:fixed;bottom:30px;right:30px;width:60px;height:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);z-index:1000';
            chatBtn.onclick = () => window.open('/chat', 'AI Chat', 'width=400,height=700');
            document.body.appendChild(chatBtn);
        }
    </script>
</body>

</html>

#-------------------------------static/results.html-------------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enter My Results - Monash Smart Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }


        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease;
        }

        header h1 {
            font-size: 2.6em;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.25);
            letter-spacing: 0.5px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1.8px solid rgba(255, 255, 255, 0.85);
            padding: 12px 26px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            transform: translateX(-4px);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }


        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 24px;
            padding: 36px 28px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.35);
        }


        .card-content {
            position: relative;
            z-index: 2;
        }

        .card-icon {
            font-size: 3.5em;
            margin-bottom: 18px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            animation: floatIcon 3s ease-in-out infinite;
        }


        .user-section {
            margin-bottom: 30px;
        }

        .user-badge {
            background: rgba(102, 126, 234, 0.15);
            color: #4b55d4;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            border: 1.8px solid #d0d0d0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 13px 28px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.35);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .hidden {
            display: none;
        }

        .semester-section {
            margin-bottom: 30px;
        }

        .semester-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 22px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .semester-title {
            font-size: 1.5em;
            font-weight: 700;
        }

        .semester-stats {
            display: flex;
            gap: 18px;
            font-size: 0.9em;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .unit-card {
            background: white;
            border-radius: 12px;
            padding: 22px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .unit-card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
        }

        .unit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        /* Your original status colors remain the same */
        .unit-card.planned {
            background: rgba(245, 245, 245, 0.2);
            /* light grey with transparency */
            border-color: rgba(158, 158, 158, 0.3);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
        }

        .unit-card.planned::before {
            background: #9e9e9e;
        }

        .unit-card.fail {
            background: #ffebee;
            border-color: #f44336;
        }

        .unit-card.fail::before {
            background: #f44336;
        }

        .unit-card.pass {
            background: #fff8e1;
            border-color: #ffc107;
        }

        .unit-card.pass::before {
            background: #ffc107;
        }

        .unit-card.credit {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .unit-card.credit::before {
            background: #2196f3;
        }

        .unit-card.distinction {
            background: #f3e5f5;
            border-color: #9c27b0;
        }

        .unit-card.distinction::before {
            background: #9c27b0;
        }

        .unit-card.hd {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .unit-card.hd::before {
            background: #4caf50;
        }

        .unit-code {
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 5px;
            color: #222;
        }

        .unit-name {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .grade-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grade-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1em;
            min-width: 80px;
            text-align: center;
        }

        /* Keep grade colors but balance brightness */
        .grade-badge.planned {
            background: #e0e0e0;
            color: #666;
        }

        .grade-badge.F {
            background: #e53935;
            color: white;
        }

        .grade-badge.P {
            background: #ffca28;
            color: #333;
        }

        .grade-badge.C {
            background: #42a5f5;
            color: white;
        }

        .grade-badge.D {
            background: #ab47bc;
            color: white;
        }

        .grade-badge.HD {
            background: #43a047;
            color: white;
        }

        .grade-select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }

        .grade-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 7px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Main Menu</button>

        <header>
            <h1>üìä My Academic Results</h1>
            <p>Track your progress and update your grades</p>
        </header>

        <div id="userDisplay" class="hidden">
            <span class="user-badge">üë§ Logged in as: <span id="displayUsername"></span></span>
        </div>

        <div id="resultsSection" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #ffffff;">Your Academic Record</h2>
                <div>
                    <button class="btn" onclick="saveAllResults()">üíæ Save All Changes</button>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div id="loadingState" class="loading hidden">
                <div style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</div>
                <div>Loading your results...</div>
            </div>

            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-icon">üì≠</div>
                <h3>No Results Found</h3>
                <p>No semester records found for this user. Start planning your units first!</p>
            </div>

            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUsername = '';
        let allResults = {};

        function goBack() {
            /* 
            redirect user back to homepage
             */
            window.location.href = '/';
        }

        function showAlert(message, type = 'info') {
            /* 
            Show temporary alert message for 5 seconds
             */
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        function getCookie(name) {
            /* 
            read cookie value by name
            return null if cookie does not exists
            */
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return null;
        }

        async function loadResults() {
            /* 
            Read the username cookie and get the result info from backend and call the display result if sucessful

            else return error message
             */
            // read username cookie to identify user else show error message and return
            const username = getCookie('username');
            if (!username) {
                showAlert('No username found. Please start planning first.', 'error');
                return;
            }

            currentUsername = username;

            /* 
            Show loading indicator
            Hide empty state message
            clear container where result will be displayed
             */
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = '';

            try {
                // get result by send a POST request to API with username
                // a JSON response will be send over which contain the result
                const res = await fetch(`${API_URL}/api/get-results`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await res.json();
                document.getElementById('loadingState').classList.add('hidden');

                /* 
                If request sucess store the result in allResults
                If no result show empty
                Otherwise call display Result to show sucess alert

                If fail - show error alert
                 */
                if (data.success) {
                    allResults = data.results;

                    if (Object.keys(allResults).length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                    } else {
                        displayResults(allResults);
                        document.getElementById('resultsSection').classList.remove('hidden');
                        showAlert(`Welcome back, ${username}! Loaded ${Object.keys(allResults).length} semester(s).`, 'success');
                    }
                } else {
                    showAlert(data.error || 'Failed to load results', 'error');
                    if (data.error && data.error.includes('not found')) {
                        document.getElementById('emptyState').classList.remove('hidden');
                    }
                }
            } catch (err) {
                document.getElementById('loadingState').classList.add('hidden');
                showAlert('Error loading results. Make sure the server is running.', 'error');
                console.error(err);
            }
        }

        // Call loadResults automatically when page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadResults();
        });


        function displayResults(results) {
            /* 
            Clear previous result (HTML)
            Sort semester in chornologically order
            Show each semester and the unit result option 
             */
            // get HTML element for the result we want to display
            // clear previous content (avoid duplicate)
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            // Sort semesters (Y1S1, Y1S2, Y2S1, etc.)
            const sortedSemesters = Object.keys(results).sort((a, b) => {
                const aMatch = a.match(/Y(\d+)S(\d+)/);
                const bMatch = b.match(/Y(\d+)S(\d+)/);
                if (aMatch && bMatch) {
                    const aYear = parseInt(aMatch[1]);
                    const bYear = parseInt(bMatch[1]);
                    const aSem = parseInt(aMatch[2]);
                    const bSem = parseInt(bMatch[2]);

                    if (aYear !== bYear) return aYear - bYear;
                    return aSem - bSem;
                }
                return 0;
            });

            // loop the sorted semester and create HTML for that semester
            // this will show the section that show all units and option (result) for that semester
            sortedSemesters.forEach(semester => {
                const units = results[semester];
                const semesterDiv = createSemesterSection(semester, units);
                container.appendChild(semesterDiv);
            });
        }

        function createSemesterSection(semester, units) {
            /* 
            Built HTML for a single semester 
            Such as semester name
            Current info (total, grade, passed)
            Cards for each units
             */
            const section = document.createElement('div');
            section.className = 'semester-section';

            // Calculate stats
            const totalUnits = Object.keys(units).length;
            const completedUnits = Object.values(units).filter(g => g !== 'planned').length;
            const passedUnits = Object.values(units).filter(g => ['P', 'C', 'D', 'HD'].includes(g)).length;

            // Format semester name
            const match = semester.match(/Y(\d+)S(\d+)/);
            const yearNum = match ? match[1] : '?';
            const semNum = match ? match[2] : '?';
            const semesterName = `Year ${yearNum} - Semester ${semNum}`;

            section.innerHTML = `
                <div class="semester-header">
                    <div class="semester-title">${semesterName}</div>
                    <div class="semester-stats">
                        <div class="stat-item">üìö ${totalUnits} Units</div>
                        <div class="stat-item">‚úÖ ${completedUnits} Graded</div>
                        <div class="stat-item">üéØ ${passedUnits} Passed</div>
                    </div>
                </div>
                <div class="units-grid" id="grid-${semester}"></div>
            `;

            const grid = section.querySelector(`#grid-${semester}`);

            Object.entries(units).forEach(([code, grade]) => {
                const card = createUnitCard(semester, code, grade);
                grid.appendChild(card);
            });

            return section;
        }

        function createUnitCard(semester, code, grade) {
            /* 
            Create a card that show
            - Unit Code
            - Grade (Pending at first)
            - Button to edit grade 
             */
            const card = document.createElement('div');
            const gradeClass = getGradeClass(grade);
            card.className = `unit-card ${gradeClass}`;
            card.id = `unit-${semester}-${code}`;

            const isPlanned = grade === 'planned';
            const gradeBadgeClass = isPlanned ? 'planned' : grade;

            card.innerHTML = `
                <div class="unit-code">${code}</div>

                <div class="grade-section">
                    <div class="grade-display">
                        <span class="grade-badge ${gradeBadgeClass}" id="badge-${semester}-${code}">
                            ${isPlanned ? 'Pending' : grade}
                        </span>
                    </div>
                    <button class="edit-btn" onclick="editGrade('${semester}', '${code}', '${grade}')">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
            `;

            return card;
        }

        function getGradeClass(grade) {
            // Show the grade nicely based on the JSON info
            if (grade === 'planned') return 'planned';
            if (grade === 'F') return 'fail';
            if (grade === 'P') return 'pass';
            if (grade === 'C') return 'credit';
            if (grade === 'D') return 'distinction';
            if (grade === 'HD') return 'hd';
            return '';
        }

        function editGrade(semester, code, currentGrade) {
            /* 
            Allow user to edit grade and save their result 
             */
            const card = document.getElementById(`unit-${semester}-${code}`);
            const gradeSection = card.querySelector('.grade-section');

            gradeSection.innerHTML = `
                <select class="grade-select" id="select-${semester}-${code}">
                    <option value="planned" ${currentGrade === 'planned' ? 'selected' : ''}>Pending</option>
                    <option value="F" ${currentGrade === 'F' ? 'selected' : ''}>F - Fail</option>
                    <option value="P" ${currentGrade === 'P' ? 'selected' : ''}>P - Pass</option>
                    <option value="C" ${currentGrade === 'C' ? 'selected' : ''}>C - Credit</option>
                    <option value="D" ${currentGrade === 'D' ? 'selected' : ''}>D - Distinction</option>
                    <option value="HD" ${currentGrade === 'HD' ? 'selected' : ''}>HD - High Distinction</option>
                </select>
                <button class="edit-btn" onclick="saveGrade('${semester}', '${code}')">
                    ‚úì Save
                </button>
            `;
        }

        function saveGrade(semester, code) {
            /*  
            Provide a slection of grade and allow user to update result into the database 
            This allow system to check prereq correctly later
            */
            const select = document.getElementById(`select-${semester}-${code}`);
            const newGrade = select.value;

            // Update local data
            allResults[semester][code] = newGrade;

            // Update UI
            const card = document.getElementById(`unit-${semester}-${code}`);
            const gradeClass = getGradeClass(newGrade);
            card.className = `unit-card ${gradeClass}`;

            const isPlanned = newGrade === 'planned';
            const gradeBadgeClass = isPlanned ? 'planned' : newGrade;

            card.querySelector('.grade-section').innerHTML = `
                <div class="grade-display">
                    <span class="grade-badge ${gradeBadgeClass}">
                        ${isPlanned ? 'Pending' : newGrade}
                    </span>
                </div>
                <button class="edit-btn" onclick="editGrade('${semester}', '${code}', '${newGrade}')">
                    ‚úèÔ∏è Edit
                </button>
            `;

            showAlert(`Grade updated for ${code}. Don't forget to save!`, 'info');
        }

        async function saveAllResults() {
            /* 
            send the result to server and save permanently to the bankend API (POST requests)
             */
            try {
                const res = await fetch(`${API_URL}/api/save-results`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        results: allResults
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showAlert('‚úÖ All results saved successfully!', 'success');
                } else {
                    showAlert(data.error || 'Failed to save results', 'error');
                }
            } catch (err) {
                showAlert('Error saving results. Please try again.', 'error');
                console.error(err);
            }
        }

        if (!document.getElementById('chatButton')) {
            const chatBtn = document.createElement('div');
            chatBtn.className = 'chat-button';
            chatBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            chatBtn.style.cssText = 'position:fixed;bottom:30px;right:30px;width:60px;height:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);z-index:1000';
            chatBtn.onclick = () => window.open('/chat', 'AI Chat', 'width=400,height=700');
            document.body.appendChild(chatBtn);
        }
    </script>
</body>

</html>

#-------------------------------static/update.html---------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Units - Monash Smart Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }


        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: white;
            color: #667eea;
            transform: translateX(-5px);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.6s ease;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }

        .hidden {
            display: none;
        }

        .unit-info-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .info-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-header h3 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .info-header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 700;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            font-size: 2em;
        }

        .user-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        .instruction-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .instruction-box h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .instruction-box ul {
            margin-left: 20px;
            color: #1565c0;
        }

        .instruction-box li {
            margin-bottom: 5px;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Main Menu</button>

        <header>
            <h1>üîÑ Update Unit Information</h1>
            <p>Keep your unit data current with the latest handbook information</p>
        </header>

        <div class="card">
            <div id="alertContainer"></div>

            <div id="userDisplay" class="hidden">
                <span class="user-badge">üë§ Logged in as: <span id="displayUsername"></span></span>
            </div>

            <div class="instruction-box">
                <h4>üìã How to Update Units:</h4>
                <ul>
                    <li>Enter the intake year (e.g., 2024, 2025)</li>
                    <li>Enter the unit code you want to update (e.g., FIT2004)</li>
                    <li>The system will scrape the latest information from Monash Handbook</li>
                    <li>Updated data will be saved to your core/elective units files</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="intakeYear">Intake Year</label>
                <input type="number" id="intakeYear" placeholder="e.g., 2024" min="2020" max="2030">
            </div>

            <div class="form-group">
                <label for="unitCode">Unit Code</label>
                <input type="text" id="unitCode" placeholder="e.g., FIT2004">
            </div>

            <button class="btn" onclick="updateUnit()">üîç Fetch & Update Unit Info</button>

            <div id="loadingState" class="loading hidden">
                <div class="spinner">‚è≥</div>
                <div>Scraping Monash Handbook...</div>
            </div>

            <div id="unitInfoDisplay" class="unit-info-display hidden">
                <div class="info-header">
                    <h3 id="unitCodeDisplay"></h3>
                    <p id="unitNameDisplay"></p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 1.5em;">üìÖ</span>
                        <div>
                            <div style="font-size: 0.85em; color: #666; font-weight: 600;">AVAILABLE SEMESTERS</div>
                            <div id="semestersDisplay" style="font-weight: 700; color: #2196f3; margin-top: 3px;"></div>
                        </div>
                    </div>
                </div>

                <div
                    style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span>üìä</span> Assessment Breakdown
                    </h4>

                    <div style="display: grid; gap: 12px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 15px; border-radius: 8px;">
                            <span style="font-weight: 600; color: #555;">üìù Assignments</span>
                            <span id="assignDisplay" style="font-weight: 700; color: #667eea; font-size: 1.1em;"></span>
                        </div>

                        <div
                            style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 15px; border-radius: 8px;">
                            <span style="font-weight: 600; color: #555;">üìã Tests</span>
                            <span id="testDisplay" style="font-weight: 700; color: #9c27b0; font-size: 1.1em;"></span>
                        </div>

                        <div
                            style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 15px; border-radius: 8px;">
                            <span style="font-weight: 600; color: #555;">üéØ Final Exam</span>
                            <span id="finalDisplay" style="font-weight: 700; color: #4caf50; font-size: 1.1em;"></span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; color: #2e7d32;">
                    <strong>‚úÖ Success!</strong> Unit information has been updated in your files.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUsername = '';

        function getCookie(name) {
            /* 
            get cookie value by name
            extract the value and decode it if we manage to find the specific cookie of name=
             */
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return null;
        }

        function goBack() {
            // back to homepage
            window.location.href = '/';
        }

        function showAlert(message, type = 'info') {
            // display 5 seconds message to alert user
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // Load username from cookie on page load
        window.addEventListener('DOMContentLoaded', () => {
            const username = getCookie('username');
            if (username) {
                currentUsername = username;
                document.getElementById('userDisplay').classList.remove('hidden');
                document.getElementById('displayUsername').textContent = username;
            } else {
                showAlert('‚ö†Ô∏è No username found in session. Please start planning first to set up your account.', 'warning');
            }
        });

        async function updateUnit() {
            /* 
            get updated information about specific unit from the server

            get user input (intake year and unit code)
            valide if the input and username exists
            show loading (takes at least 5 seconds to scrape)
            send POST request with username intake year and unit code (all info needed to scrape)
            if sucess show sucess alert else show error
             */
            const intakeYear = document.getElementById('intakeYear').value.trim();
            const unitCode = document.getElementById('unitCode').value.trim().toUpperCase();

            // Validation
            if (!intakeYear || !unitCode) {
                showAlert('Please enter both intake year and unit code', 'error');
                return;
            }

            if (!currentUsername) {
                showAlert('No username found. Please complete unit planning first.', 'error');
                return;
            }

            // Show loading
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('unitInfoDisplay').classList.add('hidden');

            try {
                const res = await fetch(`${API_URL}/api/update-unit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        intake_year: intakeYear,
                        unit_code: unitCode
                    })
                });

                const data = await res.json();
                document.getElementById('loadingState').classList.add('hidden');

                if (data.success) {
                    // Display updated unit info
                    displayUnitInfo(data.unit_info);
                    showAlert('‚úÖ Unit information updated successfully!', 'success');
                } else {
                    showAlert(data.error || 'Failed to update unit', 'error');
                }
            } catch (err) {
                document.getElementById('loadingState').classList.add('hidden');
                showAlert('Error updating unit. Make sure the server is running.', 'error');
                console.error(err);
            }
        }

        function displayUnitInfo(unitInfo) {
            /* 
            Show Detials of unit int the page
            semester show in july or februrary (words instead of 1;2)
            prereq show NONE if no that section else show in percentage
             */
            document.getElementById('unitCodeDisplay').textContent = unitInfo.code;
            document.getElementById('unitNameDisplay').textContent = unitInfo.name;

            // Format semesters display (use semesters_list from API)
            const semDisplay = document.getElementById('semestersDisplay');
            if (unitInfo.semesters_list && unitInfo.semesters_list.length > 0) {
                // Display each semester on a new line with bullet
                semDisplay.innerHTML = unitInfo.semesters_list.map(sem =>
                    `<div style="margin-top: 3px;">‚Ä¢ ${sem}</div>`
                ).join('');
            } else {
                semDisplay.innerHTML = '<span style="opacity: 0.5; font-style: italic;">Not Available</span>';
            }

            // Format workload with None styling
            const assignDisplay = document.getElementById('assignDisplay');
            assignDisplay.innerHTML = unitInfo.assign === 'None' || !unitInfo.assign
                ? '<span style="opacity: 0.5; font-style: italic;">None</span>'
                : unitInfo.assign;

            const testDisplay = document.getElementById('testDisplay');
            testDisplay.innerHTML = unitInfo.test === 'None' || !unitInfo.test
                ? '<span style="opacity: 0.5; font-style: italic;">None</span>'
                : unitInfo.test;

            const finalDisplay = document.getElementById('finalDisplay');
            finalDisplay.innerHTML = unitInfo.final === 'None' || !unitInfo.final
                ? '<span style="opacity: 0.5; font-style: italic;">None</span>'
                : unitInfo.final;

            document.getElementById('unitInfoDisplay').classList.remove('hidden');
        }

        // Allow Enter key to submit
        document.getElementById('unitCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateUnit();
            }
        });

        document.getElementById('intakeYear').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('unitCode').focus();
            }
        });

        if (!document.getElementById('chatButton')) {
            const chatBtn = document.createElement('div');
            chatBtn.className = 'chat-button';
            chatBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            chatBtn.style.cssText = 'position:fixed;bottom:30px;right:30px;width:60px;height:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);z-index:1000';
            chatBtn.onclick = () => window.open('/chat', 'AI Chat', 'width=400,height=700');
            document.body.appendChild(chatBtn);
        }
    </script>
</body>

</html>

#--------------------------------static/forum.html----------------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monash FIT Community Forum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }


        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 48px;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 8px;
            font-weight: 700;
            color: white;
            letter-spacing: -1px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.85;
            font-weight: 400;
        }

        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            border-radius: 20px;
            padding: 32px;
            animation: fadeInUp 0.6s ease;
            transition: all 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateX(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-size: 0.9em;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.2s ease;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.9);
            color: #1d1d1f;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        input::placeholder,
        textarea::placeholder {
            color: #86868b;
        }

        input:focus,
        textarea:focus {
            outline: none;
            background: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15), 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .hidden {
            display: none;
        }

        .unit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .unit-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .unit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .unit-card:hover::before {
            transform: scaleX(1);
        }

        .unit-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }


        .unit-code {
            font-weight: 700;
            font-size: 1.4em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .unit-name {
            font-size: 1.05em;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .unit-description {
            font-size: 0.9em;
            line-height: 1.5;
            color: #666;
            margin-bottom: 16px;
        }

        .discussion-stats {
            display: flex;
            gap: 10px;
            font-size: 0.85em;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .stat-badge:hover {
            transform: scale(1.05);
        }

        .stat-badge.general {
            color: #667eea;
        }

        .stat-badge.resources {
            color: #10b981;
        }

        .stat-badge.private {
            color: #f59e0b;
        }

        .tag-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tag-btn {
            flex: 1;
            min-width: 160px;
            padding: 12px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            color: #666;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .tag-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tag-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .discussion-list {
            margin-top: 24px;
        }

        .discussion-item {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 4px solid transparent;
            border-image: linear-gradient(to bottom, #667eea, #764ba2) 1;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .discussion-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .discussion-item:hover::before {
            transform: scaleY(1);
        }

        .discussion-item:hover {
            transform: translateX(8px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            color: rgba(255, 255, 255, 0.6);
        }

        .discussion-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .discussion-title {
            font-size: 1.15em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 6px;
        }

        .discussion-meta {
            font-size: 0.85em;
            color: #86868b;
            font-weight: 500;
        }

        .discussion-content {
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .reply-count {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        .delete-btn {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.2);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.15);
            transform: scale(1.02);
        }

        .reply-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .reply-item {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .reply-item:hover {
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            background: rgba(255, 255, 255, 0.95);
        }

        .reply-meta {
            font-size: 0.85em;
            color: #86868b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .reply-content {
            color: #1d1d1f;
            line-height: 1.5;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: slideIn 0.4s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
            border: 1px solid;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: rgba(52, 199, 89, 0.15);
            color: #10b981;
            border-color: rgba(52, 199, 89, 0.3);
        }

        .alert-error {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            border-color: rgba(255, 59, 48, 0.3);
        }

        .alert-warning {
            background: rgba(255, 149, 0, 0.15);
            color: #f59e0b;
            border-color: rgba(255, 149, 0, 0.3);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-box input {
            flex: 1;
        }

        .like-btn {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
        }

        .like-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }

        .like-btn .heart {
            transition: all 0.2s ease;
            font-size: 1.1em;
        }

        .like-btn.liked {
            background: rgba(255, 59, 48, 0.15);
            border-color: rgba(255, 59, 48, 0.3);
        }

        .like-btn.liked .heart {
            color: #ff3b30;
            animation: heartBeat 0.4s ease;
        }

        .like-btn:not(.liked) .heart {
            color: #86868b;
        }

        .like-count {
            font-size: 0.9em;
            color: #1d1d1f;
            font-weight: 600;
        }

        @keyframes heartBeat {

            0%,
            100% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.3);
            }

            50% {
                transform: scale(1.1);
            }
        }

        h2,
        h3 {
            color: #1d1d1f;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>

<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">‚Üê Back to Main Menu</button>

        <header>
            <h1>üí¨ Monash FIT Community Forum</h1>
            <p>Connect, share, and learn with your peers</p>
        </header>

        <!-- Login Section -->
        <div id="loginSection" class="card">
            <h2 style="margin-bottom: 25px;">Welcome to the Forum</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <button class="btn" onclick="loadForum()">Enter Forum</button>
        </div>

        <!-- Units Overview Section -->
        <div id="unitsSection" class="card hidden">
            <div id="alertContainer"></div>

            <h2 style="margin-bottom: 20px;">Select a Unit to Discuss</h2>

            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="Search units...">
                <button class="btn" onclick="searchUnits()">Search</button>
            </div>

            <div id="unitsGrid" class="unit-grid"></div>
        </div>

        <!-- Discussion View Section -->
        <div id="discussionSection" class="card hidden">
            <button class="btn btn-secondary" onclick="backToUnits()">‚Üê Back to Units</button>

            <div id="alertContainer2"></div>

            <h2 id="unitTitle" style="margin-bottom: 10px; 
                background: linear-gradient(135deg, #667eea, #764ba2); 
                -webkit-background-clip: text; 
                -webkit-text-fill-color: transparent;">
            </h2>
            <p id="unitDescription" style="color: #666; margin-bottom: 20px;"></p>

            <div class="tag-selector">
                <button class="tag-btn active" onclick="switchTag('general')">
                    üí¨ General Enquiries
                </button>
                <button class="tag-btn" onclick="switchTag('resources')">
                    üìö Recommended Resources
                </button>
                <button class="tag-btn" onclick="switchTag('private')">
                    üîí Private Notes
                </button>
            </div>

            <button class="btn" onclick="showNewDiscussionForm()">+ New Discussion</button>

            <!-- New Discussion Form -->
            <div id="newDiscussionForm" class="hidden"
                style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border-radius: 14px; border: 1px solid rgba(255, 255, 255, 0.3);">
                <h3 style="margin-bottom: 15px;">Create New Discussion</h3>
                <div class="form-group">
                    <label for="discussionTitle">Title</label>
                    <input type="text" id="discussionTitle" placeholder="Enter discussion title">
                </div>
                <div class="form-group">
                    <label for="discussionContent">Content</label>
                    <textarea id="discussionContent" placeholder="Enter your message..."></textarea>
                </div>
                <button class="btn" onclick="submitDiscussion()">Post Discussion</button>
                <button class="btn btn-secondary" onclick="hideNewDiscussionForm()">Cancel</button>
            </div>

            <div id="discussionList" class="discussion-list"></div>
        </div>

        <!-- Discussion Detail View -->
        <div id="detailSection" class="card hidden">
            <button class="btn btn-secondary" onclick="backToDiscussions()">‚Üê Back to Discussions</button>

            <div id="alertContainer3"></div>

            <div id="discussionDetail" style="margin-top: 20px;"></div>

            <div class="reply-section">
                <h3 style="margin-bottom: 15px;">Add a Reply</h3>
                <div class="form-group">
                    <textarea id="replyContent" placeholder="Write your reply..."></textarea>
                </div>
                <button class="btn" onclick="submitReply()">Post Reply</button>
            </div>

            <div id="repliesList"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUsername = '';
        let currentUnit = null;
        let currentTag = 'general';
        let currentDiscussion = null;
        let allUnits = [];

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return '';
        }

        function goBack() {
            window.location.href = window.location.origin + '/';
        }

        function showAlert(message, type = 'success', container = 'alertContainer') {
            const alertDiv = document.getElementById(container);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // Auto-fill username from cookie
        window.addEventListener('DOMContentLoaded', function () {
            const savedUsername = getCookie('username');
            if (savedUsername) {
                document.getElementById('username').value = savedUsername;
            }
        });

        async function loadForum() {
            /* 
            Store the units globally and call display unit to show the units on the page
             */
            const username = document.getElementById('username').value.trim();

            if (!username) {
                showAlert('Please enter your username', 'error');
                return;
            }

            currentUsername = username;

            try {
                const res = await fetch(`${API_URL}/api/forum/units`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await res.json();

                if (!data.success) {
                    showAlert(data.error || 'Failed to load units', 'error');
                    return;
                }

                allUnits = data.units;
                displayUnits(allUnits);

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('unitsSection').classList.remove('hidden');
            } catch (err) {
                showAlert('Error loading forum', 'error');
                console.error(err);
            }
        }

        function displayUnits(units) {
            const grid = document.getElementById('unitsGrid');
            grid.innerHTML = '';

            if (units.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">No units found. Please complete your unit planning first.</p>';
                return;
            }

            units.forEach(unit => {
                // show each unit discussion count nicely 
                const card = document.createElement('div');
                card.classList.add('unit-card');
                card.onclick = () => loadUnitDiscussions(unit);

                card.innerHTML = `
                    <div class="unit-code">${unit.code}</div>
                    <div class="unit-name">${unit.name}</div>
                    <div class="unit-description">${unit.description}</div>
                    <div class="discussion-stats">
                        <span class="stat-badge general">üí¨ ${unit.discussion_count.general}</span>
                        <span class="stat-badge resources">üìö ${unit.discussion_count.resources}</span>
                        <span class="stat-badge private">üîí ${unit.discussion_count.private}</span>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function searchUnits() {
            // search unit if user have specific unit in mind
            const query = document.getElementById('searchQuery').value.toLowerCase();

            if (!query) {
                displayUnits(allUnits);
                return;
            }

            const filtered = allUnits.filter(unit =>
                unit.code.toLowerCase().includes(query) ||
                unit.name.toLowerCase().includes(query) ||
                unit.description.toLowerCase().includes(query)
            );

            displayUnits(filtered);
        }

        async function loadUnitDiscussions(unit) {
            currentUnit = unit;
            currentTag = 'general';

            document.getElementById('unitTitle').textContent = `${unit.code} - ${unit.name}`;
            document.getElementById('unitDescription').textContent = unit.description;

            document.getElementById('unitsSection').classList.add('hidden');
            document.getElementById('discussionSection').classList.remove('hidden');

            // Reset tag buttons
            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tag-btn')[0].classList.add('active');

            await loadDiscussions();
        }

        async function switchTag(tag) {
            currentTag = tag;

            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            await loadDiscussions();
        }

        async function loadDiscussions() {
            try {
                const res = await fetch(`${API_URL}/api/forum/discussions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        unit_code: currentUnit.code,
                        tag: currentTag,
                        request_username: currentUsername
                    })
                });

                const data = await res.json();

                if (!data.success) {
                    showAlert(data.error, 'error', 'alertContainer2');
                    return;
                }

                displayDiscussions(data.discussions);
            } catch (err) {
                showAlert('Error loading discussions', 'error', 'alertContainer2');
                console.error(err);
            }
        }

        function displayDiscussions(discussions) {
            const list = document.getElementById('discussionList');
            list.innerHTML = '';

            if (discussions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #000; padding: 20px;">No discussions yet. Be the first to start one!</p>';
                return;
            }

            discussions.forEach(discussion => {
                const item = document.createElement('div');
                item.classList.add('discussion-item');

                const isOwner = discussion.username === currentUsername;
                const deleteButton = isOwner ?
                    `<button class="delete-btn" onclick="deleteDiscussion(event, ${discussion.id})">Delete</button>` : '';

                // Check if current user liked this
                const likes = discussion.likes || [];
                const isLiked = likes.includes(currentUsername);
                const likedClass = isLiked ? 'liked' : '';

                item.innerHTML = `
                    <div class="discussion-header">
                        <div>
                            <div class="discussion-title">${discussion.title}</div>
                            <div class="discussion-meta">
                                By ${discussion.username} ‚Ä¢ ${formatDate(discussion.timestamp)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="like-btn ${likedClass}" 
                                    onclick="toggleLike(event, ${discussion.id})"
                                    data-discussion-id="${discussion.id}">
                                <span class="heart">‚ô•</span>
                                <span class="like-count">${likes.length}</span>
                            </button>
                            ${deleteButton}
                        </div>
                    </div>
                    <div class="discussion-content">${discussion.content}</div>
                    <div class="reply-count">üí¨ ${discussion.replies.length} replies</div>
                `;

                item.onclick = (e) => {
                    if (!e.target.closest('.delete-btn') && !e.target.closest('.like-btn')) {
                        viewDiscussion(discussion);
                    }
                };

                list.appendChild(item);
            });
        }
        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }

        function showNewDiscussionForm() {
            document.getElementById('newDiscussionForm').classList.remove('hidden');
            document.getElementById('discussionTitle').value = '';
            document.getElementById('discussionContent').value = '';
        }

        function hideNewDiscussionForm() {
            document.getElementById('newDiscussionForm').classList.add('hidden');
        }

        async function submitDiscussion() {
            const title = document.getElementById('discussionTitle').value.trim();
            const content = document.getElementById('discussionContent').value.trim();

            if (!title || !content) {
                showAlert('Please fill in both title and content', 'error', 'alertContainer2');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/forum/add-discussion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        unit_code: currentUnit.code,
                        tag: currentTag,
                        title,
                        content
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showAlert('Discussion posted successfully!', 'success', 'alertContainer2');
                    hideNewDiscussionForm();
                    await loadDiscussions();
                } else {
                    showAlert(data.error, 'error', 'alertContainer2');
                }
            } catch (err) {
                showAlert('Error posting discussion', 'error', 'alertContainer2');
                console.error(err);
            }
        }

        async function deleteDiscussion(event, discussionId) {
            event.stopPropagation();

            if (!confirm('Are you sure you want to delete this discussion?')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/forum/delete-discussion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        unit_code: currentUnit.code,
                        tag: currentTag,
                        discussion_id: discussionId
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showAlert('Discussion deleted successfully', 'success', 'alertContainer2');
                    await loadDiscussions();
                } else {
                    showAlert(data.error, 'error', 'alertContainer2');
                }
            } catch (err) {
                showAlert('Error deleting discussion', 'error', 'alertContainer2');
                console.error(err);
            }
        }

        function viewDiscussion(discussion) {
            currentDiscussion = discussion;

            document.getElementById('discussionSection').classList.add('hidden');
            document.getElementById('detailSection').classList.remove('hidden');

            const detailDiv = document.getElementById('discussionDetail');
            detailDiv.innerHTML = `
                <div class="discussion-item">
                    <div class="discussion-title">${discussion.title}</div>
                    <div class="discussion-meta">
                        By ${discussion.username} ‚Ä¢ ${formatDate(discussion.timestamp)}
                    </div>
                    <div class="discussion-content" style="margin-top: 15px; font-size: 1.1em;">
                        ${discussion.content}
                    </div>
                </div>
            `;

            displayReplies(discussion.replies);
        }

        async function toggleLike(event, discussionId) {
            event.stopPropagation();

            const button = event.currentTarget;

            try {
                const res = await fetch(`${API_URL}/api/forum/toggle-like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        unit_code: currentUnit.code,
                        tag: currentTag,
                        discussion_id: discussionId
                    })
                });

                const data = await res.json();

                if (data.success) {
                    // Update UI immediately
                    const heart = button.querySelector('.heart');
                    const count = button.querySelector('.like-count');

                    if (data.liked) {
                        button.classList.add('liked');
                    } else {
                        button.classList.remove('liked');
                    }

                    count.textContent = data.like_count;
                } else {
                    showAlert(data.error, 'error', 'alertContainer2');
                }
            } catch (err) {
                showAlert('Error toggling like', 'error', 'alertContainer2');
                console.error(err);
            }
        }

        function displayReplies(replies) {
            const list = document.getElementById('repliesList');
            list.innerHTML = '';

            if (replies.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #000; padding: 20px;">No replies yet.</p>';
                return;
            }

            replies.forEach(reply => {
                const item = document.createElement('div');
                item.classList.add('reply-item');
                item.innerHTML = `
                    <div class="reply-meta">${reply.username} ‚Ä¢ ${formatDate(reply.timestamp)}</div>
                    <div class="reply-content">${reply.content}</div>
                `;
                list.appendChild(item);
            });
        }

        async function submitReply() {
            const content = document.getElementById('replyContent').value.trim();

            if (!content) {
                showAlert('Please enter a reply', 'error', 'alertContainer3');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/api/forum/add-reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUsername,
                        unit_code: currentUnit.code,
                        tag: currentTag,
                        discussion_id: currentDiscussion.id,
                        content
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showAlert('Reply posted successfully!', 'success', 'alertContainer3');
                    document.getElementById('replyContent').value = '';

                    // Reload the discussion to show new reply
                    await loadDiscussions();
                    const discussions = await fetch(`${API_URL}/api/forum/discussions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentUsername,
                            unit_code: currentUnit.code,
                            tag: currentTag
                        })
                    }).then(r => r.json());

                    const updatedDiscussion = discussions.discussions.find(d => d.id === currentDiscussion.id);
                    if (updatedDiscussion) {
                        currentDiscussion = updatedDiscussion;
                        displayReplies(updatedDiscussion.replies);
                    }
                } else {
                    showAlert(data.error, 'error', 'alertContainer3');
                }
            } catch (err) {
                showAlert('Error posting reply', 'error', 'alertContainer3');
                console.error(err);
            }
        }

        function backToDiscussions() {
            document.getElementById('detailSection').classList.add('hidden');
            document.getElementById('discussionSection').classList.remove('hidden');
        }

        function backToUnits() {
            document.getElementById('discussionSection').classList.add('hidden');
            document.getElementById('unitsSection').classList.remove('hidden');
        }

        if (!document.getElementById('chatButton')) {
            const chatBtn = document.createElement('div');
            chatBtn.className = 'chat-button';
            chatBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
            chatBtn.style.cssText = 'position:fixed;bottom:30px;right:30px;width:60px;height:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);z-index:1000';
            chatBtn.onclick = () => window.open('/chat', 'AI Chat', 'width=400,height=700');
            document.body.appendChild(chatBtn);
        }
    </script>
</body>

</html>



#---------------------------static/chat.html------------------------
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Course Advisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(-45deg, #f3eaff, #e6e0ff, #f8f3ff, #ede6ff);
            /* light purple shades */
            background-size: 400% 400%;
            animation: gentleBg 18s ease infinite;
            color: #333;
            overflow-x: hidden;
        }

        @keyframes gentleBg {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        /* Floating Chat Button */
        .chat-button {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(118, 75, 162, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(118, 75, 162, 0.3);
        }

        .chat-button svg {
            width: 28px;
            height: 28px;
            fill: #667eea;
        }

        /* Sidebar */
        .chat-sidebar {
            position: fixed;
            right: -420px;
            top: 0;
            width: 420px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(40px) saturate(180%);
            box-shadow: -2px 0 60px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chat-sidebar.open {
            right: 0;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .chat-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.3px;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: rotate(90deg);
        }

        /* Context Toggle */
        .context-toggle {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.06);
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .context-toggle:hover {
            background: rgba(255, 255, 255, 0.45);
        }

        .context-toggle-text {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .context-toggle-icon {
            font-size: 12px;
            color: #888;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .context-toggle-icon.rotated {
            transform: rotate(180deg);
        }

        /* Context Fields */
        .chat-context {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.06);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s ease;
        }

        .chat-context.expanded {
            max-height: 400px;
            padding: 20px 24px;
            overflow-y: auto;
        }

        .chat-context::-webkit-scrollbar {
            width: 6px;
        }

        .chat-context::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .context-field {
            margin-bottom: 16px;
        }

        .context-field:last-child {
            margin-bottom: 0;
        }

        .context-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .context-label {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .context-input,
        .context-select {
            width: 100%;
            padding: 11px 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            background: rgba(255, 255, 255, 0.8);
            color: #1d1d1f;
            transition: all 0.2s ease;
            font-family: inherit;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .context-input:focus,
        .context-select:focus {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15), 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: transparent;
            background: linear-gradient(135deg, #8697f0, #8e71d1);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .message.user .message-avatar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .message.ai .message-avatar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            backdrop-filter: blur(10px);
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-content {
            background: rgba(255, 255, 255, 0.85);
            color: #1d1d1f;
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 18px;
            width: fit-content;
            margin-left: 48px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 16px;
        }

        .typing-indicator.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 3px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            30% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Input Area */
        .chat-input-area {
            padding: 20px 24px 28px;
            background: linear-gradient(135deg, #8697f0, #8e71d1);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0, 0, 0, 0.06);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            padding: 6px 6px 6px 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        .input-wrapper:focus-within {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15), 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #chatInput {
            flex: 1;
            padding: 8px 0;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
            color: #1d1d1f;
            font-family: inherit;
        }

        #chatInput::placeholder {
            color: #86868b;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }
    </style>
</head>

<body>
    <!-- Floating chat button -->
    <div class="chat-button" id="chatButton">
        <svg viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
        </svg>
    </div>

    <!-- Chat sidebar -->
    <div class="chat-sidebar" id="chatSidebar">
        <!-- Header -->
        <div class="chat-header">
            <h2>üéì AI Course Advisor</h2>
            <button class="close-btn" id="closeChat">&times;</button>
        </div>

        <!-- Context toggle button -->
        <div class="context-toggle" id="contextToggle">
            <span class="context-toggle-text">üìù Edit Your Profile</span>
            <span class="context-toggle-icon" id="toggleIcon">‚ñº</span>
        </div>

        <!-- Context inputs -->
        <div class="chat-context" id="chatContext">
            <div class="context-field">
                <label class="context-label">Your Name *</label>
                <input type="text" id="username" class="context-input" placeholder="Enter your name">
            </div>
            <div class="context-row">
                <div class="context-field" style="flex: 1;">
                    <label class="context-label">Intake</label>
                    <select id="intake" class="context-select">
                        <option value="">Select...</option>
                        <option value="1">Feb</option>
                        <option value="2">July</option>
                    </select>
                </div>
                <div class="context-field" style="flex: 1;">
                    <label class="context-label">Stream</label>
                    <select id="stream" class="context-select">
                        <option value="">Select...</option>
                        <option value="1">Data Science</option>
                        <option value="2">Algorithms & Software</option>
                    </select>
                </div>
            </div>
            <div class="context-row">
                <div class="context-field" style="flex: 1;">
                    <label class="context-label">Year</label>
                    <select id="year" class="context-select">
                        <option value="">Select...</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                    </select>
                </div>
                <div class="context-field" style="flex: 1;">
                    <label class="context-label">Semester</label>
                    <select id="semester" class="context-select">
                        <option value="">Select...</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                </div>
            </div>
            <div class="context-field">
                <label class="context-label">Your Interest</label>
                <input type="text" id="interest" class="context-input" placeholder="e.g., AI, Web Dev, Data Science">
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    üëã Hi! I'm your AI Course Advisor. I can help you with:<br>
                    ‚Ä¢ <b>Unit Recommendations</b> ‚Äì Suggest units based on your interests, year, semester, and
                    stream.<br>
                    ‚Ä¢ <b>Workload Analysis</b> ‚Äì Check if your planned semester is manageable.<br>
                    ‚Ä¢ <b>Unit Readiness</b> ‚Äì See if you're prepared for a specific unit or if you can add it.<br>
                    ‚Ä¢ <b>Semester Readiness</b> ‚Äì Analyze your full semester plan to see if it's manageable.<br>
                    ‚Ä¢ <b>Unit Comparison</b> ‚Äì Compare two or more units side by side.<br>
                    ‚Ä¢ <b>Study Resources & Feedback</b> ‚Äì Summarize unit materials or student opinions.<br><br>
                    üí° <i>Tip:</i> Include unit codes (e.g., FIT1045) in your question for specific advice.<br>
                    Example prompts:<br>
                    - "Recommend units for me"<br>
                    - "Can I take FIT1008 next semester?"<br>
                    - "Compare FIT1045 and FIT1047"<br>
                    - "Show workload"<br>
                    - "Analyze my semester plan"
                </div>
            </div>
        </div>

        <!-- Typing indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>

        <!-- Input area -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <input type="text" id="chatInput" placeholder="Ask me anything about your course...">
                <button class="send-btn" id="sendBtn">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        // Cookie helper functions
        function setCookie(name, value, days = 30) {
            const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return '';
        }

        function saveUserInfoToCookies() {
            setCookie('chat_username', document.getElementById('username').value);
            setCookie('chat_intake', document.getElementById('intake').value);
            setCookie('chat_stream', document.getElementById('stream').value);
            setCookie('chat_year', document.getElementById('year').value);
            setCookie('chat_semester', document.getElementById('semester').value);
            setCookie('chat_interest', document.getElementById('interest').value);
        }

        function loadUserInfoFromCookies() {
            // Try to load from planner cookies first
            const username = getCookie('username') || getCookie('chat_username');
            const intake = getCookie('intake') || getCookie('chat_intake');
            const stream = getCookie('stream') || getCookie('chat_stream');
            const year = getCookie('year') || getCookie('chat_year');
            const semester = getCookie('semester') || getCookie('chat_semester');
            const interest = getCookie('interest') || getCookie('chat_interest');

            if (username) document.getElementById('username').value = username;
            if (intake) document.getElementById('intake').value = intake;
            if (stream) document.getElementById('stream').value = stream;
            if (year) document.getElementById('year').value = year;
            if (semester) document.getElementById('semester').value = semester;
            if (interest) document.getElementById('interest').value = interest;
        }


        document.addEventListener('DOMContentLoaded', function () {
            const chatButton = document.getElementById('chatButton');
            const chatSidebar = document.getElementById('chatSidebar');
            const closeChat = document.getElementById('closeChat');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            const suggestions = document.getElementById('suggestions');

            // Load saved user info from cookies
            loadUserInfoFromCookies();

            // Context toggle
            const contextToggle = document.getElementById('contextToggle');
            const chatContext = document.getElementById('chatContext');
            const toggleIcon = document.getElementById('toggleIcon');

            contextToggle.addEventListener('click', () => {
                chatContext.classList.toggle('expanded');
                toggleIcon.classList.toggle('rotated');
            });

            chatButton.addEventListener('click', () => {
                chatSidebar.classList.add('open');
                chatInput.focus();
                chatButton.style.display = 'none'; // hide the floating button
                if (suggestions) suggestions.classList.add('show');
            });

            closeChat.addEventListener('click', () => {
                chatSidebar.classList.remove('open');
                chatButton.style.display = 'flex'; // show it again when closing
            });

            // Send message
            async function sendMessage() {
                // get user message by reading the text typed in chatInput
                // trim to remove extra spaces
                const message = chatInput.value.trim();
                if (!message) return;

                // read user info, the memory of the AI
                const username = document.getElementById('username').value.trim();
                const intake = document.getElementById('intake').value.trim();
                const stream = document.getElementById('stream').value.trim();
                const year = document.getElementById('year').value.trim();
                const semester = document.getElementById('semester').value.trim();
                const interest = document.getElementById('interest').value.trim();

                // Validate username
                if (!username) {
                    addMessage('Please enter your name first! Click "üìù Edit Your Profile" above.', 'ai');
                    return;
                }

                // Save user info to cookies
                saveUserInfoToCookies();

                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';
                sendBtn.disabled = true;

                // Show typing indicator
                // let user know AI is generating a response
                typingIndicator.classList.add('show');
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // send the message to backend 
                // user info and message in JSON format
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            intake: intake || '',
                            stream: stream || '',
                            year: year || '',
                            semester: semester || '',
                            message,
                            interest: interest || ''
                        })
                    });

                    const data = await response.json();

                    // if data is return from backend, ai is called to show message
                    if (data.success) {
                        addMessage(data.response, 'ai');
                    } else {
                        addMessage(`Sorry, I encountered an error: ${data.error}`, 'ai');
                    }
                } catch (error) {
                    addMessage('Sorry, I\'m having trouble connecting. Please try again.', 'ai');
                    console.error('Chat error:', error);
                } finally {
                    typingIndicator.classList.remove('show');
                    sendBtn.disabled = false;
                }
            }

            function addMessage(text, type) {
                // create different styling based on className
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                // create avatar, to show who send the message
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = type === 'user' ? 'üë§' : 'ü§ñ';

                const content = document.createElement('div');
                content.className = 'message-content';
                // Convert markdown-style bold (**text**) to HTML <strong> tags
                const formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                content.innerHTML = formattedText;

                // assemble the message and scroll to the bottom
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Event listeners
            sendBtn.addEventListener('click', sendMessage);

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-save when user changes any field
            ['username', 'intake', 'stream', 'year', 'semester', 'interest'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveUserInfoToCookies);
            });
        });
    </script>
</body>

</html>


#----------------------------app.py------------------------------------
from flask import Flask, request, jsonify, send_from_directory, abort
from flask_cors import CORS
from pathlib import Path
from scrape import get_info 
import google.generativeai as genai
import json
import os


from core_planner import PlannerForCore, UserInfo
from elective_planner import PlannerForElective
from pass_info import PreviousDetails
from update_result import UpdateResult
from update_units import ViewMenu
from chat import UnitAdvisorAI
from forum import ForumManager
from utilities import initialize_user 

import re

app = Flask(__name__, static_folder='static', static_url_path='')
vm = ViewMenu()
CORS(app)

# Initialize global UpdateResult instance
update_result = UpdateResult()


@app.route('/')
def index():
    """
    Send the 'index.html' file from the 'static' directory
    This allows Flask to serve the main frontend page when the user visits the root URL
    """
    return send_from_directory('static', 'main.html')

@app.route('/plan')
def plan_units():
    """
    Serve the Plan My Unit page (your existing index.html)
    """
    return send_from_directory('static', 'index.html')


@app.route('/results')
def enter_results():
    """
    Serve the Enter Results page
    """
    return send_from_directory('static', 'results.html')


@app.route('/update')
def update_units():
    """
    Serve the Update Units page
    """
    return send_from_directory('static', 'update.html')

@app.route('/chat')
def chat_page():
    """
    Serve the chat interface page
    """
    return send_from_directory('static', 'chat.html')

@app.route('/forum')
def forum_page():
    """
    Serve the forum interface page
    """
    return send_from_directory('static', 'forum.html')


@app.route('/api/check-unit-availability', methods=['POST'])
def check_unit_availability():
    """
    Check if a core unit is available this semester and if prerequisites are fulfilled.
    """
    import os, json

    try:
        data = request.json
        print("Received JSON:", data)

        if not data:
            return jsonify({'success': False, 'error': 'No JSON data received'}), 400

        # Extract inputs
        username = data.get('username')
        unit_code = data.get('unit_code')
        try:
            stream = int(data.get('stream', 0))
            year = int(data.get('year', 0))
            sem = int(data.get('semester', 0))
            intake = int(data.get('intake', 0))
        except (ValueError, TypeError):
            return jsonify({'success': False, 'error': 'Invalid numeric values'}), 400

        if not all([username, unit_code, stream, year, sem, intake]):
            return jsonify({'success': False, 'error': 'Missing required parameters'}), 400

        # Initialize user info
        user_info = UserInfo()
        user_info.user_basic_info_web(username, stream, year, sem, intake)

        # Load previous records
        update_result = UpdateResult()
        pass_info = PreviousDetails(user_info, update_result)
        completed_units = pass_info.saved_all_pass_unit()

        # Read core units directly from JSON
        json_path = os.path.join('user_info', username, 'core_units.json')
        if not os.path.exists(json_path):
            return jsonify({'success': False, 'error': 'core_units.json not found'}), 404

        with open(json_path, 'r') as f:
            core_units_all = json.load(f)

        # Determine current semester
        if intake == 2 and sem == 1:
            current_sem = 2
        elif intake == 2 and sem == 2:
            current_sem = 1
        elif intake == 1 and sem == 1:
            current_sem = 1
        elif intake == 1 and sem == 2:
            current_sem = 2
        else:
            current_sem = sem

        # Get unit info
        unit_info = core_units_all.get(unit_code)
        if not unit_info:
            return jsonify({'success': False, 'error': f'Unit {unit_code} not found'}), 404

        # Check semester availability
        sem_available_raw = unit_info.get('sem_available', '')
        sem_list = [int(s) for s in sem_available_raw.split(";") if s.strip().isdigit()]
        available_this_sem = current_sem in sem_list

        # Build prereq_dict same as start-planning
        prereq_dict = {u: info.get("prereq", "NONE") for u
        , info in core_units_all.items()}

        # Check if prerequisites are fulfilled
        planner_core = PlannerForCore(user_info, pass_info)
        prereq_fulfilled = planner_core.can_take_unit(unit_code, prereq_dict, completed_units)

        # Determine reason if cannot take
        reason = ""
        if not available_this_sem and not prereq_fulfilled:
            reason = "Not available this semester and prerequisites not met"
        elif not available_this_sem:
            reason = "Not available this semester"
        elif not prereq_fulfilled:
            reason = "Prerequisites not met"

        return jsonify({
            'success': True,
            'available_this_sem': available_this_sem,
            'prereq_fulfilled': prereq_fulfilled,
            'can_take': available_this_sem and prereq_fulfilled,
            'reason': reason,
            'unit_info': {
                'code': unit_code,
                'name': unit_info.get('unit_name', unit_code),
                'sem_available': sem_list,
                'prereq': unit_info.get('prereq', 'NONE')
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/start-planning', methods=['POST'])
def start_planning():
    """
    Receive user data from frontend and verify previous semester record 
    It will check if all the result is updated and return list of correct core units

    @returns 
    Java resposnse 
    - sucess (bool) - show whether planning process is sucessfull
    - core units (list) - list of core units
    - semester_name (str) - name of that semester (July or February)
    - current_sem (int) - current semester (1, 2)
    - error (str) - planning unsucessful 
    """
    try:
        data = request.get_json()
        print("Received data:", data)

        user_info, core_planner, elective_planner = initialize_user(data)
        print("initialize_user done")

        from pass_info import PreviousDetails
        from update_result import UpdateResult

        update_result = UpdateResult()
        pass_info = PreviousDetails(user_info, update_result)
        deferred_cores = get_deferred_cores(user_info)

        # Get semester alert message
        semester_name = ""
        if user_info.intake == 2 and user_info.sem == 1:
            semester_name = "July Semester"
            core_planner.current_sem = 2
        elif user_info.intake == 2 and user_info.sem == 2:
            semester_name = "February Semester"
            core_planner.current_sem = 1
        elif user_info.intake == 1 and user_info.sem == 1:
            semester_name = "February Semester"
            core_planner.current_sem = 1
        elif user_info.intake == 1 and user_info.sem == 2:
            semester_name = "July Semester"
            core_planner.current_sem = 2

        # Proceed if all good
        core_units_list = []
        for code in getattr(core_planner, 'filtered_core_list', []):
            unit_info = core_planner.filtered_core_units[code]
            
            # Get prerequisite fulfillment (reusing elective logic)
            prereq_dict = {u: info.get("prereq", "NONE") for u, info in core_planner.filtered_core_units.items()}
            prereq_fulfilled = core_planner.can_take_unit(code, prereq_dict, core_planner.pass_info.saved_all_pass_unit())
            
            core_units_list.append({
                'code': code,
                'name': unit_info['unit_name'],
                'description': unit_info['description'],
                'sem_available': unit_info['sem_available'],
                'prereq': unit_info['prereq'],
                'assign': unit_info['assign'],
                'test': unit_info['test'],
                'final': unit_info['final'],
                'prereq_fulfilled': prereq_fulfilled  
            })


        return jsonify({
            'success': True,
            'core_units': core_units_list,
            'semester_name': semester_name,
            'current_sem': core_planner.current_sem,
            'deferred_cores': deferred_cores  # Add this line
        })


    except Exception as e:
        import traceback
        print("ERROR:", e)
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500

    
@app.route('/api/core-unit-info', methods=['POST'])
def core_unit_info():
    """
    retrieve detailed information about a specific core units
    Receive username and unit code from the frontend and return detail information for the requested unit

    @returns
    JSON response:
    - sucess (bool): show if request is sucessful
    - unit (dict): information about reqeusted unit
    - error (str): error message indicating this does not work
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')

        if not username or not unit_code:
            return jsonify({'success': False, 'error': 'Missing username or unit_code'}), 400

        user_info = UserInfo()
        user_info.username = username

        planner = PlannerForCore(user_info, None)
        planner.read_core_unit() 
        unit_data = planner.get_unit_core_info(unit_code)

        if not unit_data:
            return jsonify({'success': False, 'error': 'Unit not found or core_units.json missing'}), 404

        return jsonify({'success': True, 'unit': unit_data})

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/get-electives', methods=['POST'])
def get_electives():
    """
    retrieve user information from frontend, generate a list of available elective units 
    filter the core unit and elective that are already chosen and check for semester and prereq

    @returns
    JSON response
    - success (bool): Whether the request was successful
    - electives (list): List of available elective units with details
    - elective_space (int): Number of elective slots available
    - current_chosen (int): Number of electives already selected
    - error (str): Error message if any issue occurs
    """
    try:
        data = request.json
        user_info, core_planner, elective_planner = initialize_user(data)

        # Build electives list while filtering core and unavailable units
        electives_list = []
        for unit_code, unit_info in elective_planner.all_electives_dict.items():
            is_core = unit_code in core_planner.core_units_all
            already_chosen = unit_code in elective_planner.final_elective
            available_sem = elective_planner.check_elective_available_sem(unit_code)
            prereq_fulfilled = elective_planner.check_elective_preq(unit_code)

            if is_core or already_chosen:
                continue  # skip core and already chosen units

            electives_list.append({
                'code': unit_code,
                'name': unit_info['unit_name'],
                'description': unit_info['description'],
                'level': int(unit_code[3]),
                'sem_available': unit_info['sem_available'],
                'prereq': unit_info['prereq'],
                'assign': unit_info['assign'],
                'test': unit_info['test'],
                'final': unit_info['final'],
                'available_this_sem': available_sem,
                'prereq_fulfilled': prereq_fulfilled,
                'approved': unit_info['approved_elective']
            })

        # Get deferred cores
        deferred_cores = get_deferred_cores(user_info)

        # Calculate elective space
        elective_space = elective_planner.elective_space()

        # Subtract deferred cores (they take up space)
        elective_space -= len(deferred_cores)

        if elective_space < 0:
            elective_space = 0

        current_chosen = elective_space

        return jsonify({
            'success': True,
            'electives': electives_list,
            'elective_space': elective_space,
            'current_chosen': current_chosen
        })

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/recommend-electives', methods=['POST'])
def recommend_electives():
    """
    recommend elective units based on the user's interests and study level
    initializes the user and planner objects, then uses a recommendation
    algorithm to suggest suitable elective units

    @returns 
    JSON response:
    - success (bool): Whether the recommendation process was successful.
    - recommendations (list): List of recommended elective units 
    """
    try:
        data = request.json
        username = data.get('username')
        level = int(data.get('level'))
        interest = data.get('interest')
        already_chosen = data.get('already_chosen', [])

        # Initialize user and planners
        user_info, core_planner, elective_planner = initialize_user(data)
        elective_planner.final_elective = already_chosen

        recommended = elective_planner.recommend_electives_smart(level, interest, num_reco=5)

        recommendations = []
        for unit_code in recommended:
            if unit_code in core_planner.core_units_all or unit_code in already_chosen:
                continue
            unit_info = elective_planner.all_electives_dict[unit_code]
            recommendations.append({
                'code': unit_code,
                'name': unit_info['unit_name'],
                'description': unit_info['description'],
                'level': int(unit_code[3])
            })

        return jsonify({'success': True, 'recommendations': recommendations})

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
    

@app.route('/api/elective-unit-info', methods=['POST'])
def elective_unit_info():
    """
    Show elective information in a nice format
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')

        if not username or not unit_code:
            return jsonify({'success': False, 'error': 'Missing username or unit_code'}), 400

        user_info = UserInfo()
        user_info.username = username

        core_planner = PlannerForCore(user_info, None)
        core_planner.read_core_unit()

        elective_planner = PlannerForElective(user_info, core_planner)
        elective_planner.read_elective()
        elective_planner.save_user_elective()

        # Use refactored display_elecive
        unit_data = elective_planner.get_unit_elective_info(unit_code)

        if 'error' in unit_data:
            return jsonify({'success': False, 'error': unit_data['error']}), 404

        return jsonify({'success': True, 'unit': unit_data})

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500

def get_deferred_cores(user_info):
    """
    Read all deferred units from deferred_units.json
    Only return units that are not already planned in any Y{year}S{sem}_units.json
    """
    deferred_path = Path(f"user_info/{user_info.username}/deferred_units.json")
    if not deferred_path.exists():
        return []

    with open(deferred_path, "r", encoding="utf-8") as f:
        deferred_data = json.load(f)

    user_folder = Path(f"user_info/{user_info.username}")
    planned_units = set()
    # Loop through all Y{year}S{sem}_units.json
    for file in user_folder.glob("Y*S*_units.json"):
        with open(file, "r", encoding="utf-8") as f:
            planned_units.update(json.load(f).keys())

    # Filter out deferred units that are already planned
    deferred_list = [
        {"code": code, "from_semester": sem_info}
        for code, sem_info in deferred_data.items()
        if code not in planned_units
    ]
    return deferred_list


@app.route('/api/save-plan', methods=['POST'])
def save_plan():
    """
    Save plan into two separate JSONs:
    - Y{year}S{sem}_units.json for planned units
    - deferred_units.json for all deferred units
    """
    try:
        data = request.json
        username = data.get('username')
        year = int(data.get('year'))
        sem = int(data.get('semester'))
        stream = int(data.get('stream'))  
        intake = int(data.get('intake')) 
        core_units = data.get('core_units', [])  # Selected cores
        deferred_cores = data.get('deferred_cores', [])  # Deferred cores
        electives = data.get('electives', [])

        # --- initialize user info ---
        user_info = UserInfo()
        user_info.username = username
        user_info.year = year
        user_info.sem = sem
        user_info.stream = stream  
        user_info.intake = intake  

        # --- pass info check ---
        pass_info = PreviousDetails(user_info, update_result)
        completed_units = pass_info.saved_all_pass_unit()

        # --- core planner ---
        core_planner = PlannerForCore(user_info, pass_info)
        core_planner.read_core_unit()  
        selected_core_codes = [u['code'] for u in core_units]
        core_planner.filtered_core_list = selected_core_codes

        # --- prerequisite check ---
        unmet_prereqs = core_planner.check_core_prereq()
        if unmet_prereqs:
            return jsonify({
                'success': False,
                'error': f"Cannot save. Prerequisites not met for: {', '.join(unmet_prereqs)}"
            }), 400

        # --- Save planned units into Y{year}S{sem}_units.json ---
        planner = PlannerForElective(user_info, core_planner)
        planner.final_unit_list_for_current_sem = selected_core_codes + [e['code'] for e in electives]
        planned_dict = {unit: "planned" for unit in planner.final_unit_list_for_current_sem}

        user_folder = Path(f"user_info/{username}")
        user_folder.mkdir(parents=True, exist_ok=True)
        planned_filename = user_folder / f"Y{year}S{sem}_units.json"

        with open(planned_filename, "w", encoding="utf-8") as f:
            json.dump(planned_dict, f, indent=4)

        # --- Save deferred units into deferred_units.json ---
        deferred_path = user_folder / "deferred_units.json"

        # Load old deferred data if exists
        if deferred_path.exists():
            with open(deferred_path, "r", encoding="utf-8") as f:
                deferred_data = json.load(f)
        else:
            deferred_data = {}

        # Add new deferred units with source semester info
        for d in deferred_cores:
            deferred_data[d] = f"Y{year}S{sem}"

        # Remove any deferred units that were reselected this semester
        for u in selected_core_codes:
            if u in deferred_data:
                deferred_data.pop(u)

        with open(deferred_path, "w", encoding="utf-8") as f:
            json.dump(deferred_data, f, indent=4)

        return jsonify({
            'success': True,
            'message': f'Plan saved for Y{year}S{sem}',
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500
    


@app.route('/api/get-results', methods=['POST'])
def get_results():
    """
    Retrieve all semester results for a user
    Returns all Y{year}S{sem}_units.json files
    """
    try:
        data = request.json
        username = data.get('username')
        
        if not username:
            return jsonify({'success': False, 'error': 'Username is required'}), 400
        
        user_folder = Path(f"user_info/{username}")
        
        if not user_folder.exists():
            return jsonify({'success': False, 'error': f'User {username} not found'}), 404
        
        results = {}
        
        # Find all semester files (Y1S1_units.json, Y1S2_units.json, etc.)
        for file in user_folder.glob("Y*S*_units.json"):
            # Extract semester name from filename (e.g., "Y1S1_units.json" -> "Y1S1")
            semester_name = file.stem.split('_')[0]
            
            with open(file, 'r', encoding='utf-8') as f:
                units = json.load(f)
                results[semester_name] = units
        
        return jsonify({
            'success': True,
            'results': results,
            'username': username
        })
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/save-results', methods=['POST'])
def save_results():
    """
    Save updated results back to the user's JSON files
    """
    try:
        data = request.json
        username = data.get('username')
        results = data.get('results')
        
        if not username or not results:
            return jsonify({'success': False, 'error': 'Username and results are required'}), 400
        
        user_folder = Path(f"user_info/{username}")
        
        if not user_folder.exists():
            return jsonify({'success': False, 'error': f'User {username} not found'}), 404
        
        # Save each semester's results
        for semester, units in results.items():
            file_path = user_folder / f"{semester}_units.json"
            
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(units, f, indent=4)
        
        return jsonify({
            'success': True,
            'message': f'Results saved for {len(results)} semester(s)'
        })
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/view')
def view_plans():
    """
    Serve the View Saved Plans page or generate the course PNG
    Automatically reads the username from cookie set in /result
    """
    username = request.cookies.get("username")  #read from cookie

    if not username:
        return "Username not found. Please load results first.", 400

    user_folder = Path("user_info") / username
    if not user_folder.exists():
        return f"No data found for user {username}", 404

    # Generate PNG using ViewMenu
    vm = ViewMenu()
    vm.visualize_user_course(username)

    output_file = f"{username}_course_structure.png"
    return send_from_directory(user_folder, output_file)


@app.route('/api/update-unit', methods=['POST'])
def update_unit():
    """
    Update unit information by scraping Monash Handbook
    Uses the get_info function from scrape.py
    USe sem_extraction() and workload_extraction() for proper formatting
    """
    try:
        data = request.json
        username = data.get('username')
        intake_year = data.get('intake_year')
        unit_code = data.get('unit_code', '').strip().upper()

        if not all([username, intake_year, unit_code]):
            return jsonify({
                'success': False,
                'error': 'Missing required fields: username, intake_year, or unit_code'
            }), 400

        # Check if user exists
        user_folder = Path(f"user_info/{username}")
        if not user_folder.exists():
            return jsonify({
                'success': False,
                'error': f'User {username} not found. Please complete unit planning first.'
            }), 404

        # Scrape unit info from Monash Handbook
        unit_name, semesters_str, assign, test, final = get_info(intake_year, unit_code)

        if unit_name is None:
            return jsonify({
                'success': False,
                'error': f'Unit {unit_code} not found in {intake_year} handbook. Please check the unit code and year.'
            }), 404

        # Format semester information inline
        # Converts "1;2" ‚Üí ["February Semester", "July Semester"]
        semesters_list = []
        if semesters_str and semesters_str.strip().upper() != "NONE":
            for sem in semesters_str.split(";"):
                sem = sem.strip()
                if sem == "1":
                    semesters_list.append("February Semester")
                elif sem == "2":
                    semesters_list.append("July Semester")
        
        # Format workload using workload_extraction()
        # Converts "20;30", "10", "60" -> {"assign": "20%, 30%", "test": "10%", "final": "60%"}
        try:
            user_info_temp = UserInfo()
            user_info_temp.username = username
            temp_planner = PlannerForCore(user_info_temp, None)
            workload = temp_planner.workload_extraction(assign, test, final)
        except Exception:
            # Fallback if extraction fails
            workload = {
                'assign': assign or 'None',
                'test': test or 'None',
                'final': final or 'None'
            }

        # Load user's core and elective units
        core_file = user_folder / "core_units.json"
        elective_file = user_folder / "elective_units.json"

        updated = False
        updated_location = None

        # Try updating core units
        if core_file.exists():
            with open(core_file, 'r', encoding='utf-8') as f:
                core_units_data = json.load(f)

            if unit_code in core_units_data:
                core_units_data[unit_code].update({
                    "unit_name": unit_name,
                    "sem_available": semesters_str,  
                    "assign": assign,                 
                    "test": test,                     
                    "final": final                    
                })
                
                with open(core_file, 'w', encoding='utf-8') as f:
                    json.dump(core_units_data, f, indent=4)
                
                updated = True
                updated_location = "core_units.json"

        # Try updating elective units
        if not updated and elective_file.exists():
            with open(elective_file, 'r', encoding='utf-8') as f:
                elective_units_data = json.load(f)

            if unit_code in elective_units_data:
                elective_units_data[unit_code].update({
                    "unit_name": unit_name,
                    "sem_available": semesters_str,  
                    "assign": assign,                 
                    "test": test,                     
                    "final": final                    
                })
                
                with open(elective_file, 'w', encoding='utf-8') as f:
                    json.dump(elective_units_data, f, indent=4)
                
                updated = True
                updated_location = "elective_units.json"

        if not updated:
            return jsonify({
                'success': False,
                'error': f'{unit_code} not found in your core or elective units. You may need to add it to your course plan first.'
            }), 404

        #Return formatted info for display (not for storage)
        return jsonify({
            'success': True,
            'message': f'Unit {unit_code} updated successfully',
            'updated_file': updated_location,
            'unit_info': {
                'code': unit_code,
                'name': unit_name,
                'semesters': semesters_str,         
                'semesters_list': semesters_list,     
                'assign': workload['assign'],        
                'test': workload['test'],             
                'final': workload['final']            
            }
        })

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Server error: {str(e)}'
        }), 500


# Configure Gemini API
GEMINI_API_KEY = 'ENTER YOU OWN API KEY'
genai.configure(api_key=GEMINI_API_KEY)

## Initialize the advisor instance
advisor = UnitAdvisorAI(api_key=GEMINI_API_KEY)

@app.route('/api/chat', methods=['POST'])
def chat():
    """
    Handle chat messages and route them to UnitAdvisorAI.
    Supports multiple conversation intents:
    recommendation, workload, comparison, readiness analysis, etc.
    """
    try:
        data = request.get_json()

        # === User Metadata ===
        username = data.get('username')
        intake = data.get('intake')
        stream = data.get('stream')
        year = data.get('year')
        semester = data.get('semester')
        interest = data.get('interest', '')

        # === User Message ===
        message = data.get('message', '').strip().lower()

        if not username or not message:
            return jsonify({'success': False, 'error': 'Missing username or message'}), 400

        response = None

        # === Unit Recommendations ===
        if any(word in message.lower() for word in ['recommend', 'suggest', 'choose']):
            interest_to_use = interest if interest else message.replace('recommend', '').replace('suggest', '').strip()
            if not interest_to_use:
                response = "üí° Please specify what you're interested in (e.g., 'recommend data-related units')."
            else:
                response = advisor.recommend_units(
                    username=username,
                    intake=intake,
                    stream=stream,
                    year=year,
                    semester=semester,
                    interest=interest_to_use
                )

        # === Workload / Difficulty Check ===
        elif any(keyword in message.lower() for keyword in ['workload', 'difficulty']):
            planned_units = advisor.load_planned_units(username, year, semester)
            if not planned_units:
                response = f"‚ö†Ô∏è No planned units found for Y{year}S{semester}. Please ensure you've added them first."
            else:
                response = advisor.show_workload(username, year, semester, planned_units)

        # === Show Current Plan ===
        elif any(keyword in message.lower() for keyword in ['current plan', 'taken', 'my units', 'show plan']):
            response = advisor.show_all_semesters_with_info(username)

        # === Intent 4: Compare Units ===
        elif 'compare' in message:
            unit_codes = re.findall(r'FIT\d{4}', message.upper())
            if len(unit_codes) >= 2:
                response = advisor.compare_unit_readiness(
                    username=username,
                    unit_codes=unit_codes,
                    year=year,
                    semester=semester,
                    stream=stream,
                    intake=intake,
                    interest=interest
                )
            else:
                response = "To compare units, type something like: 'compare FIT2004 and FIT3155'."

        # === Single Unit Readiness Deep Dive ===
        elif any(word in message.lower() for word in ['can i take', 'should i add', 'should i take', 'hard', 'can i add', 'detail', 'details']):
            unit_codes = re.findall(r'FIT\d{4}', message.upper())
            if unit_codes:
                unit_code = unit_codes[0]
                
                # Check if this is an "add unit" scenario
                is_adding = any(phrase in message.lower() for phrase in ['add'])
                
                if is_adding:
                    # User wants to know: "Should I ADD FIT3143 to my semester?"
                    response = advisor.analyze_adding_unit(
                        username=username,
                        new_unit_code=unit_code,
                        year=year,
                        semester=semester,
                        stream=stream,
                        intake=intake
                    )
                else:
                    # User wants to know:
                    response = advisor.analyze_unit_readiness_single(
                        username=username,
                        unit_code=unit_code,
                        year=year,
                        semester=semester,
                        stream=stream,
                        intake=intake
                    )
            else:
                response = "Please include a unit code (e.g., 'can I take FIT3155?' or 'should I add FIT3143?')."

        # === Semester Readiness (Full Semester Overview) ===
        elif any(phrase in message.lower() for phrase in ['analyze', 'analysis', 'analyze semester', 'review', 'am i ready', 'semester readiness']):
            response = advisor.analyze_semester_readiness(
                username=username,
                year=year,
                semester=semester,
                stream=stream,
                intake=intake
            )

        # === Sentiment / Feedback Summary ===
        elif any(word in message.lower() for word in ['feedback', 'others', 'opinions', 'community']):
            unit_codes = re.findall(r'FIT\d{4}', message.upper())
            if unit_codes:
                response = advisor.summarize_unit_sentiment(unit_codes[0])
            else:
                response = "Please include a unit code (e.g., 'show feedback for FIT1047')."

        # === Resource / Study Advice ===
        elif any(word in message.lower() for word in ['resource', 'material', 'study help', 'guide', 'overview']):
            unit_codes = re.findall(r'FIT\d{4}', message.upper())
            if unit_codes:
                response = advisor.summarize_unit_overview(username, unit_codes[0])
            else:
                response = "Please include a unit code (e.g., 'show resources for FIT1008')."

        # === General AI Help / Planning ===
        else:
            all_units = advisor.load_all_units(username)
            matched = False
            for code, info in all_units.items():
                if code.lower() in message:
                    response = advisor.ask_ai_about_unit(code, info, message)
                    matched = True
                    break
            if not matched:
                if any(phrase in message.lower() for phrase in [
                    'plan semester', 'plan my', 'should i take',
                    'what units should', 'which units should', 'help me choose'
                ]):
                    response = "üß≠ To get personalized planning help, please type 'recommend units for me' and specify your interest!"
                else:
                    response = advisor.general_advice(username, message, interest=interest)

        return jsonify({'success': True, 'response': response})

    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500
    
@app.route('/api/forum/units', methods=['POST'])
def get_forum_units():
    """
    Get all available units for the forum
    """
    try:
        data = request.json
        username = data.get('username')
        
        if not username:
            return jsonify({'success': False, 'error': 'Username is required'}), 400
        
        forum_manager = ForumManager(username)
        all_units = forum_manager.load_all_units()
        
        # Get discussion stats for each unit
        units_with_stats = []
        for code, info in all_units.items():
            stats = forum_manager.get_discussion_stats(code)
            units_with_stats.append({
                'code': code,
                'name': info['name'],
                'description': info['description'],
                'type': info['type'],
                'discussion_count': {
                    'general': stats['general'],
                    'resources': stats['resources'],
                    'private': stats['private']
                }
            })
        
        return jsonify({
            'success': True,
            'units': units_with_stats
        })
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/forum/discussions', methods=['POST'])
def get_discussions():
    """
    Get discussions for a specific unit and tag
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')
        tag = data.get('tag')
        
        if not all([username, unit_code, tag]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400
        
        if tag not in ['general', 'resources', 'private']:
            return jsonify({'success': False, 'error': 'Invalid tag'}), 400
        
        forum_manager = ForumManager(username)
        
        # Check access permission for private discussions
        if tag == 'private':
            # For private, we need to check if this is the user's own private section
            if username != data.get('request_username', username):
                return jsonify({
                    'success': False, 
                    'error': 'Access denied: Private discussions are only visible to the owner'
                }), 403
        
        discussions = forum_manager.get_unit_discussions(unit_code, tag)
        
        return jsonify({
            'success': True,
            'discussions': discussions,
            'unit_code': unit_code,
            'tag': tag
        })
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/forum/add-discussion', methods=['POST'])
def add_discussion():
    """
    Create a new discussion thread
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')
        tag = data.get('tag')
        title = data.get('title')
        content = data.get('content')
        
        if not all([username, unit_code, tag, title, content]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400
        
        if tag not in ['general', 'resources', 'private']:
            return jsonify({'success': False, 'error': 'Invalid tag'}), 400
        
        forum_manager = ForumManager(username)
        result = forum_manager.add_discussion(unit_code, tag, title, content)
        
        return jsonify(result)
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/forum/add-reply', methods=['POST'])
def add_reply():
    """
    Add a reply to an existing discussion
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')
        tag = data.get('tag')
        discussion_id = data.get('discussion_id')
        content = data.get('content')
        
        if not all([username, unit_code, tag, discussion_id, content]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400
        
        if tag not in ['general', 'resources', 'private']:
            return jsonify({'success': False, 'error': 'Invalid tag'}), 400
        
        forum_manager = ForumManager(username)
        result = forum_manager.add_reply(unit_code, tag, discussion_id, content)
        
        return jsonify(result)
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


@app.route('/api/forum/delete-discussion', methods=['POST'])
def delete_discussion():
    """
    Delete a discussion (only by creator)
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')
        tag = data.get('tag')
        discussion_id = data.get('discussion_id')
        
        if not all([username, unit_code, tag, discussion_id]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400
        
        forum_manager = ForumManager(username)
        result = forum_manager.delete_discussion(unit_code, tag, discussion_id)
        
        return jsonify(result)
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500

    
@app.route('/api/forum/toggle-like', methods=['POST'])
def toggle_like():
    """
    Toggle like on a discussion
    """
    try:
        data = request.json
        username = data.get('username')
        unit_code = data.get('unit_code')
        tag = data.get('tag')
        discussion_id = data.get('discussion_id')
        
        if not all([username, unit_code, tag, discussion_id]):
            return jsonify({'success': False, 'error': 'Missing required fields'}), 400
        
        forum_manager = ForumManager(username)
        result = forum_manager.toggle_like(unit_code, tag, discussion_id, username)
        
        return jsonify(result)
    
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500


if __name__ == '__main__':
    os.makedirs('static', exist_ok=True)
    app.run(debug=True, port=5001)

#---------------------------chat.py--------------------------------
from utilities import initialize_user  
from sentiment_analyzer import SentimentDifficultyAnalyzer
from resources_rec import SimpleResourceRecommender
from performance import SemesterReadinessAnalyzer 
import google.generativeai as genai
import os, json

class UnitAdvisorAI:
    def __init__(self, api_key):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-2.5-flash-lite')
        self.os = os
        self.json = json

    def load_unit_data(self, username, unit_code):
        """Load data for a specific unit"""
        core_path = f"user_info/{username}/core_units.json"
        elective_path = f"user_info/{username}/elective_units.json"

        for path in [core_path, elective_path]:
            if self.os.path.exists(path):
                with open(path, 'r') as f:
                    data = self.json.load(f)
                    if unit_code in data:
                        return data[unit_code]
        return None
    
    def load_core_units(self, username):
        """Load core units"""
        core_units = {}
        elective_path = f"user_info/{username}/core_units.json"
        if self.os.path.exists(elective_path):
            with open(elective_path, 'r') as f:
                core_units.update(self.json.load(f))
        return core_units

    def load_elective_units(self, username):
        """Load elective units, excluding any that are already in core units"""
        elective_units = {}
        elective_path = f"user_info/{username}/elective_units.json"
        core_units = self.load_core_units(username)

        if self.os.path.exists(elective_path):
            with open(elective_path, 'r') as f:
                all_electives = self.json.load(f)
                for code, data in all_electives.items():
                    if code not in core_units:
                        elective_units[code] = data
        return elective_units

    def load_all_units(self, username):
        """Load all available units"""
        all_units = {}
        core_path = f"user_info/{username}/core_units.json"
        elective_path = f"user_info/{username}/elective_units.json"

        if self.os.path.exists(core_path):
            with open(core_path, 'r') as f:
                all_units.update(self.json.load(f))
        if self.os.path.exists(elective_path):
            with open(elective_path, 'r') as f:
                all_units.update(self.json.load(f))
        return all_units

    def load_planned_units(self, username, year, semester):
        """Load planned units for a specific semester"""
        planned_path = f"user_info/{username}/Y{year}S{semester}_units.json"
        if self.os.path.exists(planned_path):
            with open(planned_path, 'r') as f:
                return self.json.load(f)
        return {}
    
    def recommend_units(self, username, intake, stream, year, semester, interest):
        """
        @param username, intake, stream, year, semester - basic information of user 
        @param user interest
        Recommend elective by providng Gemini a list of correct list of available elective and interest of user

        The final list only contain elective that is 
        - not a core and havent been chosen as a elective
        - available that sem 
        - pass the prerequiste

        Then prompt the AI to explain why it matches the interest
        @returns final response and fhe final recommendation with the reason
        """
        data = {
            'username': username,
            'intake': intake,
            'stream': stream,
            'year': year,
            'semester': semester
        }
        
        #initialize user to load all information 
        user_info, core_planner, elective_planner = initialize_user(data)
        all_units = elective_planner.all_electives_dict
        if not all_units:
            return "I couldn't find any available elective units for your profile."

        #check if user mention about any level
        level_requested = None
        for lvl in ['1', '2', '3']:
            if f"level {lvl}" in interest.lower() or f"year {lvl}" in interest.lower():
                level_requested = lvl
                break
        
        #filter the units
        #only return if unit is not a core / havent chose / pass prerequisite / is available that sem 
        available_units = {}
        for code, data in all_units.items():
            if code in core_planner.core_units_all or code in elective_planner.final_elective:
                continue
            if level_requested and code[3] != level_requested:
                continue
            if not elective_planner.check_elective_preq(code):
                continue
            if not elective_planner.check_elective_available_sem(code):
                continue
            available_units[code] = data

        if not available_units:
            return "None of the electives are currently available based on your prerequisites and semester offering."

        #format as as string that list unit code, name and description
        units_list = "\n".join([
            f"- {code}: {data['unit_name']} - {data['description']}"
            for code, data in available_units.items()
        ])

        prompt = f"""You are a helpful course advisor for Monash students.

        The student is interested in: "{interest}"

        Below are the electives that are AVAILABLE and meet prerequisite/semester conditions:
        {units_list}

        Recommend 3‚Äì5 electives that best match the student's interest.
        For each elective, include:
        1. Unit code and name (exactly as listed)
        2. A short explanation (1‚Äì2 sentences) of why it suits their interest.
        IMPORTANT: Only recommend from the list above. Do not invent new units."""

        response = self.model.generate_content(prompt)
        return f"The following electives are suitable and available:\n\n{response.text.strip()}"
    
    def calculate_workload(self, username, planned_units):
        """
        @param username to get the corrct database
        @param planned_unit get the units that user have planned
        Calculate workload based on planned units

        Initialize the count of assignment test and final as 0 and add 1 if its does not show as NONE
        @returns dictionary contain total count
        """
        # Initialize the counter 
        total_assignments = 0
        total_tests = 0
        total_final = 0
        unit_count = len(planned_units)
        workload_details = []

        # loop through plan unit and get the unit detials
        # count the assignment, test and finals
        for unit_code in planned_units.keys():
            unit_data = self.load_unit_data(username, unit_code)
            if unit_data:
                assign = unit_data.get('assign', 'NONE')
                test = unit_data.get('test', 'NONE')
                final = unit_data.get('final', '0')

                if assign != 'NONE':
                    total_assignments += len(assign.split(';'))
                if test != 'NONE':
                    total_tests += len(test.split(';'))
                if final != 'NONE':
                    total_final += 1

                workload_details.append({
                    'code': unit_code,
                    'name': unit_data['unit_name'],
                    'assign': assign,
                    'test': test,
                    'final': final
                })

        # return the information in a dictionary
        return {
            'unit_count': unit_count,
            'total_assignments': total_assignments,
            'total_tests': total_tests,
            'total_finals': total_final,
            'details': workload_details
        }

    def check_workload_heavy(self, workload):
        """Check if workload is too heavy"""
        warnings = []
        if workload['total_assignments'] >= 12:
            warnings.append(f"{workload['total_assignments']} total assignments might be overwhelming")
        if workload['total_tests'] >= 6:
            warnings.append(f"{workload['total_tests']} tests/quizzes is very demanding")
        if workload['total_finals'] >= 3:
            warnings.append(f"{workload['total_finals']} final exams during exam period is tough")
        return warnings

    def format_workload_breakdown(self, workload):
        """Nicely format workload with each assessment on its own line"""
        lines = []
        for detail in workload['details']:
            lines.append(f"{detail['code']} - {detail['name']}")
            
            assign = detail['assign']
            if assign != 'NONE':
                for i, a in enumerate(assign.split(';'), 1):
                    lines.append(f"   ‚Ä¢ Assignment {i}: {a}%")
            
            test = detail['test']
            if test != 'NONE':
                for i, t in enumerate(test.split(';'), 1):
                    lines.append(f"   ‚Ä¢ Test {i}: {t}%")
            
            final = detail['final']
            if final != 'NONE' and final != '0':
                lines.append(f"   ‚Ä¢ Final Exam: {final}%")
            
            lines.append("")
        return "\n".join(lines)
    
    def show_workload(self, username, year, semester, planned_units):
        """
        return message in a string to be output directly 
        """
        workload = self.calculate_workload(username, planned_units)
        warnings = self.check_workload_heavy(workload)
        breakdown = self.format_workload_breakdown(workload)
        response = (
            f"üìä **Workload Summary ‚Äî Y{year}S{semester}**\n\n"
            f"- Total Units: {workload['unit_count']}\n"
            f"- Assignments: {workload['total_assignments']}\n"
            f"- Tests: {workload['total_tests']}\n"
            f"- Finals: {workload['total_finals']}\n\n"
            f"üìã **Breakdown:**\n{breakdown}\n"
        )
        response += "\n‚ö†Ô∏è " + "\n‚ö†Ô∏è ".join(warnings) if warnings else "\n‚úÖ Looks manageable!"
        return response
    
    def show_all_semesters_with_info(self, username):
        """
        Load all the units and save all the available planner in a list
        Loop throught the list and to get the information using the all units dictionary 

        @param username to get the correct database
        @return unit code and unit name of all plans
        """
        user_folder = f"user_info/{username}"
        if not self.os.path.exists(user_folder):
            return f"User {username} not found."

        all_units = self.load_all_units(username)
        if not all_units:
            return f"No core/elective units found for {username}."

        sem_files = [f for f in self.os.listdir(user_folder) if f.startswith("Y") and f.endswith("_units.json")]
        if not sem_files:
            return "No semester unit files found."

        sem_files.sort()
        output_lines = []
        for sem_file in sem_files:
            sem_path = self.os.path.join(user_folder, sem_file)
            with open(sem_path, 'r') as f:
                semester_units = self.json.load(f)

            semester_name = sem_file.replace("_units.json", "")
            output_lines.append(f"üìò {semester_name} Units:")
            for code, status in semester_units.items():
                unit_data = all_units.get(code)
                if unit_data:
                    output_lines.append(f"   - {code}: {unit_data['unit_name']}")
                else:
                    output_lines.append(f"   - {code}: Unknown Unit")
            output_lines.append("")

        return "\n".join(output_lines)

    def summarize_unit_sentiment(self, unit_code):
        """
        @param unit_code 
        
        Generate detailed AI summary using student quotes from sentiment analysis
        @return generated content of reason 
        """
        try:
            analyzer = SentimentDifficultyAnalyzer()
            analysis = analyzer.analyze_unit(unit_code)
        except Exception as e:
            return f"Sorry, I couldn't analyze feedback for {unit_code}. ({e})"
        
        if analysis['status'] == 'no_data':
            return f"No community feedback available for {unit_code} yet."
        
        easy_examples = "\n".join([
            f"- \"{reason['reason']}\"" 
            for reason in analysis['easy_reasons'][:3]
        ]) if analysis['easy_reasons'] else "None mentioned"
        
        hard_examples = "\n".join([
            f"- \"{reason['reason']}\"" 
            for reason in analysis['hard_reasons'][:3]
        ]) if analysis['hard_reasons'] else "None mentioned"
        
        pain_details = "\n".join([
            f"- {p['category'].title()}: {p['count']} mentions (e.g., \"{p['example']}\")"
            for p in analysis['pain_points'][:3]
        ]) if analysis['pain_points'] else "No specific pain points identified"
        
        prompt = f"""You are a university advisor helping students understand community feedback for {unit_code}.

        DIFFICULTY METRICS:
        - Difficulty Score: {analysis['difficulty_score']}/100
        - Students Struggling: {analysis['struggling_percent']}
        - Overall Sentiment: {analysis['dominant_opinion']}
        - Total Comments Analyzed: {analysis['total_comments']}

        WHY STUDENTS FIND IT EASY:
        {easy_examples}

        WHY STUDENTS FIND IT HARD:
        {hard_examples}

        COMMON PAIN POINTS:
        {pain_details}

        TASK: Write a 4-5 sentence summary that:
        1. You are talking to that student only not everyone
        2. Gives an honest assessment of difficulty based on actual student experiences
        3. Highlights the main challenges students face (use their words)
        4. Mentions any reasons why some find it manageable
        5. Ends with actionable advice or perspective

        Be conversational, specific, and helpful. Use the actual student quotes to support your points."""
                
        response = self.model.generate_content(prompt)
        return response.text.strip()
    
       
    def get_unit_info(self, username, unit_code):
        """Fetch unit's info."""
        all_units = self.load_all_units(username)
        return all_units.get(unit_code)
    
    def summarize_unit_overview(self, username, unit_code):
        """Introduce the unit the unit with practical advice."""
        try:
            unit_data = self.get_unit_info(username, unit_code)
            if not unit_data:
                return f"No details available for {unit_code}."

            recommender = SimpleResourceRecommender()
            top_resources = recommender.recommend(unit_code)
        except Exception as e:
            return f"Sorry, something went wrong while generating advice for {unit_code}. ({e})"

        prompt = f"""You are a helpful university advisor introducing a student to {unit_code}.

        Unit Code: {unit_code}
        Unit Name: {unit_data.get('unit_name', 'N/A')}
        Description: {unit_data.get('description', 'No description available.')}

        Recommended Resources (from student community):
        {top_resources}

        TASK: Write a 4-5 sentence advisory summary that:
        1. Briefly introduces what the unit covers.
        2. Mentions useful learning resources or study materials from the list above.
        3. Offers practical advice on how students can prepare or study effectively.
        4. Keep the tone friendly, supportive, and encouraging ‚Äî no need to discuss challenges or difficulties."""

        response = self.model.generate_content(prompt)
        return response.text.strip()
    
    def analyze_unit_readiness_single(self, username, unit_code, year, semester, stream, intake):
        """
        Deep-dive analysis for a single unit with AI-enhanced advice.
        """
        # Load planned units to calculate workload context
        planned_units_dict = self.load_planned_units(username, year, semester)
        planned_units = list(planned_units_dict.keys()) if planned_units_dict else []
        
        # Initialize analyzer
        analyzer = SemesterReadinessAnalyzer(username)
        
        # Analyze the unit
        result = analyzer.analyze_unit_readiness(
            username=username,
            unit_code=unit_code,
            current_year=year,
            current_sem=semester,
            stream=stream,
            intake=intake,
            planned_units=planned_units
        )
        
        if 'error' in result:
            return result['error']
        
        #generate the content based on result
        return self._generate_ai_unit_deep_dive(result)
    
    def _generate_ai_unit_deep_dive(self, result):
        """Generate detailed AI analysis for a single unit"""
        
        unit_code = result['unit_code']
        unit_name = result['unit_name']
        score = result['readiness_score']
        prereq = result['prerequisites']
        community = result['community_feedback']
        workload = result['workload']
        recommendations = result['recommendations']
        
        # Build detailed context
        prompt = f"""You are a university advisor conducting a detailed readiness assessment for {unit_code}.

        UNIT: {unit_code} - {unit_name}
        OVERALL READINESS SCORE: {score}/100

        PREREQUISITE ANALYSIS:
        - Fulfilled: {'Yes ‚úÖ' if prereq['fulfilled'] else 'No ‚ùå'}
        - Strength: {prereq['strength']}/100
        - Details: {prereq['details'] if prereq['details'] else 'No prerequisite grades on record'}

        COMMUNITY FEEDBACK:
        - Difficulty Rating: {community['difficulty_score']}/100
        - Students Struggling: {community['struggling_percent']}
        - Common Pain Points: {', '.join([p['category'] for p in community['pain_points']]) if community['pain_points'] else 'None reported'}

        WORKLOAD CONTEXT:
        - Total Units This Semester: {workload['total_units']}
        - Total Assignments: {workload['total_assignments']}
        - Total Tests: {workload['total_tests']}
        - Workload Status: {workload['status'].title()}

        AUTOMATED RECOMMENDATIONS:
        {chr(10).join(['‚Ä¢ ' + r for r in recommendations])}

        TASK: Write a detailed 8-10 sentence advisory that:
        1. Opens with a clear verdict on readiness (e.g., "You're well-prepared for {unit_code}" or "I have concerns about your readiness for {unit_code}")
        2. Explains WHY based on prerequisite performance and community data
        3. Addresses the specific pain points students commonly face in this unit
        4. Discusses how this unit fits into their overall semester workload
        5. Provides 3-4 CONCRETE action items (e.g., "Review recursion concepts from FIT2004 in Week 1-2" or "Allocate 12-15 hours/week for this unit")
        6. Ends with realistic expectations and encouragement

        Be specific, actionable, and honest. Reference actual course concepts where possible based on the pain points."""

        response = self.model.generate_content(prompt)
        
        # Add structured data footer
        footer = f"\n\nüìã **Key Metrics:**"
        footer += f"\n‚Ä¢ Readiness Score: {score}/100"
        footer += f"\n‚Ä¢ Prerequisites: {'‚úÖ Met' if prereq['fulfilled'] else '‚ùå Not Met'} ({prereq['strength']}% strength)"
        footer += f"\n‚Ä¢ Community Difficulty: {community['difficulty_score']}/100"
        footer += f"\n‚Ä¢ Semester Workload: {workload['total_assignments']} assignments, {workload['total_tests']} tests"
        
        return response.text.strip() + footer
    
       
    def analyze_adding_unit(self, username, new_unit_code, year, semester, stream, intake):
        """
        Analyze the impact of ADDING a new unit to an existing semester plan.
        Shows before/after workload comparison.
        """
        from pathlib import Path
        
        # Load existing semester plan
        sem_file = Path(f"user_info/{username}/Y{year}S{semester}_units.json")
        
        if not sem_file.exists():
            return f"‚ùå No semester plan found for Y{year}S{semester}. Please create it first."
        
        with open(sem_file, 'r') as f:
            existing_semester = self.json.load(f)
            existing_units = list(existing_semester.keys())
        
        # Check if unit is already in the plan
        if new_unit_code in existing_units:
            return f"‚ö†Ô∏è {new_unit_code} is already in your Y{year}S{semester} plan!"
        
        # Analyze readiness WITH the new unit added
        analyzer = SemesterReadinessAnalyzer(username)
        result = analyzer.analyze_unit_readiness(
            username=username,
            unit_code=new_unit_code,
            current_year=year,
            current_sem=semester,
            stream=stream,
            intake=intake,
            planned_units=existing_units  # Pass WITHOUT the new unit
        )
        
        if 'error' in result:
            return f"‚ùå {result['error']}"
        
        # Extract data
        workload = result['workload']
        score = result['readiness_score']
        prereqs = result['prerequisites']
        community = result['community_feedback']
        recommendations = result['recommendations']
        
        # Build AI-enhanced response
        return self._generate_ai_adding_unit_response(
            new_unit_code, 
            result, 
            existing_units
        )

    def _generate_ai_adding_unit_response(self, unit_code, result, existing_units):
        """Generate AI analysis for adding a unit to existing semester"""
        
        workload = result['workload']
        score = result['readiness_score']
        prereqs = result['prerequisites']
        community = result['community_feedback']
        recommendations = result['recommendations']
        
        prompt = f"""You are a university advisor helping a student decide whether to ADD {unit_code} to their existing semester.

        CURRENT SEMESTER PLAN: {', '.join(existing_units)} ({len(existing_units)} units)

        PROPOSED ADDITION: {unit_code} - {result['unit_name']}

        READINESS SCORE: {score}/100

        PREREQUISITES:
        - Met: {'Yes ‚úÖ' if prereqs['fulfilled'] else 'No ‚ùå'}
        - Strength: {prereqs['strength']}/100
        - Details: {prereqs['details']}

        WORKLOAD IMPACT:
        - Before Adding: {workload['base_assignments']} assignments, {workload['base_tests']} tests
        - After Adding: {workload['total_assignments']} assignments, {workload['total_tests']} tests
        - This Unit Adds: +{workload['new_unit_adds']['assignments']} assignments, +{workload['new_unit_adds']['tests']} tests
        - New Status: {workload['status'].title()}

        COMMUNITY FEEDBACK:
        - Difficulty: {community['difficulty_score']}/100
        - Struggling: {community['struggling_percent']}

        AUTOMATED ADVICE:
        {chr(10).join(['‚Ä¢ ' + r for r in recommendations])}

        TASK: Write a 6-7 sentence advisory that:
        1. Opens with clear verdict: "I recommend adding {unit_code}" or "I advise against adding {unit_code}"
        2. Explains WHY based on readiness score and workload impact
        3. Discusses the specific workload increase (be specific about the +X assignments/tests)
        4. Addresses prerequisite readiness concerns if any
        5. Mentions if this creates an overwhelming vs manageable semester
        6. Provides 2-3 specific action items if they decide to add it
        7. Ends with a clear recommendation (add now, add later, or skip)

        Be direct, honest, and practical. Help them make a confident decision."""

        response = self.model.generate_content(prompt)
        
        # Add structured metrics
        footer = f"\n\nüìä **Impact Summary:**"
        footer += f"\n‚Ä¢ Readiness: {score}/100 ({'‚úÖ Ready' if score >= 75 else '‚ö†Ô∏è Moderate' if score >= 50 else '‚ùå Not Ready'})"
        footer += f"\n‚Ä¢ Prerequisites: {'‚úÖ Met' if prereqs['fulfilled'] else '‚ùå Not Met'} ({prereqs['strength']}% strength)"
        footer += f"\n‚Ä¢ Workload Before: {workload['base_assignments']} assignments, {workload['base_tests']} tests"
        footer += f"\n‚Ä¢ Workload After: {workload['total_assignments']} assignments, {workload['total_tests']} tests"
        footer += f"\n‚Ä¢ Impact: +{workload['new_unit_adds']['assignments']} assignments, +{workload['new_unit_adds']['tests']} tests"
        footer += f"\n‚Ä¢ New Semester Status: {workload['status'].title()}"
        
        return response.text.strip() + footer
    
    def analyze_semester_readiness(self, username, year, semester, stream, intake):
        """
        Analyze readiness for all units in a planned semester.
        Returns AI-enhanced summary with actionable advice.
        """
        # Load planned units
        planned_units_dict = self.load_planned_units(username, year, semester)
        if not planned_units_dict:
            return f"No units found for Y{year}S{semester}. Have you planned this semester yet?"
        
        planned_units = list(planned_units_dict.keys())
        
        # Initialize analyzer
        analyzer = SemesterReadinessAnalyzer(username)
        
        # Analyze each unit
        results = {}
        for unit_code in planned_units:
            result = analyzer.analyze_unit_readiness(
                username=username,
                unit_code=unit_code,
                current_year=year,
                current_sem=semester,
                stream=stream,
                intake=intake,
                planned_units=planned_units
            )
            results[unit_code] = result

        return self._generate_ai_semester_summary(results, year, semester)
    
    def _generate_ai_semester_summary(self, results, year, semester):
        """Generate conversational AI summary of semester readiness"""
        
        # Prepare structured data for AI
        units_summary = []
        for unit_code, data in results.items():
            score = data.get('readiness_score', 0)
            prereq_info = data.get('prerequisites', {})
            community = data.get('community_feedback', {})
            
            status = "‚úÖ Ready" if score >= 75 else ("‚ö†Ô∏è Moderate Risk" if score >= 50 else "‚ùå High Risk")
            
            units_summary.append({
                'code': unit_code,
                'name': data.get('unit_name', ''),
                'score': score,
                'status': status,
                'prereq_fulfilled': prereq_info.get('fulfilled', True),
                'prereq_strength': prereq_info.get('strength', 100),
                'prereq_details': prereq_info.get('details', ''),
                'difficulty': community.get('difficulty_score', 50),
                'struggling_percent': community.get('struggling_percent', '0%'),
                'pain_points': community.get('pain_points', []),
                'recommendations': data.get('recommendations', [])
            })
        
        # Build AI prompt
        units_text = "\n\n".join([
            f"**{u['code']} - {u['name']}**\n"
            f"Readiness Score: {u['score']}/100 ({u['status']})\n"
            f"Prerequisites: {'‚úÖ Met' if u['prereq_fulfilled'] else '‚ùå Not Met'} (Strength: {u['prereq_strength']}%)\n"
            f"Community Difficulty: {u['difficulty']}/100 ({u['struggling_percent']} struggling)\n"
            f"Top Issues: {', '.join([p['category'] for p in u['pain_points'][:2]]) if u['pain_points'] else 'None reported'}\n"
            f"Specific Advice:\n" + "\n".join([f"  ‚Ä¢ {rec}" for rec in u['recommendations']])
            for u in units_summary
        ])
        
        prompt = f"""You are a university course advisor helping a student plan Y{year}S{semester}.

        SEMESTER ANALYSIS:
        {units_text}

        TASK: Write a comprehensive yet friendly 6-8 sentence advisory that:
        1. Starts with overall semester assessment (e.g., "Looking at your Y{year}S{semester} plan...")
        2. Identifies which units are safe vs risky based on readiness scores
        3. Highlights the MAIN challenge or concern (e.g., prerequisite gaps, high difficulty units, workload)
        4. Gives 2-3 SPECIFIC, actionable recommendations (e.g., "Review FIT2004 algorithms before Week 3" or "Consider deferring FIT3155 to next semester")
        5. Ends with an encouraging but realistic note about managing the semester

        Be conversational, practical, and reference specific unit codes. Don't just repeat the scores ‚Äî synthesize insights and provide strategic advice."""

        response = self.model.generate_content(prompt)
        
        # Add score table after AI summary
        score_table = "\n\nüìä **Quick Reference:**\n"
        score_table += "‚îÄ" * 10 + "\n"
        for u in sorted(units_summary, key=lambda x: x['score'], reverse=True):
            score_table += f"{u['code']:10} ‚Üí {u['score']:3}% ({u['status']})\n"
        score_table += "‚îÄ" * 10
        
        return response.text.strip() + score_table
    

    def compare_unit_readiness(self, username, unit_codes, year, semester, stream, intake, interest=""):
        """
        Compare readiness for 2+ units to help student decide which to take.
        Now includes user interest in the analysis.
        """
        if len(unit_codes) < 2:
            return "Please provide at least 2 unit codes to compare."
        
        # Load planned units
        planned_units_dict = self.load_planned_units(username, year, semester)
        planned_units = list(planned_units_dict.keys()) if planned_units_dict else []
        
        # Load all units for descriptions
        all_units = self.load_all_units(username)
        
        # Initialize analyzer
        analyzer = SemesterReadinessAnalyzer(username)
        
        # Analyze each unit
        results = {}
        for unit_code in unit_codes:
            unit_upper = unit_code.upper()
            result = analyzer.analyze_unit_readiness(
                username=username,
                unit_code=unit_upper,
                current_year=year,
                current_sem=semester,
                stream=stream,
                intake=intake,
                planned_units=planned_units
            )
            if 'error' not in result:
                # Add unit description and assessment info
                unit_data = all_units.get(unit_upper, {})
                result['description'] = unit_data.get('description', 'N/A')
                result['assignments'] = unit_data.get('assign', 'N/A')
                result['tests'] = unit_data.get('test', 'N/A')
                result['final_exam'] = unit_data.get('final', 'N/A')
                results[unit_upper] = result
        
        if not results:
            return "None of the specified units could be analyzed. Check unit codes."
        
        # Generate AI comparison with interest
        return self._generate_ai_comparison(results, interest)
    
    def _generate_ai_comparison(self, results, interest=""):
        """Generate AI-powered unit comparison with user interest consideration"""
        
        comparison_data = []
        for code, data in results.items():
            comparison_data.append({
                'code': code,
                'name': data['unit_name'],
                'description': data.get('description', 'N/A'),
                'score': data['readiness_score'],
                'prereq_strength': data['prerequisites']['strength'],
                'prereq_details': data['prerequisites']['details'],
                'difficulty': data['community_feedback']['difficulty_score'],
                'struggling': data['community_feedback']['struggling_percent'],
                'workload_status': data['workload']['status'],
                'total_assignments': data['workload']['total_assignments'],
                'assignments': data.get('assignments', 'N/A'),
                'tests': data.get('tests', 'N/A'),
                'final_exam': data.get('final_exam', 'N/A'),
                'recommendations': data['recommendations']
            })
        
        # Build comparison text
        units_text = "\n\n".join([
            f"**{u['code']} - {u['name']}**\n"
            f"Description: {u['description']}\n"
            f"‚Ä¢ Readiness Score: {u['score']}/100\n"
            f"‚Ä¢ Prerequisite Strength: {u['prereq_strength']}% ({u['prereq_details'] if u['prereq_details'] else 'No prereq grades'})\n"
            f"‚Ä¢ Community Difficulty: {u['difficulty']}/100 ({u['struggling']} struggling)\n"
            f"‚Ä¢ Workload Impact: {u['workload_status'].title()} ({u['total_assignments']} total assignments)\n"
            f"‚Ä¢ Assessment: Assignments({u['assignments']}), Tests({u['tests']}), Final({u['final_exam']}%)\n"
            f"‚Ä¢ Top Advice: {u['recommendations'][0] if u['recommendations'] else 'None'}"
            for u in comparison_data
        ])
        
        interest_context = f"\n**Student's Interest/Goals:** {interest}" if interest else ""
        
        prompt = f"""You are a university advisor helping a student choose between these units:{interest_context}

        {units_text}

        TASK: Write a 6-8 sentence comparative analysis that:
        1. **If student provided interest:** Evaluate which unit(s) align BEST with their stated interest/goals, referencing the unit descriptions
        2. Clearly states which unit(s) the student is MOST ready for (reference readiness scores)
        3. Compares the key differences (prerequisites, difficulty, workload, assessment style)
        4. Identifies which is the "safer" choice vs which is more challenging
        5. Recommends a strategic order (e.g., "Take {comparison_data[0]['code']} this semester, defer {comparison_data[1]['code']} to next semester")
        6. Explains the strategic reasoning combining BOTH interest alignment AND readiness (e.g., "While FIT2004 matches your AI interest better, your weak prerequisite grades suggest taking FIT1045 first to build foundations")
        7. Ends with a clear, actionable recommendation

        Be direct, practical, and reference specific metrics. Balance their interests with their actual readiness to help them make a confident, strategic decision."""

        response = self.model.generate_content(prompt)
        
        # Add comparison table
        output = "\n\nüìä **Score Comparison:**\n"
        for u in sorted(comparison_data, key=lambda x: x['score'], reverse=True):
            output += f"- **{u['code']}**: Readiness {u['score']}/100 | Difficulty {u['difficulty']}/100 | Prereq {u['prereq_strength']}% | Workload {u['workload_status'].title()}\n"
        
        return response.text.strip() + output

    def ask_ai_about_unit(self, unit_code, unit_data, question):
        if not unit_data:
            return f"Sorry, I couldn't find any information about {unit_code}. Please check the unit code again."

        def interpret(val):
            if val.lower() == 'o':
                return "Complete one of the listed units"
            elif val.lower() == 'a':
                return "Complete all of the listed units"
            elif val.isdigit():
                return f"Complete {val}/6 = {int(val)/6:.1f} units"
            else:
                return val

        assign_text = interpret(unit_data['prereq'])

        prompt = f"""You are a helpful university course advisor.

        Unit Code: {unit_code}
        Unit Name: {unit_data['unit_name']}
        Description: {unit_data['description']}
        Prerequisites: {assign_text}
        Semester Available: {unit_data['sem_available']}
        Assessment: Assignments({unit_data['assign']}), Tests({unit_data['test']}), Final({unit_data['final']}%)

        Student Question: {question}

        IMPORTANT: 
        - Only use the information provided above
        - Do NOT make assumptions or add information not listed
        - If the answer isn't in the data above, say "I don't have that information"
        - Answer helpfully in 2-4 sentences based ONLY on the facts above"""

        response = self.model.generate_content(prompt)
        return response.text.strip()

    def general_advice(self, username, question, interest=None):
        all_units = self.load_all_units(username)
        if not all_units:
            return "I couldn't find any units in your record. Please upload or sync your unit files first."
        
        interest_context = ""
        if interest:
            interest_context = f"The student is interested in {interest}."
        
        prompt = f"""You are a helpful university course advisor. {interest_context}

        Student Question: {question}

        IMPORTANT:
        - Provide practical, general study advice only
        - Do NOT recommend specific units
        - Do NOT make up course requirements or prerequisites
        - If you don't know something, say so
        - Keep response to 2-3 sentences

        Provide a direct, friendly response focusing on general study strategies or course planning tips."""
        
        response = self.model.generate_content(prompt)
        return response.text.strip()
 

 #-------------------core_planner.py-------------------------------
 from pathlib import Path
import utilities as u
import os
import csv, json
from enum import Enum
from elective_planner import PlannerForElective
from update_result import UpdateResult
from pass_info import PreviousDetails

#index for the code list to stop at (core unit)
#since both a/d for year 1 have 3 core for sem 1, we only need 1 constant
YEAR_1_SEM_1 = 3 #3 core y1
YEAR_2_SEM_1_D = 2 #2 core for data science y2
YEAR_2_SEM_1_A   = 3 #3 core for algorithm & software y2
YEAR_3_SEM_1_D_F = 2 #2 core for data science y3 - feb intake 
YEAR_3_SEM_1_D = 1 #1 core for data science y3 - july intake 
YEAR_3_SEM_1_A = 2 #2 core for advanced y3 

class PlannerMenuEnum(Enum):
    VIEW_DETAILS = 0
    CHOOSE_ELECTIVE = 1
    CHANGE_ELECTIVE = 2
    VIEW_PLAN = 3
    SAVE_PlAN = 4
    QUIT_PLANNER = 5

class UserInfo():
    def __init__(self):
        # store user info
        self.stream = None
        self.year = None
        self.sem = None
        self.intake = None

    #-------------user info------------------
    def user_basic_info(self):
        """
        Prompt user for basic information such as their current stream, year and sem

        User answer must be within expected range using the function imported from utilities 

        @returns: (stream, year, sem)
        A tuple of three integer that contains user info
        """
        print("")
        username = input("Enter your username: ")
        print("")
        print("1. February Semester")
        print("2. July Semester")
        intake = u.read_integer("Enter intake: ", 1, 2)
        #print stream option
        print("")
        print("1. Data Science")
        print("2. Algorithms and Software")
        stream = u.read_integer("Enter current stream: ", 1, 2)
        year = u.read_integer("Enter year to plan [1/2/3]: ",1, 3)
        sem = u.read_integer("Enter sem to plan [1/2]: ", 1, 2)

        #if year 2 july semester: sem 1 for feb is sem 2 for july 
        if (intake == 1 and year == 2 and sem == 1):
            sem = 2
        elif (intake == 1 and year == 2 and sem == 2):
            sem = 1
        return (username, stream, year, sem, intake)

    def user_basic_info_web(self, username, stream, year, sem, intake):
        """Used by Flask API directly set user info instead of asking input"""
        self.username = username
        self.stream = int(stream)
        self.year = int(year)
        self.sem = int(sem)
        self.intake = int(intake)
        return (username, self.stream, self.year, self.sem, self.intake)


class PlannerForCore():
    def __init__(self, user_info, pass_info):
        self.user_info = user_info
        self.pass_info = pass_info

        #reference from csv
        self.core_units_all = {}    
        self.filtered_core_units = {}
        self.filtered_core_list = []

        #user-specific data
        self.user_core_progress = {} 
        self.list_fullfilled = []
        self.completed_list = []
        self.current_sem = []

    def setup_user(self):
        username, stream, year, sem, intake = self.user_info.user_basic_info()
        self.user_info.username = username
        self.user_info.stream = stream
        self.user_info.year = year
        self.user_info.sem = sem
        self.user_info.intake = intake

    #-------------read core unit------------------
    def choose_core_file(self):
        """
        [can be extend]
        Select the correct csv file that have the current core unit info 
        Core unit file differs for DS/AS

        @returns
        the correct file path to the corret core unit csv
        """
        stream = self.user_info.stream
        year = self.user_info.year
        if (stream == 1 and year == 1):
            return "data/d_y1_core_units.csv"
        elif (stream == 2 and year == 1):
            return "data/a_y1_core_units.csv"
        elif (stream == 1 and year == 2):
            return "data/d_y2_core_units.csv"
        elif (stream == 2 and year == 2):
            return "data/a_y2_core_units.csv"
        elif (stream == 1 and year == 3):
            return "data/d_y3_core_units.csv"
        elif (stream == 2 and year == 3):
            return "data/a_y3_core_units.csv"
        else:
            return("No information found for your option")
        
    def read_core_unit(self):
        """
        read csv file and store the filtered (based on sem) and unfiltered dictionary of core units
        """

        stream = self.user_info.stream
        year = self.user_info.year
        sem = self.user_info.sem
        intake = self.user_info.intake

        core_file = Path(self.choose_core_file())

        #core unit list 
        core_unit_code_list = []
        filter_core_code_list = []
    
        #core unit dict
        core_unit_dict = {}

        #get all the info into core_unit dict and list
        if (not core_file.is_file()):
            print("System error: No information found")
        else:
            with open(self.choose_core_file(), mode='r', encoding="utf-8-sig") as file:
                core_unit_file = csv.DictReader(file)
                for line in core_unit_file:
                    #get the core_unit_code into a list
                    core_unit_code_list.append(line["unit_code"].strip())
                    #unit_code as key, get unit_name, semester, description, prereq and workload
                    core_unit_dict[line["unit_code"]] = {
                    #create dictionary so each row will be a key as well 
                        "unit_name": line["unit_name"].strip(), 
                        "sem_available": line["semester_available"].strip(),
                        "description": line["description "].strip(),
                        "prereq": line["prereq"].strip(),
                        "assign": line["Assignment"].strip(),
                        "test": line["Test"].strip(),
                        "final": line["Final"].strip()
                    }

        #filter the core unit dict and list based on sem
        #extend this for different year and sem 
        if (sem == 1 and year == 1):
            filter_core_code_list = core_unit_code_list[:YEAR_1_SEM_1]
        elif (sem == 2 and year == 1):
            filter_core_code_list = core_unit_code_list[YEAR_1_SEM_1:]
        elif (sem == 1 and year == 2 and stream == 1):
            filter_core_code_list = core_unit_code_list[:YEAR_2_SEM_1_D]
        elif (sem == 2 and year == 2 and stream == 1):
            filter_core_code_list = core_unit_code_list[YEAR_2_SEM_1_D:]
        elif (sem == 1 and year == 2 and stream == 2):
            filter_core_code_list = core_unit_code_list[:YEAR_2_SEM_1_A]
        elif (sem == 2 and year == 2 and stream == 2):
            filter_core_code_list = core_unit_code_list[YEAR_2_SEM_1_A:]
        elif (sem == 1 and year == 3 and stream == 1):
            if (intake == 1):
                filter_core_code_list = core_unit_code_list[:YEAR_3_SEM_1_D_F]
            else:
                filter_core_code_list = core_unit_code_list[:YEAR_3_SEM_1_D]
        elif (sem == 2 and year == 3 and stream == 1):
            if (intake == 1):
                filter_core_code_list = core_unit_code_list[YEAR_3_SEM_1_D_F:]
            else:
                filter_core_code_list = core_unit_code_list[YEAR_3_SEM_1_D:]
        elif (sem == 1 and year == 3 and stream == 2 and intake == 2):
            filter_core_code_list = core_unit_code_list[:YEAR_3_SEM_1_A]
        elif (sem == 2 and year == 3 and stream == 2 and intake == 2):
            filter_core_code_list = core_unit_code_list[YEAR_3_SEM_1_A:]
        elif (sem == 1 and year == 3 and stream == 2 and intake == 1):
            filter_core_code_list.append(core_unit_code_list[0])
            filter_core_code_list.append(core_unit_code_list[3])
        elif (sem == 2 and year == 3 and stream == 2 and intake == 1):
            filter_core_code_list.append(core_unit_code_list[1])
            filter_core_code_list.append(core_unit_code_list[2])

        for unit_code, unit_info in core_unit_dict.items():
            if (unit_code in filter_core_code_list):
                self.filtered_core_units[unit_code] = unit_info

        #check if the unit going to show had been swapped
        user_folder = Path(f"user_info/{self.user_info.username}")
        already_taken_units = set()
        
        if user_folder.exists():
            # Loop through all Y{year}S{sem}_units.json files
            for file in user_folder.glob("Y*S*_units.json"):
                # Skip the current semester file
                current_sem_file = f"Y{year}S{sem}_units.json"
                if file.name == current_sem_file:
                    continue
                    
                try:
                    with open(file, "r", encoding="utf-8") as f:
                        semester_units = json.load(f)
                        # Add all units from this semester to the set
                        already_taken_units.update(semester_units.keys())
                except Exception as e:
                    print(f"Error reading {file}: {e}")
        
        # Remove already-taken units from the filter list
        filter_core_code_list = [
            code for code in filter_core_code_list 
            if code not in already_taken_units
        ]
        
        # Build filtered_core_units
        self.filtered_core_units = {
            k: v for k, v in core_unit_dict.items() 
            if k in filter_core_code_list
        }
        
        # Return filtered dict and unfiltered dict
        self.core_units_all = core_unit_dict
        self.filtered_core_list = filter_core_code_list
    
    def save_user_core(self):
        """
        Check if user's JSON already has the unit info saved.
        If not, add new core unit entries from self.core_units into JSON.
        """
        user_folder = Path("user_info") / self.user_info.username
        user_folder.mkdir(parents=True, exist_ok=True)
        file_path = user_folder / "core_units.json"

        # Load existing JSON data
        if file_path.exists():
            with open(file_path, "r", encoding="utf-8") as f:
                saved_data = json.load(f)
        else:
            saved_data = {}

        # Track if anything new added
        new_added = False

        # Add missing core units
        for unit_code, unit_info in self.core_units_all.items():
            if unit_code not in saved_data:
                saved_data[unit_code] = unit_info
                new_added = True

        # Save only if something was added
        if new_added:
            with open(file_path, "w", encoding="utf-8") as f:
                json.dump(saved_data, f, indent=4)
            print(f"Updated {file_path} with new core units.")
        else:
            print("No new core units to add. JSON already up-to-date.")

    #-------------display core unit at start------------------ 
    def unit_alert(self):
        """
        There is some confusion in terms of what sem means, when considering user's perspective, 
        their year 2 sem 1 should mean this is their second year first semester, so this unit alert will act as a disclaimer

        Feb intake sem 1 -> user first semester and Feb semester (S1)
        Feb intake sem 2 -> user second semester and July semester (S2)

        But for july intake
        July intake sem 1 -> user first semester and July semester (S2)
        July intake sem 2 -> user second semester and Feb semester (S1)

        So this function will alert user that what is the semester there are in, for better clarity
        """ 
        print("Reminder: ", end="")
        if (self.user_info.intake == 2 and self.user_info.sem == 1):
            self.current_sem = 2
            print("This is the July Semester")
        elif (self.user_info.intake == 2 and self.user_info.sem == 2):
            self.current_sem = 1
            print("This is the February Semester")
        elif (self.user_info.intake == 1 and self.user_info.sem == 1):
            self.current_sem = 1
            print("This is the February Semester")
        elif (self.user_info.intake == 1 and self.user_info.sem == 2):
            self.current_sem = 2
            print("This is the July Semester")


    #so at the start of this menu, the defaul core will be show
    #this function will format the info and show it nicely
    def display_core(self):
        """
        Display default core for that semester and year

        Before user choose to add elective or see any details
        It will show the unit code, name and its description
        """

        if (self.user_info.intake == 1 and self.user_info.sem == 2 and self.user_info.year == 2):
            self.user_info.sem = 1
        elif (self.user_info.intake == 1 and self.user_info.sem == 1 and self.user_info.year == 2):
            self.user_info.sem = 2

        print("")
        self.unit_alert()
        print("==============================================")
        print(f"Default Core Unit For Year {self.user_info.year} Sem {self.user_info.sem}")
        for unit_code, unit_info in self.filtered_core_units.items():
            print("---------------------------------------------")
            print(f"[ {unit_code} ]: {unit_info["unit_name"]}")
            print(f"Description: {unit_info["description"]}")
            print("")

    #show workload clearly in three section
    #print out workload info after getting the list
    def print_workload_info(self, workload_name, workload_list):
        """
        Display formatted workload information for sepecific workload type
        If the list is NONE

        @param workload_name (string) - workload type name to print out
        @param  workload_list (list) - marks for each workload of the same type
        """
        if ("NONE" in workload_list):
            print(f"No {workload_name} for this unit")
        else:
            workload_list_int = [float(s) for s in workload_list]
            #print assignment info
            print(f"Total {workload_name}: {len(workload_list_int)}")
            for i, workload in enumerate(workload_list_int):
                print(f"{workload_name[0].upper()}{i+1}: {workload/100:.0%}")

    def workload_extraction(self, assignment, test, final):
        """
        Return formatted workload info for assignment, test, and final as strings.
        Example: "20%, 30%"
        """
        def format_list(lst):
            return ', '.join([f"{int(s)}%" for s in lst if s.isdigit()]) or "None"

        # Split strings
        assignments_str = assignment.split(";")
        tests_str = test.split(";")
        finals_str = final.split(";")

        # Assignments
        assign_str = format_list(assignments_str)

        # Tests
        test_str = format_list(tests_str)

        # Finals
        if "NONE" in finals_str:
            final_str = "None"
        else:
            final_str = format_list(finals_str)

        return {
            "assign": assign_str,
            "test": test_str,
            "final": final_str
        }


    #show available sem clearly
    def sem_extraction(self, sem_available):
        """
        Display the sem in cleaerer format

        @param sem (list) - list containing 1 and/or 2 representing sem 1 and sem 2
        """
        sems_list_str = sem_available.split(";")

        sems_list = [int(s) for s in sems_list_str]

        print_sem_list = []

        for sem in sems_list:
            if (sem == 1):
                print_sem_list.append(f"February Semester")
            else:
                print_sem_list.append(f"July Semester")

        return print_sem_list

    #search for unit 
    def search_unit(self):
        """
        Display available core unit and return the searched unit to be printed in display_core

        @param stream (integer) - show available core based on student core

        @returns unit_code 
        """
        stream = self.user_info.stream
        core_unit_code_list = []
        if (stream == 1):
            stream_str = "Data Science"
        else:
            stream_str = "Algorithms and Software"

        #return list index
        print("")
        print(f"Core Units for Y{self.user_info.year}: {stream_str}")
        for i, unit_code in enumerate(self.core_units_all):
            core_unit_code_list.append(unit_code)
            print(f"{i+1}: {unit_code}")
        user_option_index = u.read_integer("Enter an option: ", 1, len(core_unit_code_list)) - 1

        #find the unit code from list
        searched_unit = core_unit_code_list[user_option_index]
        return searched_unit

    def choose_core_list(self):
        """
        search for the unit and display the info
        """
        searched_unit = self.search_unit()
        info = self.get_unit_core_info(searched_unit)
        print(json.dumps(info, indent=4))
    
    def display_prerequisites(self, unit_code):
        """
        Display prerequisites for a unit in a readable format.
        """
        prereq_dict = {}
        for u_code, unit_info in self.core_units_all.items():  
            prereq_dict[u_code] = unit_info.get("prereq", "NONE")
        
        prereq_str = prereq_dict.get(unit_code, "")
        
        if not prereq_str or prereq_str == "NONE":
            return f"{unit_code} has no prerequisites."

        if prereq_str.startswith('a;'):
            prereq_units = [u.strip() for u in prereq_str[2:].split(';')]
            return f"To take {unit_code}, you must have completed all of these units: {', '.join(prereq_units)}"

        elif prereq_str.startswith('12;'):
            prereq_units = [u.strip() for u in prereq_str[3:].split(';')]
            return f"To take {unit_code}, you must have completed 2 units"
        
        elif prereq_str.startswith('72;'):
            prereq_units = [u.strip() for u in prereq_str[3:].split(';')]
            return f"To take {unit_code}, you must have completed 72 units"

        elif prereq_str.startswith('o;'):
            prereq_units = [u.strip() for u in prereq_str[2:].split(';')]
            return f"To take {unit_code}, you must have completed at least one of these units: {', '.join(prereq_units)}"

        else:
            return f"To take {unit_code}, you must have completed: {prereq_str}"

    def get_unit_core_info(self, searched_unit):
        """
        Return detailed info about a core unit as a dictionary,
        including formatted workload.
        """
        user_path = Path(f"user_info/{self.user_info.username}/core_units.json")
        if not user_path.is_file():
            return None

        with open(user_path, "r", encoding="utf-8") as f:
            self.core_units_all = json.load(f)

        unit_info = self.core_units_all.get(searched_unit)
        if not unit_info:
            return None

        workload = self.workload_extraction(unit_info["assign"], unit_info["test"], unit_info["final"])

        return {
            "code": searched_unit,
            "name": unit_info['unit_name'],
            "description": unit_info['description'],
            "semesters": self.sem_extraction(unit_info['sem_available']),
            "prerequisites": self.display_prerequisites(searched_unit),
            "assign": workload['assign'],
            "test": workload['test'],
            "final": workload['final']
        }


    #--------------check core-----------------

    def check_unit_prereq(self):
        """
        Create a dictionary of all units and their prerequisites
        """
        prereq_dict = {}
        for unit_code, unit_info in self.core_units_all.items():
            prereq_dict[unit_code] = unit_info.get("prereq", "NONE")
        return prereq_dict  
    
    def normalize_code(self, code):
        code = code.strip().upper()
        if not code.startswith("FIT"):
            code = "FIT" + code
        return code


    def can_take_unit(self, unit_code, prereq_dict, completed_list):
        """
        Check if a unit can be taken based on prerequisites
        """
        completed_list = self.pass_info.saved_all_pass_unit()
        prereq_str = prereq_dict.get(unit_code, "")
        
        if not prereq_str or prereq_str == "NONE":
            print("No prerequisites required")
            return True

        # Check if it's an "a;" type (all units required)
        if prereq_str.startswith('a;'):
            prereq_units = [self.normalize_code(u) for u in prereq_str[2:].split(';') if u.strip()]
            print(f"Type: ALL required. Prereqs: {prereq_units}")
            result = all(unit in completed_list for unit in prereq_units)
            print(f"Result: {result}")
            return result

        # Check if it's a "12" type (any 2 units required)
        elif prereq_str == "12":
            print(f"Type: Any 12 CP. Completed: {len(completed_list)} units")
            result = len(completed_list) >= 2
            print(f"Result: {result}")
            return result
        
        elif prereq_str == "12":
            print(f"Type: Any 72 CP. Completed: {len(completed_list)} units")
            result = len(completed_list) >= 12
            print(f"Result: {result}")
            return result
        
        # Check if it's an "o;" type (one of the units required)
        elif prereq_str.startswith('o;'):
            prereq_units = [self.normalize_code(u) for u in prereq_str[2:].split(';') if u.strip()]
            print(f"Type: ONE OF required. Prereqs: {prereq_units}")
            result = any(unit in completed_list for unit in prereq_units)
            print(f"Result: {result}")
            return result

        else:
            # Single unit prerequisite
            normalized_prereq = self.normalize_code(prereq_str.strip())
            print(f"Type: Single unit. Normalized prereq: '{normalized_prereq}'")
            result = normalized_prereq in completed_list
            print(f"Result: {result}")
            return result
        
    def check_core_prereq(self):
        """
        Check if core units can be taken - return list of units with unmet prereqs
        """
        self.list_fullfilled = []
        prereq_dict = self.check_unit_prereq()
        completed_list = self.pass_info.saved_all_pass_unit()
        self.completed_list = completed_list
        
        unmet_units = []  

        for unit_code in self.filtered_core_list:
            can_take = self.can_take_unit(unit_code, prereq_dict, completed_list)
            self.list_fullfilled.append(can_take)
            
            if not can_take:
                print(f"You cannot take {unit_code} because prerequisite is not fulfilled")
                unmet_units.append(unit_code)  
        
        return unmet_units  
    
class PlannerMenu():
    def __init__(self):
        """
        all the classes (in differnt file) is called here 
        """
        user_info = UserInfo()
        self.update_result = UpdateResult()
        self.pass_info = PreviousDetails(user_info, self.update_result)
        self.planner_core = PlannerForCore(user_info, self.pass_info)    
        self.planner_elective = PlannerForElective(user_info, self.planner_core)

    #show planner menu
    def print_menu(self):
        """"
        Print out the planner menu available options
        """
        print(f"====Planner Menu for Y{self.planner_core.user_info.year}S{self.planner_core.user_info.sem}====")
        print("1. Search Unit Details")
        print("2. Choose Elective")
        print("3. Change Elective")
        print("4. View Current Plan")
        print("5. Save Plan")
        print("6. Quit Planner Menu")

    #return choice index
    def user_option(self):
        """
        Return user option index to switch between cases
        """
        while True:
            try:
                self.print_menu()
                user_option = u.read_integer("Enter an option: ", 1, len(PlannerMenuEnum))
                return (user_option - 1)
            except ValueError:
                print("Please enter an valid option\n")
    

    def run(self):
        """
        This is where all the different function will get called

        user_basic_info - Allow user enter stream, year and sem
        read_core_unit - Read the correct core unit csv file
        display_core - Display the default core units for that year and sem

        Choice 1. View details of the core unit / elective units

        Choice 2 - Choose elective 

        Choice 3 - Change elective

        Choice 4 - View Current Plan

        Choice 5 - Save current plan
        - we can only save after reviewing it at choice 4 
        - any prerequistie havent been fulfilled at core will cause the plan to be unable to save

        Choice 6. 
        Quit
        """
        # user enters their info        
        while True:
            self.planner_core.setup_user()
            self.pass_info.check_previous_record()
            if (len(self.pass_info.info_check_requirement) != 0):
                print("Error. No info found for previous year or sem")
                print("You should plan for all previous year and sem and save the data")
                self.pass_info.info_check_requirement = []
            else:
                break
        
        #check if the json file is available
        #then check if the json file grade had been updated
        #then cehck if the prerequiste of core units had been fullfilled 
        if (self.planner_core.user_info.year == 1 and self.planner_core.user_info.sem == 1):
            pass
        else:
            self.pass_info.check_json_planned()
        # Try to load saved core units first
        self.planner_core.read_core_unit()
        for code, info in self.planner_core.core_units_all.items():
            if code not in self.planner_core.user_core_progress:
                pass
        self.planner_core.save_user_core()
        self.planner_core.display_core()
        if (self.planner_core.user_info.year == 1 and self.planner_core.user_info.sem == 1):
            pass
        else:
            self.planner_core.check_core_prereq()
        self.planner_elective.read_elective()
        self.planner_elective.save_user_elective()

        while True:
            #option
            choice_index = self.user_option()
            choice = PlannerMenuEnum(choice_index)

            match choice:
                case PlannerMenuEnum.VIEW_DETAILS:
                    print("")
                    self.planner_elective.choose_core_or_elective_list()
                case PlannerMenuEnum.CHOOSE_ELECTIVE:
                    self.planner_elective.user_choice_choose_elective()
                case PlannerMenuEnum.CHANGE_ELECTIVE:
                    self.planner_elective.change_elective()
                case PlannerMenuEnum.VIEW_PLAN:
                    self.planner_elective.combine_information()
                case PlannerMenuEnum.SAVE_PlAN:
                    self.planner_elective.saved_as_JSON()
                case PlannerMenuEnum.QUIT_PLANNER:
                    print("Quiting Planner Menu....")
                    break

            print("")

    
#-----------------------elective_planner.py-----------------------
import utilities as u
from pathlib import Path
import csv, json
import os
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity


class PlannerForElective():
    def __init__(self, user_info, core_planner):
        """
        user_info from user info class
        username to be access anywhre in the calss
        core planner class
        all_elective_dict to showing all elective (L1-L3)
        all_elective_list to show all elective in a list 
        final_elecitive choose the final (1/2/3 based on elective spaces) elective
        final_unit_list_for_current_sem - contain four units - ready to be saved
        """
        self.user_info = user_info
        self.core_planner = core_planner
        self.all_electives_dict = {}
        self.all_electives_list = []
        self.final_elective = []
        self.final_unit_list_for_current_sem = []

    def setup_user(self):
        """
        access user basic info such as stream year sem and intake in this class
        """
        username, stream, year, sem, intake = self.user_info.user_basic_info()
        self.user_info.username = username
        self.user_info.stream = stream
        self.user_info.year = year
        self.user_info.sem = sem
        self.user_info.intake = intake

    def read_elective(self):
        """
        Read the elective unit csv file and save all the elective info as a dictionary 
        Save the elective unit code as list to allow easier sorting
        Skip electives that already exist in the user's core_units.json
        """
        # Load the user's core units first
        core_units = {}
        core_path = f"user_info/{self.user_info.username}/core_units.json"

        if os.path.exists(core_path):
            with open(core_path, "r", encoding="utf-8") as f:
                core_units = json.load(f)

        with open("data/elective_units.csv", mode="r", encoding="utf-8-sig") as file:
            elective_unit_file = csv.DictReader(file)
            for line in elective_unit_file:
                unit_code = line["unit_code"].strip()

                # Skip if the elective already exists in core units
                if unit_code in core_units:
                    continue

                # Save into list
                self.all_electives_list.append(unit_code)

                # Save into dict
                self.all_electives_dict[unit_code] = {
                    "unit_name": line["unit_name"].strip(), 
                    "sem_available": line["semester_available"].strip(),
                    "description": line["description "].strip(),
                    "prereq": line["prereq"].strip(),
                    "assign": line["Assignment"].strip(),
                    "test": line["Test"].strip(),
                    "final": line["Final"].strip(),
                    "approved_elective": line["Approved"].strip()
                }

        
    def manually_choose_based_on_level(self):
        print("Enter your interest elective level")
        print("Level 1")
        print("Level 2")
        print("Level 3")

        user_input = u.read_integer("Enter your choice: ",1,3)

        return user_input

    def get_available_electives_by_level(self, level):
        """Return electives of the given level that pass availability and prereq checks."""
        available = []
        for unit_code in self.all_electives_list:
            if unit_code[3] == str(level):  # check level
                # also check it's not already chosen
                if unit_code not in self.final_elective and unit_code not in self.core_planner.core_units_all:
                    available.append(unit_code)
        return available
    
    def choose_elective_manually(self, user_input):
        """
        this choose elective manually will display a list of elective and let user choose
        if they want year 1 or year 2 or year 3 elective
        """
        user_choice_elective_list = []
        for unit_code in self.all_electives_list:
            if (unit_code[3] == str(user_input)):
                user_choice_elective_list.append(unit_code)
        
        for i, unit_code in enumerate(user_choice_elective_list):
            print(f"{i+1}: {unit_code}")

        user_option_index = u.read_integer("Enter an option: ", 1, len(user_choice_elective_list)) - 1
        chosen_elective = user_choice_elective_list[user_option_index]
        return chosen_elective

    def recommend_electives_smart(self, level, user_interest, num_reco=3):
        """
        Recommend electives based on similarity between user's interest and elective descriptions.
        """
        #Filter electives by level and availability
        available_units = self.get_available_electives_by_level(level)
        
        if not available_units:
            print("No available electives found for this level.")
            return []
        
        #Prepare descriptions
        descriptions = [self.all_electives_dict[unit]["description"] for unit in available_units]
        
        #Vectorize descriptions and user interest
        vectorizer = TfidfVectorizer(stop_words='english')
        vectors = vectorizer.fit_transform(descriptions + [user_interest])
        
        #Compute cosine similarity
        user_vector = vectors[-1]  # last vector is user input
        elective_vectors = vectors[:-1]
        similarities = cosine_similarity(user_vector, elective_vectors)[0]
        
        #Rank electives by similarity
        ranked_indices = similarities.argsort()[::-1]  # highest first
        recommended_units = [available_units[i] for i in ranked_indices[:num_reco]]
        
        return recommended_units


    def choose_elective_system_recommendation(self):
        print("Enter the year/level of elective you want recommendation for (1/2/3):")
        level = u.read_integer("Enter level: ", 1, 3)
        
        user_interest = input("Describe your interest/future goals: ")

        recommended = self.recommend_electives_smart(level, user_interest)

        if not recommended:
            print("No matching electives found.")
            return

        print("Recommended electives for you:")
        print("0. Don't want any of these")  # Option to opt out
        for i, unit in enumerate(recommended):
            print(f"{i+1}. {unit}: {self.all_electives_dict[unit]['unit_name']}")

        user_choice = u.read_integer(f"Choose elective (0-{len(recommended)}): ", 0, len(recommended))
        
        if user_choice == 0:
            print("No elective chosen from recommendations.")
            return

        chosen_elective = recommended[user_choice - 1]
        self.final_elective.append(chosen_elective)
        print(f"Elective {chosen_elective} added successfully!")


    def check_elective_preq(self, chosen_elective):
        """
        @param chosen_elective check if chosen_elective prerequisite had been met

        call the can_take_unit function at core planner 
        @return true if prereq been met
        """
        preq_dict = {}
        for unit_code, unit_info in self.all_electives_dict.items():
            if (unit_code == chosen_elective):
                preq_dict[chosen_elective] = unit_info["prereq"]
        
        can_take = self.core_planner.can_take_unit(chosen_elective, preq_dict, self.core_planner.completed_list)
            
        return can_take

    def check_elective_available_sem(self, chosen_elective):
        """
        this will create a sem_list and check if user current semester 

        @return true if the unit is available at that semester
        """
        sems_list_str = []
        for unit_code, unit_info in self.all_electives_dict.items():
            if (unit_code == chosen_elective):
                sems_list_str = unit_info["sem_available"].split(";") 
    
        sems_list = [int(s) for s in sems_list_str]
        if (self.core_planner.current_sem not in sems_list):
            return False    
        else:
            return True

    def check_availability(self):
        """
        @return elective if 

        the elective is available at the semester (july or feb sem)
        the elective prerequisite had been fulfilled, user had passed that unit

        else 
        it will keep loop until the chosen elective is true for both situation
        """
        unit_code_core = [unit_code for unit_code in self.core_planner.core_units_all.keys()]
        chosen_elective = self.choose_elective_manually(self.manually_choose_based_on_level())
        while True:
            if not self.check_elective_available_sem(chosen_elective):
                print(f"You cannot choose {chosen_elective} because it is not available in this semester")
            elif not self.check_elective_preq(chosen_elective):
                print(f"You cannot choose {chosen_elective} because prerequisite is not fulfilled")
            elif chosen_elective in unit_code_core:
                print(f"You cannot choose {chosen_elective} as elective because it is a core for your stream")
            elif chosen_elective in self.final_elective:  
                print(f"You have already chosen {chosen_elective} as an elective")
            else:
                return chosen_elective
        
            print("Please try again.")
            print("")
            chosen_elective = self.choose_elective_manually(self.manually_choose_based_on_level())
    
    def display_prerequisites(self, unit_code):
        """
        Display prerequisites for a unit in a readable format.
        """
        user_path = Path(f"user_info/{self.user_info.username}/elective_units.json")

        # Always reload data
        if user_path.is_file():
            with open(user_path, "r", encoding="utf-8") as f:
                self.all_electives_dict = json.load(f)
        else:
            print(f"Error: {user_path} not found.")
            return
        
        prereq_dict = {}
        for u_code, unit_info in self.all_electives_dict.items():  
            prereq_dict[u_code] = unit_info.get("prereq", "NONE")
        
        prereq_str = prereq_dict.get(unit_code, "")
        
        if not prereq_str or prereq_str == "NONE":
            return f"{unit_code} has no prerequisites."

        if prereq_str.startswith('a;'):
            prereq_units = [u.strip() for u in prereq_str[2:].split(';')]
            return f"To take {unit_code}, you must have completed all of these units: {', '.join(prereq_units)}"

        elif prereq_str.startswith('12;'):
            prereq_units = [u.strip() for u in prereq_str[3:].split(';')]
            return f"To take {unit_code}, you must have completed 2 units"
        
        elif prereq_str.startswith('72;'):
            prereq_units = [u.strip() for u in prereq_str[3:].split(';')]
            return f"To take {unit_code}, you must have completed 12 units"


        elif prereq_str.startswith('o;'):
            prereq_units = [u.strip() for u in prereq_str[2:].split(';')]
            return f"To take {unit_code}, you must have completed at least one of these units: {', '.join(prereq_units)}"

        else:
            return f"To take {unit_code}, you must have completed: {prereq_str}"
        
    def get_unit_elective_info(self, chosen_elective):
        """
        Return detailed info about an elective unit as a dictionary,
        including formatted workload using core_planner's workload_extraction.
        """

        user_path = Path(f"user_info/{self.user_info.username}/elective_units.json")
        if not user_path.is_file():
            return None

        with open(user_path, "r", encoding="utf-8") as f:
            self.all_electives_dict = json.load(f)

        unit_info = self.all_electives_dict.get(chosen_elective)
        if not unit_info:
            return None

        # Ensure values are strings to avoid .split() errors
        assign = str(unit_info.get("assign", "0"))
        test = str(unit_info.get("test", "0"))
        final = str(unit_info.get("final", "0"))

        workload = self.core_planner.workload_extraction(assign, test, final)

        return {
            "code": chosen_elective,
            "name": unit_info.get("unit_name", ""),
            "description": unit_info.get("description", ""),
            "semesters": self.core_planner.sem_extraction(unit_info.get('sem_available', '')),
            "prerequisites": self.display_prerequisites(chosen_elective),
            "assign": workload.get("assign", "N/A"),
            "test": workload.get("test", "N/A"),
            "final": workload.get("final", "N/A"),
            "approved": unit_info.get("approved_elective", "N/A")
        }

    
    def elective_space(self):
        """
        return different elective space based on the default course map
        """
        if (self.user_info.intake == 1):
            if (self.user_info.stream == 1 and self.user_info.year == 1 and self.user_info.sem == 1):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 1 and self.user_info.sem == 2)):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 2 and self.user_info.sem == 1)):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 2 and self.user_info.sem == 2)):
                return 2
            elif ((self.user_info.stream == 1 and self.user_info.year == 3 and self.user_info.sem == 1)):
                return 2
            elif ((self.user_info.stream == 1 and self.user_info.year == 3 and self.user_info.sem == 2)):
                return 3
            elif ((self.user_info.stream == 2 and self.user_info.year == 1 and self.user_info.sem == 1)):
                return 1 
            elif ((self.user_info.stream == 2 and self.user_info.year == 1 and self.user_info.sem == 2)):
                return 2
            elif ((self.user_info.stream == 2 and self.user_info.year == 2 and self.user_info.sem == 1)):
                return 1
            elif ((self.user_info.stream == 2 and self.user_info.year == 2 and self.user_info.sem == 2)):
                return 1
            elif ((self.user_info.stream == 2 and self.user_info.year == 3 and self.user_info.sem == 1)):
                return 1
            elif ((self.user_info.stream == 2 and self.user_info.year == 3 and self.user_info.sem == 2)):
                return 2
        elif (self.user_info.intake == 2):
            if (self.user_info.stream == 1 and self.user_info.year == 1 and self.user_info.sem == 1):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 1 and self.user_info.sem == 2)):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 2 and self.user_info.sem == 1)):
                return 2
            elif ((self.user_info.stream == 1 and self.user_info.year == 2 and self.user_info.sem == 2)):
                return 1
            elif ((self.user_info.stream == 1 and self.user_info.year == 3 and self.user_info.sem == 1)):
                return 3
            elif ((self.user_info.stream == 1 and self.user_info.year == 3 and self.user_info.sem == 2)):
                return 2
            elif ((self.user_info.stream == 2 and self.user_info.year == 1 and self.user_info.sem == 1)):
                return 1 
            elif ((self.user_info.stream == 2 and self.user_info.year == 1 and self.user_info.sem == 2)):
                return 2
            elif ((self.user_info.stream == 2 and self.user_info.year == 2 and self.user_info.sem == 1)):
                return 1
            elif ((self.user_info.stream == 2 and self.user_info.year == 2 and self.user_info.sem == 2)):
                return 1
            elif ((self.user_info.stream == 2 and self.user_info.year == 3 and self.user_info.sem == 1)):
                return 2
            elif ((self.user_info.stream == 2 and self.user_info.year == 3 and self.user_info.sem == 2)):
                return 2
    
    def save_user_elective(self):
        """
        Check if user's JSON already has the elective info saved.
        If not, add new elective unit entries from self.elective_units into JSON.
        """
        user_folder = Path("user_info") / self.user_info.username
        user_folder.mkdir(parents=True, exist_ok=True)
        file_path = user_folder / "elective_units.json"

        # Load existing JSON data
        if file_path.exists():
            with open(file_path, "r", encoding="utf-8") as f:
                saved_data = json.load(f)
        else:
            saved_data = {}

        # Track if anything new added
        new_added = False

        # Add new elective units if not already in JSON
        for unit_code, unit_info in self.all_electives_dict.items():
            if unit_code not in saved_data:
                saved_data[unit_code] = unit_info
                new_added = True

        # Save only if something new was added
        if new_added:
            with open(file_path, "w", encoding="utf-8") as f:
                json.dump(saved_data, f, indent=4)
            print(f"Updated {file_path} with new elective units.")
        else:
            print("No new elective units to add. JSON already up-to-date.")
    

    def user_choice_choose_elective(self):
        """
        There is two way to choose elective where it can be entered manually (where user already have a choice)
        or
        Recommend by system (based on user interest)
        """
        #accept user input - ask about choose manually or smart planner help choose
        if (len(self.final_elective) < self.elective_space()):
            print("")
            print("Do you want to choose elective manually or recommend by system?")
            print("1. Enter Manually")
            print("2. System Recommendation")

            user_input = u.read_integer("Enter your choice: ",1,2)

            if (user_input == 1):
                chosen_elective = self.check_availability()
                info = self.get_unit_elective_info(chosen_elective)
                print(json.dumps(info, indent=4))
                user_double_confirm = input("You want to add this unit as elective? [Y/N]: ")
                while (user_double_confirm != "Y"):
                    chosen_elective = self.check_availability()
                    info = self.get_unit_elective_info(chosen_elective)
                    print(json.dumps(info, indent=4))
                    user_double_confirm = input("You want to add this unit as elective? [Y/N]: ")
                self.final_elective.append(chosen_elective)
                print("Elective Added")
                print(f"Electives chosen: {len(self.final_elective)}/{self.elective_space()}")
            else:
                self.choose_elective_system_recommendation()
        else:
            print("No more elective spaces")
    #-----------------------Change Elective--------------------------
    def change_elective(self):
        """
        check the final elective list and list out all the added elective 
        - call the check_avaibility function to make sure the elective is available
        """
        if (len(self.final_elective) == 0):
            print("NO elective chosen")
        else:
            for i, unit in enumerate(self.final_elective):
                print(f"{i+1}: {unit}")
            user_input = u.read_integer("Choose elective to change: ",1, len(self.final_elective))
            chosen_elective = self.final_elective[user_input-1]
            chosen_elective = self.check_availability()
            info = self.get_unit_elective_info(chosen_elective)
            print(json.dumps(info, indent=4))
            user_double_confirm = input("You want to add this unit as elective? [Y/N]: ")
            while (user_double_confirm != "Y"):
                chosen_elective = self.check_availability()
                info = self.get_unit_elective_info(chosen_elective)
                print(json.dumps(info, indent=4))
                user_double_confirm = input("You want to add this unit as elective? [Y/N]: ")
            self.final_elective[user_input-1] = chosen_elective  
            print("Elective Changed Successfully")

    
    #------------------------Combine information----------------------------
    def combine_information(self):
        """
        Combine the core unit list with the elective list as well as the dictionary
        then we can view the unit_code and name if the final unit list is 4 (4 each sem)
        """
        final_unit_list = []
        final_unit_dict = self.core_planner.core_units_all | self.all_electives_dict
        final_unit_list = self.core_planner.filtered_core_list + self.final_elective

        print("")
        print(f"Current plan for Y{self.user_info.year}S{self.user_info.sem}")
        for unit_code, unit_info in final_unit_dict.items():
            if (unit_code in final_unit_list):
                print(f"{unit_code}: {unit_info["unit_name"]}")

        self.final_unit_list_for_current_sem = final_unit_list

    
    #-----------------------Save Info----------------------------------
    def saved_as_JSON(self):
        """
        Save final planner as JSON. Returns True if successful, False otherwise.
        """
        json_dict = {}
        status = "planned"

        if False in self.core_planner.list_fullfilled:
            print("Unable to save current planner: core prerequisites not fulfilled")
            self.core_planner.check_core_prereq()
            return False  # indicate failure

        if len(self.final_unit_list_for_current_sem) != 4:
            print("Cannot save: exactly 4 units required")
            return False  # indicate failure

        for unit in self.final_unit_list_for_current_sem:
            json_dict[unit] = status

        filename = f"user_info/{self.user_info.username}/Y{self.user_info.year}S{self.user_info.sem}_units.json"
        os.makedirs(f"user_info/{self.user_info.username}", exist_ok=True)

        with open(filename, "w", encoding="utf-8") as f:
            json.dump(json_dict, f, indent=4)

        print(f"Planner saved for Y{self.user_info.year}S{self.user_info.sem}")
        return True  # indicate success


    #-------------------choose core or elecitve to serach---------------------------
    def choose_core_or_elective_list(self):
        """
        serach for core or elective which will call different function
        - show a list of available core / elective
        - user choose one and display all the info for that unit in details
        """
        print("You want to searched for core or elective unit?")
        print("1. Core Unit Lists")
        print("2. Elective Unit Lists")

        user_option = u.read_integer("Enter your choice: ", 1, 2)

        if (user_option == 1):
            self.core_planner.choose_core_list()
        else:
            user_input = self.manually_choose_based_on_level()
            chosen_elective = self.choose_elective_manually(user_input)
            info = self.get_unit_elective_info(chosen_elective)
            print(json.dumps(info, indent=4))


#-------------------------------forum.py--------------------------------
import json
import os
from pathlib import Path
from datetime import datetime


class ForumManager:
    """
    Manages the community forum functionality for unit discussions.
    Handles loading units, managing discussion threads, and user permissions.
    """
    
    def __init__(self, username):
        """
        Initialize ForumManager for a specific user
        
        Args:
            username (str): The current user's username
            folder path for forum data (public) and private discussion (individual)
        """
        self.username = username
        self.user_folder = Path(f"user_info/{username}")
        self.forum_folder = Path("forum_data")
        self.private_folder = self.user_folder / "private_discussions"
        
        # Ensure directories exist
        self.forum_folder.mkdir(parents=True, exist_ok=True)
        self.private_folder.mkdir(parents=True, exist_ok=True)
    
    def load_all_units(self):
        """
        Load all available units (both core and elective) for the user
        
        @return Dictionary of all units with their information
        """
        all_units = {}
        
        # Load core units
        core_path = self.user_folder / "core_units.json"
        if core_path.exists():
            with open(core_path, 'r', encoding='utf-8') as f:
                core_data = json.load(f)
                for code, info in core_data.items():
                    all_units[code] = {
                        'code': code,
                        'name': info.get('unit_name', code),
                        'description': info.get('description', 'No description available'),
                        'type': 'core'
                    }
        
        # Load elective units
        elective_path = self.user_folder / "elective_units.json"
        if elective_path.exists():
            with open(elective_path, 'r', encoding='utf-8') as f:
                elective_data = json.load(f)
                for code, info in elective_data.items():
                    if code not in all_units:  # Avoid duplicates
                        all_units[code] = {
                            'code': code,
                            'name': info.get('unit_name', code),
                            'description': info.get('description', 'No description available'),
                            'type': 'elective'
                        }
        
        return all_units
    
    def get_unit_discussions(self, unit_code, tag):
        """
        Get all discussions for a specific unit and tag
        
        @param unit_code (str): The unit code 
        @param tag (str): Discussion tag ('general', 'resources', or 'private')
        
        Returns:
            list: List of discussion threads
        """
        if tag == 'private':
            # Load from user's private folder
            file_path = self.private_folder / f"{unit_code}_private.json"
        else:
            # Load from public forum folder
            file_path = self.forum_folder / f"{unit_code}_{tag}.json"
        
        if not file_path.exists():
            return []
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                discussions = json.load(f)
                return discussions
        except json.JSONDecodeError:
            return []
    
    def add_discussion(self, unit_code, tag, title, content):
        """
        Add a new discussion thread
        
        @param unit code
        @param discussion tag
        @param discussion title
        @param discussion content
        
        @return dict: The created discussion with success status
        """
        if tag == 'private':
            file_path = self.private_folder / f"{unit_code}_private.json"
        else:
            file_path = self.forum_folder / f"{unit_code}_{tag}.json"
        
        # Load existing discussions
        discussions = []
        if file_path.exists():
            with open(file_path, 'r', encoding='utf-8') as f:
                try:
                    discussions = json.load(f)
                except json.JSONDecodeError:
                    discussions = []
        
        # Create new discussion
        new_discussion = {
            'id': len(discussions) + 1,
            'username': self.username,
            'title': title,
            'content': content,
            'timestamp': datetime.now().isoformat(),
            'likes': [],
            'replies': []
        }
        
        discussions.append(new_discussion)
        
        # Save discussions
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(discussions, f, indent=4)
        
        return {
            'success': True,
            'discussion': new_discussion
        }
    
    def add_reply(self, unit_code, tag, discussion_id, content):
        """
        Add a reply to an existing discussion
        
        @param unit_code (str): The unit code
        @param tag (str): Discussion tag
        @param discussion_id (int): ID of the discussion to reply to
        @param content (str): Reply content
        
        @return dict: Result with success status
        """
        if tag == 'private':
            file_path = self.private_folder / f"{unit_code}_private.json"
        else:
            file_path = self.forum_folder / f"{unit_code}_{tag}.json"
        
        if not file_path.exists():
            return {'success': False, 'error': 'Discussion not found'}
        
        with open(file_path, 'r', encoding='utf-8') as f:
            discussions = json.load(f)
        
        # Find the discussion
        discussion_found = False
        for discussion in discussions:
            if discussion['id'] == discussion_id:
                new_reply = {
                    'username': self.username,
                    'content': content,
                    'timestamp': datetime.now().isoformat()
                }
                discussion['replies'].append(new_reply)
                discussion_found = True
                break
        
        if not discussion_found:
            return {'success': False, 'error': 'Discussion ID not found'}
        
        # Save updated discussions
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(discussions, f, indent=4)
        
        return {'success': True, 'message': 'Reply added successfully'}
    
    def get_discussion_stats(self, unit_code):
        """
        Get statistics about discussions for a unit
        
        @param unit_code (str): The unit code
        
        @return dict: Statistics including count per tag
        """
        stats = {
            'general': 0,
            'resources': 0,
            'private': 0
        }
        
        for tag in ['general', 'resources', 'private']:
            discussions = self.get_unit_discussions(unit_code, tag)
            stats[tag] = len(discussions)
        
        return stats
    
    def can_access_discussion(self, unit_code, tag, request_username):
        """
        Check if a user can access a specific discussion
        
        @param unit_code (str): The unit code
        @param tag (str): Discussion tag
        @param request_username (str): Username trying to access
        
        @return bool: True if user can access, False otherwise
        """
        # Private discussions can only be accessed by the owner
        if tag == 'private':
            return request_username == self.username
        
        # Public discussions (general, resources) are accessible to all
        return True
    
    def delete_discussion(self, unit_code, tag, discussion_id):
        """
        Delete a discussion (only by the creator)
        
        @param unit_code (str): The unit code
        @param tag (str): Discussion tag
        @param iscussion_id (int): ID of discussion to delete
        
        @return dict: Result with success status
        """
        if tag == 'private':
            file_path = self.private_folder / f"{unit_code}_private.json"
        else:
            file_path = self.forum_folder / f"{unit_code}_{tag}.json"
        
        if not file_path.exists():
            return {'success': False, 'error': 'Discussion not found'}
        
        with open(file_path, 'r', encoding='utf-8') as f:
            discussions = json.load(f)
        
        # Find and remove the discussion
        discussion_found = False
        for i, discussion in enumerate(discussions):
            if discussion['id'] == discussion_id:
                # Check if user is the creator
                if discussion['username'] != self.username:
                    return {'success': False, 'error': 'You can only delete your own discussions'}
                discussions.pop(i)
                discussion_found = True
                break
        
        if not discussion_found:
            return {'success': False, 'error': 'Discussion ID not found'}
        
        # Save updated discussions
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(discussions, f, indent=4)
        
        return {'success': True, 'message': 'Discussion deleted successfully'}
    
    def toggle_like(self, unit_code, tag, discussion_id, username):
        """
        Toggle like on a discussion (add if not liked, remove if already liked)

        @param unit_code (str): The unit code
        @param tag (str): Discussion tag
        @param discussion_id (int): ID of discussion to delete
        @param username(str): navigate correct user
        
        @return dict: {'success': bool, 'liked': bool, 'like_count': int}
        """
        if tag == 'private':
            file_path = self.private_folder / f"{unit_code}_private.json"
        else:
            file_path = self.forum_folder / f"{unit_code}_{tag}.json"
        
        if not file_path.exists():
            return {'success': False, 'error': 'Discussion not found'}
        
        with open(file_path, 'r', encoding='utf-8') as f:
            discussions = json.load(f)
        
        # Find the discussion
        for discussion in discussions:
            if discussion['id'] == discussion_id:
                # Initialize likes list if it doesn't exist (for old discussions)
                if 'likes' not in discussion:
                    discussion['likes'] = []
                
                # Toggle like
                if username in discussion['likes']:
                    discussion['likes'].remove(username)
                    liked = False
                else:
                    discussion['likes'].append(username)
                    liked = True
                
                # Save
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(discussions, f, indent=4)
                
                return {
                    'success': True,
                    'liked': liked,
                    'like_count': len(discussion['likes'])
                }
        
        return {'success': False, 'error': 'Discussion not found'}

#----------------------------main.py (Run in terminal)---------------------------------
from enum import Enum
from core_planner import PlannerMenu
from update_result import ResultMenu
from update_units import UpdateMenu, UnitMenu, ViewMenu
import utilities as u
import subprocess
import sys

class MainMenu(Enum):
    PLAN_MY_UNIT = 0
    VIEW_PLANNER = 1
    UPDATE_RESULT = 2
    UPDATE_UNITS = 3
    QUIT = 4

class SmartUnitPlanner:
    def __init__(self):
        print("Welcome to Monash Smart Unit Planner\n")

    #print menu 
    def print_menu(self):
        """
        Print the menu options for the main menu
        """
        print("====Smart Course Planner Menu====")
        print("1. Plan my unit")
        print("2. View save plan")
        print("3. Enter my result")
        print("4. Update units")
        print("5. Quit")

    #return user option
    def user_option(self):
        """
        Return valid user option index 
        """
        while True:
            try:
                self.print_menu()
                user_option = u.read_integer("Enter an option: ", 1, len(MainMenu))
                return (user_option - 1)
            except ValueError:
                print("Please enter an valid option\n")


    def run(self):
        """
        Main Menu function is called here
        
        Choice 1 - Plan Menu
        Enter plan unit menu
        Choice 2 - View Current Planner 
        - COMING SOON
        Choice 3 - Enter result
        Choice 4 - Quit
        """
        planner = PlannerMenu()

        update_menu = UpdateMenu(
            planner.pass_info.user_info,      
            planner.update_result,
            planner.pass_info,
            planner.planner_core
        )
        while True:
            choice_index = self.user_option()
            choice = MainMenu(choice_index)

            match choice:
                case MainMenu.PLAN_MY_UNIT:
                    print("Entering Plan my unit")
                    plan = PlannerMenu()
                    plan.run()
                case MainMenu.VIEW_PLANNER:
                    print("Viewing current planner")
                    viewer = ViewMenu()
                    viewer.run()
                case MainMenu.UPDATE_RESULT:
                    print("Entering result menu")
                    result = ResultMenu()
                    result.run()
                case MainMenu.UPDATE_UNITS:
                    print("Entering units menu")
                    unit = UnitMenu(update_menu)
                    unit.run()
                case MainMenu.QUIT:
                    print("Bye!")
                    break
            
            print("")

if __name__ == "__main__":
    app = SmartUnitPlanner()
    app.run()

#------------------------------pass_info.py------------------------------
import utilities as u
import json
import os
from update_result import UpdateResult

class PreviousDetails():
    def __init__(self, user_info, update_results):
        """
        @param user_info that was entered previously 
        username - can access the file anywhere in the class
        info_check_requiremnet - message showing there is missing year/sem unit info 
        json_file_list - list of json file name that user had previously saved
        """
        self.user_info = user_info
        self.update_results = update_results
        self.info_check_requirement = []
        self.json_file_list = []
    
    def setup_user(self):
        """
        intialize user basic info such as their stream, year and sem
        """
        username, stream, year, sem, intake = self.user_info.user_basic_info()
        self.user_info.username = username
        self.user_info.stream = stream
        self.user_info.year = year
        self.user_info.sem = sem
        self.user_info.intake = intake
    
    def check_file_path(self, file_path, year, sem):
        """
        @param file_path - path that includes username
        @param year - current year that is checking
        @param sem - current sem checking
        check if file path exsits,
        if file not found, append the error message to a list
        """
        if os.path.exists(file_path):
            print(f"Found information for Y{year}S{sem}")
        else:
            string = (f"Cannot find information for Y{year}S{sem}")
            print(string)
            self.info_check_requirement.append(string)
    
    def check_previous_record(self):
        """
        accept user input to write the correct file path and call the check_file_path function 
            - to display error message
        this will check if required info (file exists for all previous year and sem)
        if not output the error message
        """
        self.info_check_requirement = [] 
        sem = self.user_info.sem
        year = self.user_info.year

        if (self.user_info.intake == 1 and year == 2 and sem == 1):
            sem = 2
        elif (self.user_info.intake == 1 and year == 2 and sem == 2):
            sem = 1
        #if not year 1 sem 1 start record information
        if (self.user_info.year == 1 and self.user_info.sem == 1):
            return True
        else:
            #check if previous record is available
            print("")
            file_path = f"user_info/{self.user_info.username}/Y{year}S{sem}_units.json"
            #check loop need to check if file exists for all previous year and sem
            # Move to previous semester first
            if sem == 1:
                sem = 2
                year -= 1
            else:
                sem -= 1

            # Then start checking from that previous sem backward
            while year > 0:
                file_path = f"user_info/{self.user_info.username}/Y{year}S{sem}_units.json"
                self.check_file_path(file_path, year, sem)

                if year == 1 and sem == 1:
                    break  # Stop once we reach Y1S1

                # Move to the next previous semester
                if sem == 1:
                    sem = 2
                    year -= 1
                else:
                    sem -= 1
        
        return len(self.info_check_requirement) == 0
        

    def check_json_planned(self):
        """
        Check if the JSON file results had been entered, or just planned.
        Only process files starting with 'Y' and ending with '.json'.
        """
        file_path = f"user_info/{self.user_info.username}"

        # Ensure folder exists
        while not os.path.exists(file_path):
            print("Please enter a valid username")
            self.user_info.username = input("Enter your username: ")
            file_path = f"user_info/{self.user_info.username}"

        # List all files in folder
        self.json_file_list = os.listdir(file_path)

        if self.user_info.year == 1 and self.user_info.sem == 1:
            return True # nothing to check for first semester

        for file in self.json_file_list:
            # Only process JSON files starting with 'Y'
            if not (file.startswith("Y") and file.endswith(".json")):
                continue

            file_path_full = os.path.join(file_path, file)
            try:
                with open(file_path_full, "r", encoding="utf-8") as f:
                    unit_passed_info_file = json.load(f)
            except (UnicodeDecodeError, json.JSONDecodeError):
                continue

            for unit_code, passed_info in unit_passed_info_file.items():
                if passed_info == "planned":
                    print("Please update your pass unit result")
                    # self.update_results.access_unplanned_info()
                    return False  

        return True
    #-------------------check core---------------------------
    def saved_all_pass_unit(self):
        """
        Return a list of unit codes that the user has passed.
        Only loads valid JSON files (optionally starting with 'Y') from the user's folder.
        """
        all_unit_dict = {}
        passed_unit_list = []

        folder_path = f"user_info/{self.user_info.username}"
        if not os.path.exists(folder_path):
            return passed_unit_list

        for file in os.listdir(folder_path):
            # Skip non-JSON files
            if not file.endswith(".json"):
                continue
            if not file.startswith("Y"):
                continue

            file_path = os.path.join(folder_path, file)
            try:
                with open(file_path, "r", encoding="utf-8") as f:
                    unit_info_json = json.load(f)
                all_unit_dict.update(unit_info_json)
            except (json.JSONDecodeError, UnicodeDecodeError):
                print(f"Skipping invalid or non-JSON file: {file}")
                continue

        # Build the passed unit list
        for unit_code, unit_passed_info in all_unit_dict.items():
            if unit_passed_info not in ("planned", "F"):
                passed_unit_list.append(unit_code)
        
        return passed_unit_list


#----------------------performance.py--------------------------------
from sentiment_analyzer import SentimentDifficultyAnalyzer
from pathlib import Path
import json

class SemesterReadinessAnalyzer:
    """
    Analyzes if a student is ready to take specific units
    based on past performance, prerequisites, and community data
    """
    
    def __init__(self, username):
        self.username = username
        self.sentiment_analyzer = SentimentDifficultyAnalyzer()
    
    def get_past_grades(self):
        """
        Load all past grades from ALL Y{X}S{Y}_units.json files
        Returns: {unit_code: grade_status}
        """
        user_folder = Path(f"user_info/{self.username}")
        all_grades = {}
        
        if not user_folder.exists():
            return {}
        
        # Find ALL semester files dynamically
        semester_files = list(user_folder.glob("Y*S*_units.json"))
        
        for file in semester_files:
            try:
                with open(file, 'r', encoding='utf-8') as f:
                    semester_data = json.load(f)
                    # Update grades dictionary
                    all_grades.update(semester_data)
            except Exception as e:
                print(f"Warning: Could not read {file.name}: {e}")
                continue
        
        return all_grades
    
    def get_completed_units(self):
        """
        Get only PASSED units (filter out 'planned', 'N', 'Fail')
        Returns: list of unit codes
        """
        all_grades = self.get_past_grades()
        
        # Statuses that count as "completed"
        passing_statuses = ['HD', 'D', 'C', 'P', 
                           'High Distinction', 'Distinction', 'Credit', 'Pass']
        
        completed = [
            code for code, status in all_grades.items()
            if status in passing_statuses
        ]
        
        return completed
    
    def analyze_prerequisite_strength(self, unit_code, core_units_data):
        """
        Check how strong user background is based  on their passed performance
        @returns (fulfilled, strength_score, details)
        """
        prereq_str = core_units_data.get(unit_code, {}).get('prereq', 'NONE')
        
        if prereq_str == 'NONE' or not prereq_str:
            return (True, 100, "No prerequisites required")
        
        past_grades = self.get_past_grades()
        completed_units = self.get_completed_units()
        
        # Grade value mapping
        grade_map = {
            'HD': 100, 'High Distinction': 100,
            'D': 80, 'Distinction': 80,
            'C': 70, 'Credit': 70,
            'P': 50, 'Pass': 50,
            'N': 0, 'Fail': 0,
            'planned': 0
        }
        
        # Parse prerequisite codes
        prereq_codes = []
        prereq_type = 'all'  # or 'one'
        
        if prereq_str.startswith('a;'):
            prereq_type = 'all'
            prereq_codes = [u.strip().upper() for u in prereq_str[2:].split(';') if u.strip()]
        elif prereq_str.startswith('o;'):
            prereq_type = 'one'
            prereq_codes = [u.strip().upper() for u in prereq_str[2:].split(';') if u.strip()]
        elif prereq_str == '12':
            # Need any 12 credit points (2 units)
            if len(completed_units) >= 2:
                return (True, 100, f"Completed {len(completed_units)} units (12CP met)")
            else:
                return (False, 0, f"Need 2 units, only completed {len(completed_units)}")
        elif prereq_str == '72':
            # Need 72 credit points (12 units)
            if len(completed_units) >= 12:
                return (True, 100, f"Completed {len(completed_units)} units (72CP met)")
            else:
                return (False, 0, f"Need 12 units, only completed {len(completed_units)}")
        else:
            prereq_type = 'single'
            prereq_codes = [prereq_str.strip().upper()]
        
        # Normalize unit codes (ensure FIT prefix)
        def normalize_code(code):
            code = code.upper().strip()
            if not code.startswith('FIT'):
                code = 'FIT' + code
            return code
        
        prereq_codes = [normalize_code(c) for c in prereq_codes]
        
        # Check fulfillment
        if prereq_type == 'all':
            fulfilled = all(code in completed_units for code in prereq_codes)
        elif prereq_type == 'one':
            fulfilled = any(code in completed_units for code in prereq_codes)
        else:  # single
            fulfilled = prereq_codes[0] in completed_units
        
        if not fulfilled:
            missing = [c for c in prereq_codes if c not in completed_units]
            return (False, 0, f"Missing: {', '.join(missing)}")
        
        # Calculate strength based on grades
        prereq_grades = []
        for code in prereq_codes:
            if code in past_grades:
                grade = past_grades[code]
                grade_value = grade_map.get(grade, 50)
                prereq_grades.append((code, grade, grade_value))
        
        if not prereq_grades:
            return (True, 100, "Prerequisites met")
        
        avg_strength = sum(g[2] for g in prereq_grades) / len(prereq_grades)
        
        # Build details string
        details = "\n".join([f"  {code}: {grade}" for code, grade, _ in prereq_grades])
        
        return (fulfilled, int(avg_strength), details)
    
    def analyze_unit_readiness(self, username, unit_code, current_year, current_sem, 
                                stream, intake, planned_units=[]):
        """
        Main analysis function
        @returns comprehensive readiness report
        """
        # Load core units
        core_path = f"user_info/{username}/core_units.json"
        elective_path = f"user_info/{username}/elective_units.json"
        
        all_units = {}
        
        if Path(core_path).exists():
            with open(core_path, 'r', encoding='utf-8') as f:
                all_units.update(json.load(f))
        
        if Path(elective_path).exists():
            with open(elective_path, 'r', encoding='utf-8') as f:
                all_units.update(json.load(f))
        
        if not all_units:
            return {"error": "No unit data found for user"}
        
        unit_data = all_units.get(unit_code)
        if not unit_data:
            return {"error": f"{unit_code} not found in your units"}
        
        # 1. Check prerequisites
        prereq_fulfilled, prereq_strength, prereq_details = \
            self.analyze_prerequisite_strength(unit_code, all_units)
        
        # 2. Get community sentiment
        sentiment = self.sentiment_analyzer.analyze_unit(unit_code)
        
        # 3. Analyze current workload
        current_workload = self._calculate_current_workload(
            username, planned_units, unit_code, all_units
        )
        
        # 4. Calculate readiness score
        readiness_score = self._calculate_readiness_score(
            prereq_fulfilled, prereq_strength, sentiment, current_workload
        )
        
        # 5. Generate recommendations
        recommendations = self._generate_recommendations(
            readiness_score, prereq_strength, sentiment, current_workload, unit_code
        )
        
        return {
            'unit_code': unit_code,
            'unit_name': unit_data['unit_name'],
            'readiness_score': readiness_score,
            'prerequisites': {
                'fulfilled': prereq_fulfilled,
                'strength': prereq_strength,
                'details': prereq_details
            },
            'community_feedback': {
                'difficulty_score': sentiment.get('difficulty_score', 50) if sentiment['status'] == 'success' else 50,
                'struggling_percent': sentiment.get('struggling_percent', '0%') if sentiment['status'] == 'success' else '0%',
                'pain_points': sentiment.get('pain_points', [])[:3] if sentiment['status'] == 'success' else []
            },
            'workload': current_workload,
            'recommendations': recommendations
        }
    
    def _calculate_current_workload(self, username, planned_units, new_unit, all_units):
        """
        Calculate workload for the semester.
        
        Two scenarios:
        1. new_unit IN planned_units: Analyzing a semester (show total workload)
        2. new_unit NOT in planned_units: Adding a unit (show before/after)
        """
        def count_workload(unit_codes):
            """Helper to count assignments/tests for a list of units"""
            assignments = 0
            tests = 0
            for unit_code in unit_codes:
                unit_data = all_units.get(unit_code, {})
                assign = unit_data.get('assign', 'NONE')
                test = unit_data.get('test', 'NONE')
                
                if assign and assign != 'NONE':
                    assignments += len(assign.split(';'))
                if test and test != 'NONE':
                    tests += len(test.split(';'))
            
            return assignments, tests
        
        # Check if we're analyzing an existing semester or adding a new unit
        is_adding_new = new_unit not in planned_units
        
        if is_adding_new:
            # Scenario 2: Adding a new unit
            base_assignments, base_tests = count_workload(planned_units)
            total_assignments, total_tests = count_workload(planned_units + [new_unit])
            total_units = len(planned_units) + 1
        else:
            # Scenario 1: Analyzing existing semester
            total_assignments, total_tests = count_workload(planned_units)
            
            # Calculate "base" as semester without this unit (for context)
            other_units = [u for u in planned_units if u != new_unit]
            base_assignments, base_tests = count_workload(other_units)
            total_units = len(planned_units)
        
        # Status calculation
        if total_assignments > 16 or total_tests > 8:
            status = 'overwhelming'
        elif total_assignments > 12 or total_tests > 6:
            status = 'heavy'
        elif total_assignments > 8 or total_tests > 4:
            status = 'moderate'
        else:
            status = 'light'
        
        return {
            'total_units': total_units,
            'total_assignments': total_assignments,
            'total_tests': total_tests,
            'base_assignments': base_assignments,
            'base_tests': base_tests,
            'new_unit_adds': {
                'assignments': total_assignments - base_assignments,
                'tests': total_tests - base_tests
            },
            'is_adding_new': is_adding_new,
            'status': status
        }
    
    def _calculate_readiness_score(self, prereq_fulfilled, prereq_strength, sentiment, workload):
        """
        Calculate 0-100 readiness score 

        @returns
        - 0-40 = Not ready
        - 41-65 = Somewhat ready
        - 66-85 = Ready
        - 86-100 = Very ready
        """
        #If prerequisites not fulfilled at all, instant 0
        if not prereq_fulfilled:
            return 0
        
        # ===== COMPONENT 1: PREREQUISITE SCORE (50% weight) =====
        # This is the MOST important factor
        prereq_score = prereq_strength  # Already 0-100
        
        # ===== COMPONENT 2: DIFFICULTY-ADJUSTED SCORE (25% weight) =====
        # Instead of inverting, we adjust based on prerequisite strength
        # Logic: Strong prereqs + hard unit = still ready
        #        Weak prereqs + hard unit = not ready
        
        diff_score = sentiment.get('difficulty_score', 50) if sentiment['status'] == 'success' else 50
        
        if prereq_strength >= 85:  # Strong foundation (HD/D)
            # You can handle difficult units
            if diff_score >= 70:  # Hard unit
                difficulty_adjusted = 85  # Still well-prepared
            elif diff_score >= 50:  # Medium unit
                difficulty_adjusted = 90
            else:  # Easy unit
                difficulty_adjusted = 95
        
        elif prereq_strength >= 70:  # Moderate foundation (C)
            # Be cautious with hard units
            if diff_score >= 70:  # Hard unit
                difficulty_adjusted = 60  # Risky
            elif diff_score >= 50:  # Medium unit
                difficulty_adjusted = 75
            else:  # Easy unit
                difficulty_adjusted = 85
        
        elif prereq_strength >= 50:  # Weak foundation (P)
            # Hard units are very risky
            if diff_score >= 70:  # Hard unit
                difficulty_adjusted = 30  # High risk
            elif diff_score >= 50:  # Medium unit
                difficulty_adjusted = 50  # Moderate risk
            else:  # Easy unit
                difficulty_adjusted = 65
        
        else:  # Very weak/no prereq data
            # Even easy units might be challenging
            if diff_score >= 70:
                difficulty_adjusted = 20
            elif diff_score >= 50:
                difficulty_adjusted = 40
            else:
                difficulty_adjusted = 55
        
        # ===== COMPONENT 3: WORKLOAD SCORE (25% weight) =====
        # More granular than binary heavy/manageable
        
        total_assignments = workload['total_assignments']
        total_tests = workload['total_tests']
        total_units = workload['total_units']
        
        # Calculate workload pressure
        if total_assignments <= 8 and total_tests <= 4:
            workload_score = 90  # Light semester
        elif total_assignments <= 12 and total_tests <= 6:
            workload_score = 75  # Moderate semester
        elif total_assignments <= 16 and total_tests <= 8:
            workload_score = 55  # Heavy semester
        else:
            workload_score = 35  # Overwhelming semester
        
        # Adjust for unit count (4 units is standard)
        if total_units > 4:
            workload_score = max(30, workload_score - (total_units - 4) * 10)
        
        # ===== FINAL CALCULATION =====
        # Weighted average with emphasis on prerequisites
        total_score = (
            prereq_score * 0.50 +           # 50% weight
            difficulty_adjusted * 0.25 +    # 25% weight
            workload_score * 0.25           # 25% weight
        )
        
        return int(total_score)

    def _generate_recommendations(self, score, prereq_strength, sentiment, workload, unit_code):
        """
        Generate more specific recommendations based on what's actually wrong
        """
        recommendations = []
        
        # ===== RISK LEVEL WITH CONTEXT =====
        if score >= 80:
            risk = "READY - Strong foundation and manageable workload"
        elif score >= 65:
            risk = "READY WITH PREP - Good foundation, some preparation recommended"
        elif score >= 50:
            risk = "MODERATE RISK - Proceed carefully, extra study needed"
        elif score >= 35:
            risk = "HIGH RISK - Consider deferring or expect significant challenge"
        else:
            risk = "NOT RECOMMENDED - Prerequisites or workload concerns"
        
        recommendations.append(risk)
        
        # ===== PREREQUISITE-SPECIFIC ADVICE =====
        if prereq_strength < 50:
            recommendations.append(
                "CRITICAL: Your prerequisite grades are too weak. "
                "Strongly consider retaking prerequisite units or defer this unit."
            )
        elif prereq_strength < 70:
            recommendations.append(
                "Prerequisite foundation is shaky. "
                "Dedicate 2-3 weeks before semester starts to review key concepts."
            )
        elif prereq_strength < 85:
            recommendations.append(
                "Prerequisites met but not mastered. "
                "Do a quick refresher in Week 1 to strengthen fundamentals."
            )
        
        # ===== DIFFICULTY-BASED ADVICE =====
        if sentiment['status'] == 'success':
            diff_score = sentiment.get('difficulty_score', 50)
            pain_points = sentiment.get('pain_points', [])
            
            if diff_score > 75:
                recommendations.append(
                    f"{unit_code} is rated VERY DIFFICULT by the community. "
                    f"Expect to spend 12-15 hours/week on this unit."
                )
                if pain_points:
                    top_issue = pain_points[0]['category']
                    recommendations.append(
                        f"Students commonly struggle with {top_issue}. "
                        f"Find resources on this topic BEFORE Week 3."
                    )
            elif diff_score > 60:
                recommendations.append(
                    f"Moderately challenging unit. Budget 10-12 hours/week."
                )
        
        # ===== WORKLOAD-SPECIFIC ADVICE =====
        total_assignments = workload['total_assignments']
        total_tests = workload['total_tests']
        is_adding = workload.get('is_adding_new', False)
        
        if is_adding:
            # Show impact of adding this unit
            new_adds = workload['new_unit_adds']
            if new_adds['assignments'] >= 4:
                recommendations.append(
                    f"Adding {unit_code} will add {new_adds['assignments']} assignments "
                    f"and {new_adds['tests']} tests to your workload."
                )
        
        if total_assignments > 16:
            recommendations.append(
                f"WORKLOAD WARNING: {total_assignments} assignments this semester is EXTREME. "
                f"Drop 1 unit or expect burnout."
            )
        elif total_assignments > 12:
            recommendations.append(
                f"Heavy semester: {total_assignments} assignments. "
                f"Start assignments early and use a planner."
            )
        
        if total_tests > 6:
            recommendations.append(
                f"{total_tests} tests/quizzes is demanding. "
                f"Create a study schedule to avoid cramming."
            )
        
        # ===== STRATEGIC ADVICE =====
        if score < 65 and workload['total_units'] >= 4:
            recommendations.append(
                "STRATEGY: Consider taking only 3 units this semester instead of 4 "
                "to reduce pressure and improve performance."
            )
        
        return recommendations
 

 #--------------------------resources_rec.py--------------------------
 import json
from pathlib import Path
from collections import Counter, defaultdict

class SimpleResourceRecommender:
    """
    Basic recommender that extracts and ranks commonly mentioned
    learning resources (websites, tools, books) from forum posts.
    """
    
    def __init__(self, resources_dir="forum_data"):
        self.resources_dir = Path(resources_dir)

    def load_resources(self, unit_code):
        """
        Load all saved discussion posts for a specific unit.

        @param unit_code (str): The unit code 

        @returns
            list[dict]: A list of posts, where each post is expected to have
            keys like "title" and "content". Returns an empty list if the
            resource file does not exist.
        """
        path = self.resources_dir / f"{unit_code}_resources.json"
        if not path.exists():
            return []
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)

    def extract_links(self, content):
        """        
        Identify all URLs or website links mentioned in a post.

        @param content (str): The text content of a post.

        @returns list[str]: A list of detected URL"""
        words = content.split()
        return [w for w in words if w.startswith("http://") or w.startswith("https://") or "www." in w]

    def detect_common_sources(self, content):
        """      
        Detect mentions of popular learning platforms or resource keywords.

        @param content (str): The text content of a post.

        @returns list[str]: A list of recognized resource keywords found in the text.
        """
        content_lower = content.lower()
        tags = []
        keywords = [
            "kaggle", "visualgo", "geeksforgeeks", "leetcode", "freecodecamp",
            "youtube", "coursera", "udemy", "book", "tutorial"
        ]
        for k in keywords:
            if k in content_lower:
                tags.append(k)
        return tags

    def recommend(self, unit_code, top_n=5):
        """
        Provide a ranked summary of the most mentioned learning resources
        based on community posts for a given unit.

        @param 
            unit_code (str): The unit code (e.g., "FIT1058").
            top_n (int, optional): The number of top resources to display. Defaults to 5.

        @returns
            str: A formatted text summary showing the top resources and
            where they were mentioned.
        """
        posts = self.load_resources(unit_code)
        if not posts:
            return f"No community resources found for {unit_code}."

        # Track mentions
        counter = Counter()
        resources = defaultdict(list)

        for post in posts:
            links = self.extract_links(post["content"])
            tags = self.detect_common_sources(post["content"])
            all_refs = links + tags

            for ref in all_refs:
                counter[ref] += 1
                resources[ref].append(post["title"])

        if not counter:
            return f"No links or known resources detected for {unit_code}."

        # Get top ones
        top = counter.most_common(top_n)
        result = f"Top Learning Resources for {unit_code}:\n\n"
        for i, (res, count) in enumerate(top, 1):
            result += f"{i}. {res} ‚Äî mentioned {count} times\n"
            examples = ", ".join(resources[res][:2])
            if examples:
                result += f"   Seen in: {examples}\n"
        return result

#---------------------------scrape.py--------------------------
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup 
import time

# --- Setup Chrome options ---
chrome_options = Options()
chrome_options.add_argument("--headless")  
chrome_options.add_argument("--disable-gpu")
chrome_options.add_argument("--no-sandbox")

# --- Path to your chromedriver ---
service = Service("/home/wanyi/Downloads/chromedriver-linux64/chromedriver")
driver = webdriver.Chrome(service=service, options=chrome_options)

# --- Load the page ---
def get_info(year, unit_code):
    """
    Load unit information from the Monash Handbook based on intake year and unit code
    It retrieves the unit name, semester availability, and assessment breakdown

    @param year: The intake year to search for
    @param unit_code: The unit code to search for

    @return: unit_name, semester_str, assign, test, final
             (each can replace the user database directly after changes made)
    """
    url = f"https://handbook.monash.edu/{year}/units/{unit_code}"
    driver.get(url)
    time.sleep(3)

    html = driver.page_source
    soup = BeautifulSoup(html, "html.parser")

    unit_name = extract_unit_name(soup)
    if not unit_name:
        return None, None, None, None, None

    semesters_str = extract_semesters(soup)
    expand_assessment_sections(driver)
    assign, test, final = extract_assessments(driver)

    return unit_name, semesters_str, assign, test, final


# -------------------- Helper Functions --------------------

def extract_unit_name(soup):
    """
    Extract the unit name from the Monash Handbook page
    @param soup: BeautifulSoup object of the page
    @return: unit name as a string, or None if not found
    """
    h2_tag = soup.find("h2", {"data-testid": "ai-header"})
    if not h2_tag:
        return None

    text = h2_tag.get_text(strip=True)
    return text.split("-", 1)[1].strip() if "-" in text else text.strip()


def extract_semesters(soup):
    """
    Extract which semesters the unit is available in Malaysia campus
    @param soup: BeautifulSoup object of the page
    @return: A string of semester numbers separated by semicolons (e.g., "1;2")
    """
    semester_headers = soup.find_all(
        "h4",
        class_="css-3d3idg-AccordionRowComponent--SDefaultHeading evoq1ba0"
    )
    semesters_set = set()
    for h in semester_headers:
        text = h.get_text(strip=True).upper()
        if "-MALAYSIA-" in text:
            if "S1" in text:
                semesters_set.add("1")
            if "S2" in text:
                semesters_set.add("2")
    return ";".join(sorted(semesters_set, key=int)) if semesters_set else "NONE"


def expand_assessment_sections(driver):
    """
    Expand all assessment accordion sections on the page to make them visible for scraping
    @param driver: Selenium WebDriver instance
    """
    try:
        WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "div[id^='Assessment-']"))
        )
        accordion_buttons = driver.find_elements(By.CSS_SELECTOR, "div[id^='Assessment-'] button")

        for button in accordion_buttons:
            try:
                driver.execute_script("arguments[0].scrollIntoView(true);", button)
                time.sleep(0.3)
                if button.get_attribute("aria-expanded") != "true":
                    driver.execute_script("arguments[0].click();", button)
                    time.sleep(0.5)
            except:
                continue
        time.sleep(1)
    except:
        pass


def extract_assessments(driver):
    """
    Extract assessment components (assignment, test, final exam) and their weightings
    @param driver: Selenium WebDriver instance
    @return: Tuple of (assign, test, final) strings
    """
    html = driver.page_source
    soup = BeautifulSoup(html, "html.parser")

    assign_list, test_list, final_list = [], [], []

    assessment_section = soup.find("div", id=lambda x: x and x.startswith("Assessment-"))
    if assessment_section:
        sections = assessment_section.find_all(
            "h4", class_="css-3d3idg-AccordionRowComponent--SDefaultHeading"
        )
        for section in sections:
            section_title = section.get_text(strip=True).lower()
            accordion_row = section.find_parent(
                "div", class_=lambda x: x and "SAccordionItemHeader" in str(x)
            )

            if accordion_row:
                content_div = accordion_row.find_next_sibling()
                if content_div:
                    value_divs = content_div.find_all(
                        "div", class_=lambda x: x and "CardBody" in str(x)
                    )
                    for vdiv in value_divs:
                        text = vdiv.get_text(strip=True)
                        if "Value %" in text or "Value%" in text:
                            value = (
                                text.replace("Value %", "")
                                .replace("Value%", "")
                                .replace(":", "")
                                .strip()
                            )
                            if "quiz" in section_title or "test" in section_title:
                                test_list.append(value)
                            elif "examination" in section_title or "final" in section_title:
                                final_list.append(value)
                            else:
                                assign_list.append(value)
                            break

    assign = ";".join(assign_list) if assign_list else "NONE"
    test = ";".join(test_list) if test_list else "NONE"
    final = ";".join(final_list) if final_list else "NONE"
    return assign, test, final


#---------------------------sentiment_analyzer.py------------------------
import json
from pathlib import Path
from nltk.sentiment import SentimentIntensityAnalyzer
import nltk
from collections import Counter, defaultdict
import re

class SentimentDifficultyAnalyzer:
    """
    Analyze sentiment and difficulty with context-aware keyword detection
    and specific pain point extraction from general enquiries.
    """

    DIFFICULTY_KEYWORDS = {
        'very_hard': ['nightmare', 'impossible', 'brutal', 'hell', 'overwhelming', 'killer', 'insane'],
        'hard': ['hard', 'difficult', 'tough', 'challenging', 'struggle', 'struggling', 'confusing', 'complex'],
        'moderate': ['okay', 'manageable', 'average', 'decent', 'fair', 'alright'],
        'easy': ['easy', 'simple', 'straightforward', 'relaxed', 'chill', 'breeze'],
        'very_easy': ['wam booster', 'free marks', 'joke', 'too easy', 'no effort', 'piece of cake']
    }

    PAIN_POINT_PATTERNS = {
        'assignments': r'(assignment|assign|task|project)\s*(\d+|two|three|one)?',
        'exams': r'(final|exam|test|quiz|midsem|mid-sem|examination|mid sem)',
        'workload': r'(workload|time consuming|too much work|overload|hours|deadline)',
        'lectures': r'(lecture|lec|recording|slides?)\s*(unclear|confusing|bad|poor)?',
        'concepts': r'(recursion|algorithm|oop|pointer|thread|graph|tree|sorting|data structure)',
        'teaching': r'(lecturer|tutor|teacher|teaching|instructor)\s*(bad|poor|unclear|confusing)?',
        'understanding': r'(don\'t understand|hard to understand|confusing|unclear|lost)',
        'prerequisites': r'(prereq|prerequisite|assumed knowledge|need background|should have done)'
    }

    NEGATIONS = [
        'not', 'no', 'never', 'neither', 'nobody', 'nothing', 'nowhere',
        "n't", "isn't", "aren't", "wasn't", "weren't", "hasn't", "haven't",
        "hadn't", "won't", "wouldn't", "don't", "doesn't", "didn't", "can't",
        "couldn't", "shouldn't", "mightn't", "mustn't"
    ]

    def __init__(self):
        try:
            nltk.download('vader_lexicon', quiet=True)
            self.sid = SentimentIntensityAnalyzer()
        except:
            print("Warning: VADER lexicon download failed")
            self.sid = None

    def get_unit_comments(self, unit_code):
        """
        Load all comments and replies from forum_data/{unit_code}_general.json

        @param unit_code 

        @returns dictioanry of user comments
        """
        path = Path(f"forum_data/{unit_code}_general.json")
        if not path.is_file():
            return []
        
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)

        comments = []
        for post in data:
            comments.append({'text': post['content'], 'type': 'post'})
            for reply in post.get('replies', []):
                comments.append({'text': reply['content'], 'type': 'reply'})
        return comments

    def detect_keywords_with_context(self, text):
        """
        @param text of what user have written

        Detect difficulty keywords but check for negations
        not hard -> negated: True
        hard -> negated: False
        @return keyword, level of difficulty and negated (True/False) in a dictionary 
        """
        text_lower = text.lower()
        found_keywords = []
        
        for level, keywords in self.DIFFICULTY_KEYWORDS.items():
            for keyword in keywords:
                if keyword in text_lower:
                    keyword_index = text_lower.find(keyword)
                    before_text = text_lower[:keyword_index].split()[-3:]
                    is_negated = any(neg in before_text for neg in self.NEGATIONS)
                    found_keywords.append({'word': keyword, 'level': level, 'negated': is_negated})
        return found_keywords

    def extract_pain_points(self, text):
        """
        @param text of what user have written

        Find specific things students complain about

        @returns the pain points
        """
        text_lower = text.lower()
        found_pain_points = []
        for category, pattern in self.PAIN_POINT_PATTERNS.items():
            matches = re.findall(pattern, text_lower, re.IGNORECASE)
            if matches:
                match_text = matches[0] if isinstance(matches[0], str) else ' '.join(str(m) for m in matches[0] if m)
                found_pain_points.append({'category': category, 'match': match_text})
        return found_pain_points

    def interpret_with_context(self, sentiment_score, keywords_with_context):
        """
        @param sentiment_score the base score
        @param keyword_with_context keywords mention in text
        Interpretation considering negations

        Used the compound sentiment score but merge with difficulty context

        @returns meaningful sentiment if keyword detected else the base sentiment
        """
        compound = sentiment_score["compound"]
        if compound >= 0.05:
            base_sentiment = "positive"
        elif compound <= -0.05:
            base_sentiment = "negative"
        else:
            base_sentiment = "neutral"

        difficulty_signals = []
        for kw in keywords_with_context:
            level = kw['level']
            negated = kw['negated']
            if negated:
                if level in ['very_hard', 'hard']:
                    difficulty_signals.append('easy')
                elif level in ['easy', 'very_easy']:
                    difficulty_signals.append('hard')
            else:
                if level in ['very_hard', 'hard']:
                    difficulty_signals.append('hard')
                elif level in ['easy', 'very_easy']:
                    difficulty_signals.append('easy')

        if 'hard' in difficulty_signals:
            if base_sentiment == "negative":
                return "perceived as hard"
            elif base_sentiment == "positive":
                return "challenging but valuable"
            else:
                return "likely hard but neutral tone"
        elif 'easy' in difficulty_signals:
            if base_sentiment == "positive":
                return "perceived as easy"
            elif base_sentiment == "negative":
                return "easy but disappointing"
            else:
                return "likely easy"
        else:
            return base_sentiment

    def extract_reasoning(self, text, opinion_type):
        """
        @param text entered by user
        @param opinion_type easy/hard

        Extract why someone thinks it's easy/hard
        Uses pattern matching
        @return the reason why people thinks its hard/easy
        """
        text_lower = text.lower()
        if opinion_type == 'easy':
            patterns = [
                r'(easy|simple|straightforward).{0,80}(because|since|as|due to)\s*(.{10,80})',
                r'(prior knowledge|experience|already know).{0,50}(help|made it|so it was)',
                r'(manageable|not too hard).{0,80}',
            ]
        elif opinion_type == 'hard':
            patterns = [
                r'(hard|difficult|tough|struggle).{0,80}(because|since|due to|as)\s*(.{10,80})',
                r'(workload|assignment|exam|test).{0,30}(too much|overwhelming|brutal|killer|insane)',
                r'(confusing|unclear).{0,50}',
            ]
        else:
            return None

        for pattern in patterns:
            match = re.search(pattern, text_lower, re.IGNORECASE)
            if match:
                return match.group(0).strip('.,;!? ')[:120]
        return None

    def analyze_unit(self, unit_code):
        """
        @param unit_code that user wants to analyse

        Full analysis with reasoning extraction

        @return JSON structure output
        """
        comments = self.get_unit_comments(unit_code)
        if not comments:
            return {"unit": unit_code, "status": "no_data", "message": "No comments found"}

        results = []
        all_pain_points = defaultdict(list)
        difficulty_distribution = Counter()
        easy_reasons, hard_reasons = [], []

        for comment in comments:
            text = comment['text']
            sentiment = self.sid.polarity_scores(text) if self.sid else {"compound": 0, "pos": 0, "neg": 0, "neu": 1}
            keywords = self.detect_keywords_with_context(text)
            meaning = self.interpret_with_context(sentiment, keywords)
            pain_points = self.extract_pain_points(text)

            if 'easy' in meaning:
                reason = self.extract_reasoning(text, 'easy')
                if reason:
                    easy_reasons.append({'text': text, 'reason': reason})
            elif 'hard' in meaning:
                reason = self.extract_reasoning(text, 'hard')
                if reason:
                    hard_reasons.append({'text': text, 'reason': reason})

            results.append({
                "text": text,
                "compound": sentiment["compound"],
                "keywords": [k['word'] for k in keywords],
                "negations": [k['word'] for k in keywords if k['negated']],
                "meaning": meaning,
                "pain_points": [p['category'] for p in pain_points]
            })

            for pain in pain_points:
                all_pain_points[pain['category']].append(text[:150])
            difficulty_distribution[meaning] += 1

        avg_sentiment = sum(r["compound"] for r in results) / len(results)
        dominant_opinion = difficulty_distribution.most_common(1)[0][0]

        top_pain_points = [
            {"category": category, "count": len(mentions), "example": mentions[0]}
            for category, mentions in sorted(all_pain_points.items(), key=lambda x: len(x[1]), reverse=True)[:3]
        ]

        hard_count = sum(1 for r in results if 'hard' in r['meaning'])
        easy_count = sum(1 for r in results if 'easy' in r['meaning'])
        difficulty_score = int(((hard_count - easy_count) / len(results) + 1) * 50)
        negative_count = sum(1 for r in results if r['compound'] < -0.2)
        struggling_percent = int((negative_count / len(results)) * 100)

        return {
            "unit": unit_code,
            "status": "success",
            "average_sentiment": round(avg_sentiment, 3),
            "dominant_opinion": dominant_opinion,
            "difficulty_score": difficulty_score,
            "struggling_percent": f"{struggling_percent}%",
            "total_comments": len(results),
            "pain_points": top_pain_points,
            "difficulty_distribution": dict(difficulty_distribution),
            "easy_reasons": easy_reasons,
            "hard_reasons": hard_reasons,
            "details": results
        }

#-------------------------------update_results.py----------------------------
import os, json
import utilities as u
from enum import Enum

class ResultMenuEnum(Enum):
    UPDATE_RESULT_M = 0
    DISPLAY_RESULT = 1
    QUIT = 2

def print_result_menu():
    """
    Print out the option to choose
    """
    print("")
    print("====Update Result Menu====")
    print("1. Update Result")
    print("2. View Results")
    print("3. Quit")


def user_option():
    """
    Return user option index to match the ResultMenuEnum
    """
    while True:
        try:
            print_result_menu()
            user_option = u.read_integer("Enter an option: ", 1, len(ResultMenuEnum))
            return (user_option - 1)
        except ValueError:
            print("Please enter an valid option\n")

class UpdateResult():
    def __init__(self):
        """
        access username and file_path anywhere in the list
        json_list contain all the filename info of that user
        read_username_bool make sure username is entered once only 
        """
        self.username = ""
        self.file_path = ""
        self.json_list = []
        self.read_username_bool = False

    def read_username(self):
        """
        read username and turn the read_username_bool to True 
        thismake sure username is read once and it will remember for all function below
        """
        self.username = input("Enter your username: ")
        self.read_username_bool = True

    def read_json(self):
        """
        if user_name havent be recorded, read username here

        read the json file by accesing the folder path (containing username)
        a list of json_file name of that user is recorded
        """
        if (self.read_username_bool == False):
            self.read_username()
        self.json_list = []
        self.file_path = f"user_info/{self.username}" 
        #listdir list all file inside folder
        for file in os.listdir(self.file_path):
            if file.endswith(".json") and file.startswith("Y"):
                self.json_list.append(file)


    def check_valid_input(self, prompt):
        """
        let user enter the grade of that unit

        @return user correct grade (with correct format) is return
        """
        valid_input_list = ["HD", "D", "C", "P", "F"]
        updated_grade = input(prompt)
        while updated_grade not in valid_input_list:
            print("Invalid grade")
            updated_grade = input(prompt)
        return updated_grade
    
    def update_grade(self, unit_info_):
        """
        for grade that is mark planned- user can enter new grade
        for grade that previously had recorded - user can enter new grade (with their previous grade showing at the side)
        """
        for unit_code, grade in unit_info_.items():
            if (grade == "planned"):
                updated_grade = self.check_valid_input(f"{unit_code}: ")
                unit_info_[unit_code] = updated_grade
        
    def show_grade(self):
        """
        show result option
        Show user result for all sem and year that had been recorded
        """
        if not self.read_username_bool:
            self.read_username()
        self.read_json()
        for file in self.json_list:
            full_path = os.path.join(self.file_path, file)
            name_only = file.split("_")[0]
            print(f"Result For {name_only}")

            with open(full_path, "r") as f:
                unit_info = json.load(f)

            for unit_code, grade in unit_info.items():
                print(f"{unit_code}: {grade}")
            print("")

    def access_unplanned_info(self):
        """
        Enter username (if haven't), check folder.
        Save in a list, check and call update grade function.
        Only process files that start with 'Y'.
        """
        self.read_json()
        
        for file in self.json_list:
            if not file.startswith("Y"):
                continue  # skip files that don't start with 'Y'
            
            full_path = os.path.join(self.file_path, file)
            name_only = file.split("_")[0]
            print(f"Result For {name_only}")

            # Read file into local variable
            with open(full_path, "r") as f:
                unit_info_ = json.load(f)

            # Update grades
            self.update_grade(unit_info_)

            # Save back to the same file
            with open(full_path, "w") as f:
                json.dump(unit_info_, f, indent=4)

            print("Saved updates for", file)
            print("")

        
class ResultMenu():
    def __init__(self):
        self.update_result = UpdateResult()
    
    def run(self):
        """
        1- Update result and save the result back to the json file
        2- Display all the previous year and sem result
        3- Quit this result menu
        """
        while True:
            choice_index = user_option()
            choice = ResultMenuEnum(choice_index)

            match choice:
                case ResultMenuEnum.UPDATE_RESULT_M:
                    self.update_result.access_unplanned_info()
                case ResultMenuEnum.DISPLAY_RESULT:
                    print("")
                    self.update_result.show_grade()
                case ResultMenuEnum.QUIT:
                    break

    
#--------------------------------update_units.py-----------------------------
from scrape import get_info
import io
import json
import matplotlib.pyplot as plt
from pathlib import Path
from matplotlib.patches import Rectangle

class UpdateMenu():
    def __init__(self, user_info, update_result, pass_info, core_planner):
        """
        Class to handle course and unit information for user 

        @attribute user_info basic information about user such as useranme, enrolled_units
        @attribute update_result update result information to know user's prerequisite info
        @attribute pass_info information about passed units or completed prerequisite
        @attribute core_planner info about core planner
        """
        self.user_info = user_info
        self.update_result = update_result
        self.pass_info = pass_info
        self.core_planner = core_planner


    def core_dict_change_info(self):
        """
        Update the data if user feel like their info is incorrect, user can serach for that year and the requirements

        system will load user data and update the info back into the json file to accessed later at search units
        """
        # Load user paths
        username = input("Enter your username: ").strip()
        file_path_core = Path(f"user_info/{username}/core_units.json")
        file_path_elective = Path(f"user_info/{username}/elective_units.json")

        # Load core data
        if not file_path_core.is_file():
            print("core_units.json not found. Please generate it first.")
            return
        with open(file_path_core, "r", encoding="utf-8") as f:
            core_units_data = json.load(f)

        # Load elective data
        if not file_path_elective.is_file():
            print("elective_units.json not found. Please generate it first.")
            return
        with open(file_path_elective, "r", encoding="utf-8") as f:
            elective_units_data = json.load(f)

        # Ask for unit to update
        year = input("Enter your intake year: ").strip()
        user_unit_code = input("Enter unit code to update: ").strip().upper()
        unit_name, semesters_str, assign, test, final = get_info(year, user_unit_code)

        if unit_name is None:
            print(f"No unit found for {user_unit_code} in year {year}. Update canceled.")
            return

        # Update flag
        updated = False
        updated_info = None

        # Try updating in core_units.json
        if user_unit_code in core_units_data:
            core_units_data[user_unit_code].update({
                "unit_name": unit_name,
                "sem_available": semesters_str,
                "assign": assign,
                "test": test,
                "final": final
            })
            updated = True
            updated_info = core_units_data[user_unit_code]

        # Try updating in elective_units.json
        elif user_unit_code in elective_units_data:
            elective_units_data[user_unit_code].update({
                "unit_name": unit_name,
                "sem_available": semesters_str,
                "assign": assign,
                "test": test,
                "final": final
            })
            updated = True
            updated_info = elective_units_data[user_unit_code]

        if not updated:
            print(f"{user_unit_code} not found in either core or elective files.")
            return

        # Save changes
        with open(file_path_core, "w", encoding="utf-8") as f:
            json.dump(core_units_data, f, indent=4)
        with open(file_path_elective, "w", encoding="utf-8") as f:
            json.dump(elective_units_data, f, indent=4)

        # Display updated info
        print("\nUpdated Unit Information:")
        print(f"======= Unit Details - {user_unit_code} =======")
        print(f"[ {user_unit_code} ]: {updated_info['unit_name']}")
        print(f"Available Semester: {', '.join(self.core_planner.sem_extraction(updated_info['sem_available']))}")
        print(f"\nChanges saved successfully to {username}'s files.")


class UnitMenu:
    def __init__(self, update_menu):
        self.update_menu = update_menu

    def run(self):
        # Access core planner through update_menu
        self.update_menu.core_dict_change_info()


class ViewMenu:
    def __init__(self):
        pass

    def read_user_semester_plan(self, username, year, sem):
        """
        Read a specific semester's planning JSON for a user
        Returns dict of {unit_code: status} or None if file doesn't exist
        """
        user_folder = Path("user_info") / username
        filename = f"Y{year}S{sem}_units.json"
        file_path = user_folder / filename
        
        if file_path.is_file():
            with open(file_path, 'r') as f:
                return json.load(f)
        return None

    def get_all_user_plans(self, username):
        """
        Read all semester plans for a user (Y1S1 through Y3S2)
        Only includes semesters that have saved JSON files
        Returns dict: {"Y1S1": {unit: status}, "Y1S2": {...}, ...}
        """
        all_plans = {}
        
        # Check all possible semesters
        for year in range(1, 4):  # Years 1-3
            for sem in range(1, 3):  # Semesters 1-2
                semester_key = f"Y{year}S{sem}"
                plan = self.read_user_semester_plan(username, year, sem)
                if plan is not None:  # Only add if file exists
                    all_plans[semester_key] = plan
        
        return all_plans
    

    def load_unit_names(self, username):
        core_file = Path(f"user_info/{username}/core_units.json")
        elective_file = Path(f"user_info/{username}/elective_units.json")
        unit_names = {}
        
        if core_file.is_file():
            with open(core_file, 'r', encoding='utf-8') as f:
                core_units = json.load(f)
                for code, info in core_units.items():
                    unit_names[code] = info.get("unit_name", "")
        
        if elective_file.is_file():
            with open(elective_file, 'r', encoding='utf-8') as f:
                elective_units = json.load(f)
                for code, info in elective_units.items():
                    unit_names[code] = info.get("unit_name", "")
        
        return unit_names

    def visualize_user_course(self, username):
        """
        Visualize all saved semesters for a specific user
        Shows passed (green) vs planned (gray) units
        Displays unit code and unit name
        """
        # Get all user's plans
        user_plans = self.get_all_user_plans(username)
        if not user_plans:
            print(f"No saved plans found for {username}")
            return
        
        # Load unit names
        unit_names = self.load_unit_names(username)
        
        fig, ax = plt.subplots(figsize=(12, len(user_plans) * 1.5))
        semesters = sorted(user_plans.keys())  # Y1S1, Y1S2, etc.
        y_pos = len(semesters) - 1
        
        for semester in semesters:
            # Semester label
            ax.text(-0.5, y_pos, semester, fontsize=12, fontweight='bold', 
                    ha='right', va='center')
            
            # Get all units for this semester from JSON
            semester_plan = user_plans[semester]
            units = list(semester_plan.keys())
            
            # Draw unit boxes
            for i, unit in enumerate(units):
                # Check status
                is_planned = semester_plan[unit] != "planned"
                color = 'lightgreen' if is_planned else 'lightgray'
                
                # Ultra long box dimensions
                box_width = 6.0
                box_height = 0.8
                x_offset = i * (box_width + 0.6)  # extra spacing to match
                
                # Draw box
                rect = Rectangle((x_offset, y_pos - box_height / 2), box_width, box_height, 
                                facecolor=color, edgecolor='black', linewidth=1)
                ax.add_patch(rect)
                
                # Unit code + name
                name_text = unit_names.get(unit, "")
                words = name_text.split()
                if len(words) > 3:
                    # Break into two lines after the third word
                    name_text = ' '.join(words[:3]) + '\n' + ' '.join(words[3:])
                display_text = f"{unit}\n{name_text}"

                ax.text(x_offset + box_width / 2, y_pos, display_text, fontsize=8, 
                        ha='center', va='center', fontweight='bold')


            
            y_pos -= 1
        
        # Dynamic x-axis limit based on max units in any semester
        max_units = max(len(plan) for plan in user_plans.values())
        ax.set_xlim(-1, max_units * (box_width + 0.6))
        ax.set_ylim(-1, len(semesters))
        ax.axis('off')
        
        plt.title(f'Course Plan for {username}', fontsize=14, fontweight='bold')
        plt.tight_layout()
        
        # Save to user_info folder
        user_folder = Path("user_info") / username
        output_path = user_folder / f'{username}_course_structure.png'
        plt.savefig(output_path, dpi=150, bbox_inches='tight')
        print(f"Course structure saved to {output_path}")
        plt.close()
    
    def generate_course_png(self, username):
        """
        Generate the course structure PNG in-memory for a given user.
        Returns BytesIO or None if no plans exist.
        """
        user_plans = self.get_all_user_plans(username)
        if not user_plans:
            return None  # No plans found

        unit_names = self.load_unit_names(username)

        fig, ax = plt.subplots(figsize=(12, len(user_plans) * 1.5))
        semesters = sorted(user_plans.keys())
        y_pos = len(semesters) - 1

        for semester in semesters:
            ax.text(-0.5, y_pos, semester, fontsize=12, fontweight='bold', ha='right', va='center')
            semester_plan = user_plans[semester]
            units = list(semester_plan.keys())
            for i, unit in enumerate(units):
                is_planned = semester_plan[unit] != "planned"
                color = 'lightgreen' if is_planned else 'lightgray'
                box_width, box_height = 6.0, 0.8
                x_offset = i * (box_width + 0.6)
                rect = Rectangle((x_offset, y_pos - box_height / 2), box_width, box_height,
                                 facecolor=color, edgecolor='black', linewidth=1)
                ax.add_patch(rect)
                name_text = unit_names.get(unit, "")
                words = name_text.split()
                if len(words) > 3:
                    name_text = ' '.join(words[:3]) + '\n' + ' '.join(words[3:])
                display_text = f"{unit}\n{name_text}"
                ax.text(x_offset + box_width / 2, y_pos, display_text, fontsize=8, ha='center', va='center', fontweight='bold')
            y_pos -= 1

        max_units = max(len(plan) for plan in user_plans.values())
        ax.set_xlim(-1, max_units * (box_width + 0.6))
        ax.set_ylim(-1, len(semesters))
        ax.axis('off')
        plt.title(f'Course Plan for {username}', fontsize=14, fontweight='bold')
        plt.tight_layout()

        # Save to BytesIO
        img_bytes = io.BytesIO()
        plt.savefig(img_bytes, format='png', dpi=150, bbox_inches='tight')
        plt.close()
        img_bytes.seek(0)
        return img_bytes

    def run(self):
        username = input("Enter username to view planner: ")
        
        # Check if user folder exists
        user_folder = Path("user_info") / username
        if not user_folder.exists():
            print(f"No planning data found for user: {username}")
        else:
            print(f"Viewing current planner for {username}...")
            self.visualize_user_course(username)

#-------------------utilities.py----------------------------------------
def read_integer(prompt, start, end):
    while True:
        try:
            user_input = int(input(prompt))
            if (start <= user_input <= end):
                return user_input
            else:
                print("Invalid input. Please try again")
        except ValueError:
            print("Invalid input. Please try again")

# utilities.py
def initialize_user(data):
    """
    Helper function to initialize user info, core planner, and elective planner
    """
    # Import here to avoid circular import
    from core_planner import PlannerForCore, UserInfo
    from elective_planner import PlannerForElective
    from pass_info import PreviousDetails
    from update_result import UpdateResult
    
    username = data.get('username')
    intake = data.get('intake')
    stream = data.get('stream')
    year = data.get('year')
    sem = data.get('semester')

    # Initialize UserInfo
    user_info = UserInfo()
    user_info.user_basic_info_web(username, stream, year, sem, intake)

    print(f"Received user info: username='{user_info.username}', intake={user_info.intake}, "
          f"stream={user_info.stream}, year={user_info.year}, sem={user_info.sem}")

    # Initialize PreviousDetails (pass_info)
    update_result = UpdateResult()
    pass_info = PreviousDetails(user_info, update_result)
    pass_info.check_previous_record()

    # Initialize Core Planner
    core_planner = PlannerForCore(user_info, pass_info)
    core_planner.read_core_unit()
    core_planner.save_user_core()

    # Set current semester
    if user_info.intake == 2 and user_info.sem == 1:
        core_planner.current_sem = 2
    elif user_info.intake == 2 and user_info.sem == 2:
        core_planner.current_sem = 1
    elif user_info.intake == 1 and user_info.sem == 1:
        core_planner.current_sem = 1
    elif user_info.intake == 1 and user_info.sem == 2:
        core_planner.current_sem = 2

    # Initialize Elective Planner
    elective_planner = PlannerForElective(user_info, core_planner)
    elective_planner.read_elective()
    elective_planner.save_user_elective()

    return user_info, core_planner, elective_planner